---
title: "Untitled"
author: "Justin"
date: "2023-08-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```






```{r}


df.sum <- df.qual.exp %>% #filter(`Grant Number` != "H80CS00225") %>% 
  ungroup() %>% 
  #rename(`Grant Number` = Grant.Number, `Surplus as a pct of before dep expenses` = Surplus.as.a.pct.of.after.dep.expenses) %>% 
  #filter(MarketShare < 0.4) %>%  #median(MarketShare, na.rm = TRUE) - 0.25
  #inner_join(df.qual.exp %>% filter(Year == 2015 & Total < 15000) %>% select(`Grant Number`), by = c("Grant Number")) %>%  #& Zips < 1.75 or 7.75
  select(`Grant Number`, Year, ID, Att, Sites, Qcomp, Altmans.Z, Pct.HTN.CNTRL, Total, IMM2yo:DepScrn) %>%
  # inner_join(df.qual.exp %>% filter(Year == 2015) %>%
  #                                           mutate(ZipFilter = ifelse(Total < 12000, 1,
  #                                                              ifelse(Total > 12000, 2, NA))) %>% select(`Grant Number`, ZipFilter), by = c("Grant Number")) %>%
  inner_join(df.qual.exp %>% filter(Year == 2016) %>% #mutate(ZipFilter = ifelse(`Surplus as a pct of before dep expenses` < 2, 1, 2)) %>% 
               select(`Grant Number`, ZipFilter, Pct.NHA:Pct.Children, MCD, COM, MCR), by = c("Grant Number")) %>% 
  select(`Grant Number`, Year, ZipFilter, ID, Att, Sites, Qcomp, Altmans.Z, Pct.HTN.CNTRL, Pct.NHA:Pct.Children, MCD, COM, MCR, Total, IMM2yo:DepScrn) %>% 
  mutate(Tx = ifelse(Year >= Att & Att > 0, 1, 0)) %>% 
  unique() %>% 
  mutate(NewQuality = (CRC + ChildBMI + AdultBMI + Tobac + DepScrn) / 5)

#library(did2s)

did2s(
      data = df.sum %>% inner_join(df.qual.exp %>% filter(MarketShare > 1) %>% select(`Grant Number`) %>% unique(), by = c("Grant Number")), 
      yname = "Qcomp", 
      treatment = "Tx",
        first_stage = ~ 0 | ID + Year + Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + Pct.Children + MCD + MCR + COM, 
        second_stage = ~ i(Tx, ref = FALSE),
        cluster_var = "ID",
      verbose = FALSE
    )


#select(ID, Year, ZipFilter, ID, Att, Sites, Qcomp, Altmans.Z) %>% left_join(df.qual.exp %>% select(ID, Year, Pct.NHA:Pct.Children, MCD, COM, MCR), by = c("ID","Year"))
out.qual <- event_study(data = df.qual.exp %>% filter(ZipFilter == 1), 
  yname = "Altmans.Z", idname = "ID", tname = "Year", gname = "Att", estimator = "all", xformla = ~Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + Pct.Children + MCD + MCR + COM)

out.qual %>% 
  filter(estimator %notin% c("Borusyak, Jaravel, Spiess (2021)")) %>% 
filter(abs(term) <= 3) %>% 
  ggplot(aes(x = term, y = estimate, color = estimator)) + geom_point(position = position_dodge(0.9)) + geom_errorbar(aes(ymin=estimate-1.96*std.error, ymax=estimate+1.96*std.error), width=.2, position = position_dodge(0.9))  + 
  #facet_wrap(~V1, scales = "free_y", ncol = 3) + 
  theme_tufte_revised() + geom_vline(xintercept=-0.5, color="red", linetype="dashed", alpha=.5) + 
  geom_hline(yintercept=0, color="black", linetype="dashed", alpha=.5) 

```





## Variations


```{r}


did2s(
      data = df.sum %>% left_join(df.spill2 %>% 
  group_by(`Grant Number`, Year) %>% 
  summarise(num = sum((Dist + 1) * Sites), 
         denom = sum(Sites), 
         avgdist = num / denom) %>% 
  filter(Year %in% c(2015, 2019)) %>% 
  pivot_wider(id_cols = `Grant Number`, names_from = Year, values_from = avgdist) %>% 
  mutate(ds = `2019` - `2015`) %>% 
    ungroup() %>% 
    mutate(filt = ifelse(ds > median(ds, na.rm = TRUE), 1, 0)), by = c("Grant Number")) %>% filter(ds < 1),#%>% filter(ZipFilter == 2), 
      yname = "NewQuality", 
      treatment = "Tx",
        first_stage = ~ 0 | ID + Year + Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + Pct.Children + MCD + MCR + COM, 
        second_stage = ~ i(Tx, ref = FALSE),
        cluster_var = "ID",
      verbose = FALSE
    )


did2s(
      data = df.sum %>% left_join(df.spill2 %>% 
  group_by(`Grant Number`, Year) %>% 
  summarise(num = sum((Dist + 1) * Sites), 
         denom = sum(Sites), 
         avgdist = num / denom) , by = c("Grant Number","Year")) ,#%>% filter(ZipFilter == 2), 
      yname = "NewQuality", 
      treatment = "Tx",
        first_stage = ~ 0 | ID + Year + Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + Pct.Children + MCD + MCR + COM, 
        second_stage = ~ i(Tx, ref = FALSE) + as.numeric(avgdist / 10) + I(Tx *as.numeric(avgdist / 10)),
        cluster_var = "ID",
      verbose = FALSE
    )




did2s(
      data = df.sum %>% left_join(df.z.dist %>% select(`Grant Number.y`, DistToClosestSite), by = c("Grant Number" = "Grant Number.y")) %>% filter(is.na(DistToClosestSite) | DistToClosestSite > 5),
      yname = "Qcomp", 
      treatment = "Tx",
        first_stage = ~ 0 | ID + Year + Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + Pct.Children + MCD + MCR + COM, 
        second_stage = ~ i(Tx, ref = FALSE) ,
        cluster_var = "ID",
      verbose = FALSE
    )


set.seed(345)
did2s(
      data = df.sum %>% left_join(df.z.dist %>% select(`Grant Number.y`, DistToClosestSite), by = c("Grant Number" = "Grant Number.y")) %>% 
        group_by(ID) %>% 
  mutate(DistToClosestSite = ifelse(is.na(DistToClosestSite), sample(size = 1, df.z.dist$DistToClosestSite, replace = T), DistToClosestSite)),
      yname = "NewQuality", 
      treatment = "Tx",
        first_stage = ~ 0 | ID + Year + Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + Pct.Children + MCD + MCR + COM, 
        second_stage = ~ i(Tx, ref = FALSE) + as.numeric(DistToClosestSite / 1) + I(Tx *as.numeric(DistToClosestSite / 1)),
        cluster_var = "ID",
      verbose = FALSE
    )



```




# Redo the analysis

## Balance between treated and controls
```{r}

dfc %>% 
  filter(Year == 2010) %>% 
  mutate(Treat = ifelse(Att > 0, "Treated", "Control")) %>% 
  select(Treat, Total, Pct.NHA:Pct.COM) %>% 
  filter(complete.cases(.)) %>% 
  tbl_summary(by = Treat, 
                statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  add_p()

```



## Overall Effects on Key Variables



## Broken down by components
```{r}

df.core <- dfc %>% 
  mutate(MCD = Total * Pct.MCD / 100, 
         None = Total * Pct.None / 100, 
         MCR = Total * Pct.MCR / 100, 
         COM = Total * Pct.COM / 100, 
         
         crc.rate = crc.rate * 100, 
         pap.rate = pap.rate * 100, 
         childbmi.rate = childbmi.rate * 100, 
         adultbmi.rate = adultbmi.rate * 100, 
         htn.rate = htn.rate * 100, 
         dm.rate = dm.rate * 100) %>% 
  select(`BHCMIS ID`, value, Tx, Year, Att, Att.random, year.rel, ID, STATE, 
         MCD:COM, 
         crc.rate, pap.rate, childbmi.rate, adultbmi.rate, htn.rate, dm.rate, 
         Liquidity:NetWorth, 
         Pct.NHA:Pct.COM) #%>%  mutate(Altman = ifelse(is.infinite(Altman), NA, Altman))#, #pap.rate:dm.total, Liquidity:Altman) 
  



did.core <- c(0, 0, 0, 0)

for (j in 10:23){
  
  df.temp <- df.core[,c(1:9, j)]
  colnames(df.temp)[10] <- "Outcome"
  outcomes <- did2s(
      data = df.temp %>% 
        inner_join(df.core[,c(4, 8, 24:ncol(df.core))] %>% filter(Year == 2010 ) #& ngla_net_gain_loss/ngla_revenue < 0.03)  ngla_net_gain_loss/Assets < 0.05
                   %>% select(ID, Pct.NHA:Pct.COM) %>% unique() , by = c("ID")) , 
      yname = "Outcome", 
      treatment = "Tx",
        first_stage = ~ 0 | ID + Year + Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + Pct.MCD + Pct.MCR + Pct.None, 
        second_stage = ~ i(Tx, ref = FALSE),
        cluster_var = "ID",
      verbose = FALSE
    )
  
  did.core <- rbind(did.core, outcomes$coeftable)
  
  
}


did.core <- did.core[-1,]
rownames(did.core) <- NULL

mean.nas<- function(x){ mean(x, na.rm = TRUE)}

options(scipen=999)

df.core %>% 
  mutate(Post = ifelse(year.rel >= 0, 1, 0), 
         Treated = ifelse(Att > 0, 1, 0)) %>% 
  group_by(Post, Treated) %>% 
  select(MCD:NetWorth) %>% 
  summarise_all(mean.nas) %>% 
  # summarise(Total = mean(Total, na.rm = TRUE), 
  #           Quality = mean(Qcomp, na.rm = TRUE), 
  #           Finances = mean(Altman, na.rm = TRUE)) %>% 
  pivot_longer(cols = MCD:NetWorth) %>% 
  mutate(value = round(value, 2)) %>% 
  #filter(name %in% c("Total", "Qcomp", "Altman")) %>% 
  pivot_wider(id_cols = name, names_from = c(Treated, Post), values_from = value) %>% 
  mutate(Unadjusted = (`1_1` - `1_0`) - (`0_1` - `0_0`)) %>% 
  cbind(did.core) %>% 
   select(name, `0_0`, `0_1`, `1_0`, `1_1`, Unadjusted, Estimate, `Std. Error`) %>% 
  mutate(Estimate = round(Estimate, 2), 
         `95% CI` = paste(round(Estimate - 1.96 * `Std. Error`, 2), ", ", round(Estimate + 1.96 * `Std. Error`, 2), sep = ""), 
         `% Change` = round(Estimate / `1_0` * 100, 1)) %>% 
  rename(Outcome = name) %>% 
  select(Outcome:Estimate, `95% CI`, `% Change`) %>% 
  kable("html", booktabs = T, col.names = c("Outcome","Pre","Post","Pre","Post","Unadjusted DID","Estimate","95% CI","% Change")) %>% 
  kable_styling(latex_options = c("striped")) %>%
  pack_rows(index = c("Total Patients by Insurnace" = 4, "Quality Measure Components" = 6, "Financial Components" = 4)) %>% 
  add_header_above(c(" " = 1, "Control" = 2, "Treated" = 2, " " = 1, "Staggered DID" = 3))

```


## Effects stratified by profitability


## Effects startified by clinic size


## Changes in geographic distribution of resources by Distance to competitive zip


## Rival selecting where to put new site





Splits
- Total at 10000 and at 25000
- ngla_net_gain_loss/ngla_revenue at 0.03 (Profitable grow and give up financial footing, unprofitable improve quality)
- Months of cash at 2

Significant Variables
- Qcomp
- Total
- Sites
- Staff
- Quick-ratio

```{r}

summary(as.numeric(dfc[dfc$Year == 2010,]$Total))
summary(as.numeric(dfc[dfc$Year == 2010,]$months_of_cash))
quantile(dfc[dfc$Year == 2010,]$ngla_net_gain_loss / dfc[dfc$Year == 2010,]$ngla_revenue, c(0.33, 0.67), na.rm = TRUE)


dfc.new <- dfc %>% 
        select(ID, Year, Tx, Att, STATE, Sites, htn.rate, dm.rate, imm.rate, crc.rate, pap.rate, childbmi.rate, adultbmi.rate, ivd.rate, cad.rate, asthma.rate, Total, ngla_net_gain_loss, ngla_revenue, ngla_expense, Staff, months_of_cash, quick_ratio, fringe_rate, Assets, Liabilities, 
               Qcomp:Altman)
        


did2s(
      data = dfc.new %>% 
        inner_join(dfc %>% filter(Year == 2010 & ngla_net_gain_loss/ngla_revenue > 0.083) #& ngla_net_gain_loss/ngla_revenue < 0.03)  ngla_net_gain_loss/Assets < 0.05
                   %>% select(ID, Pct.NHA:Pct.COM) %>% unique() , by = c("ID")) , 
      yname = "Altman", 
      treatment = "Tx",
        first_stage = ~ 0 | ID + Year + Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + Pct.MCD + Pct.MCR + Pct.None, 
        second_stage = ~ i(Tx, ref = FALSE),
        cluster_var = "ID",
      verbose = FALSE
    )


event_study(data = dfc.new %>% left_join(dfc %>% select(ID, Year, Pct.NHA:Pct.COM), by = c("ID","Year")) %>% 
              inner_join(dfc %>% filter(Year == 2010 & ngla_net_gain_loss/Assets < 0.05)# ngla_net_gain_loss/ngla_revenue < 0.03 as.numeric(months_of_cash) < 2)#Total > 10000) 
                   %>% select(ID) %>% unique() , by = c("ID")), 
  yname = "Qcomp", idname = "ID", tname = "Year", gname = "Att", estimator = "all", xformla = ~Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + Pct.MCD + Pct.MCR + Pct.None) %>% 
  filter(abs(term) <= 5) %>% 
  #filter(estimator == "Gardner (2021)") %>% 
  ggplot(aes(x = term, y = estimate, color = estimator)) + geom_point(position = position_dodge(0.9)) + geom_errorbar(aes(ymin=estimate-1.96*std.error, ymax=estimate+1.96*std.error), width=.2, position = position_dodge(0.9))  + 
  #facet_wrap(~V1, scales = "free_y", ncol = 3) + 
  theme_tufte_revised() + geom_vline(xintercept=-0.5, color="red", linetype="dashed", alpha=.5) + 
  geom_hline(yintercept=0, color="black", linetype="dashed", alpha=.5) 


```




