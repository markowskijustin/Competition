---
title: "Untitled"
author: "Justin"
date: "2024-10-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(readxl)
library(did2s)
library(did)
library(tidyverse)
library(directlabels)
library(gtsummary)
library(kableExtra)
library(ggpubr)
library(tigris)
library(usmap)
library(ivreg)
library(fixest)
library(sandwich)
library(lmtest)
library("viridis")
library(DescTools)

```


```{r}
mean.nas<- function(x){ mean(x, na.rm = TRUE)}

options(scipen=999)
```



```{r}
#dfc <- read_csv("/Users/markow/Dropbox/Git/Competition/data_processed/analyticalfile.csv")
#uds.sites.full <- read_csv("/Users/markow/Dropbox/Git/Competition/data_processed/sites_geocoded.csv") %>%
#  mutate(Access = ifelse(`BHCMIS ID` == "080170" & as.numeric(`Total Weekly Hours Of Operation`) > 40000, 4, Access))
clinics.in.zips <- uds.sites.full[!is.na(uds.sites.full$Zip),] %>%
  #filter(Year >= included.years[1]) %>%
  group_by(Zip, Year) %>%
  summarise(Clinics = n_distinct(`BHCMIS ID`), Sites = n()) %>%
  arrange(desc(Clinics))

 uds.sites.full %>%
   filter(is.na(Zip))


```



# Build Variables



## Build List of ALL CHCs, star constructing variables
```{r}


## Broader definitions 5 / 7 quality measures significant improvements overall
# included.years <- 2009:2021
# included.treat <- 2013:2021

## Original good filters
# included.years <- 2009:2019
# included.treat <- 2013:2019

included.years <- 2009:2023
included.treat <- 2011:2023



df.comp <- uds.covariates %>% 
  select(Year:BHCMISID, Total:Pct.COM) %>% 
  select(BHCMISID, Year, Total:Pct.COM) %>% 
  arrange(BHCMISID, Year) %>% 
  left_join(uds.6a, by = c("BHCMISID","Year" = "YEAR")) %>% 
  left_join(uds.quality.6b %>% select(Year, BHCMISID, imm.rate:adultbmi.denom), by = c("BHCMISID","Year")) %>% 
  left_join(uds.quality.7 %>% 
  filter(Race == " Total" | is.na(Race)) %>% 
  group_by(Year, BHCMISID) %>% 
  summarise(htn.rate = sum(htn.rate * htn.total) / sum(htn.total), 
            htn.total = sum(htn.total), 
            dm.rate = sum(dm.rate * dm.total) / sum(dm.total), 
            dm.total = sum(dm.total)) %>% 
  arrange(BHCMISID, Year), by = c("BHCMISID","Year")) %>% 
    left_join(fins.revenue.expenses, by = c("BHCMISID" = "BHCMIS.ID", "Year" = "form_year")) %>% 

  mutate(ID = as.numeric(as.factor(BHCMISID))) %>% 
  arrange(BHCMISID) 

df.comp <- df.comp %>% 
  left_join(df.comp %>% 
  group_by(BHCMISID) %>% 
  summarise(counts = n()) %>% filter(counts == length(included.years)), by = c("BHCMISID")) %>% 
  group_by(BHCMISID) %>% 
  mutate(closed = ifelse(is.na(counts) & Year == max(Year), 1, 0)) #%>%  filter(APM %in% c('Yes','No'))

#df.comp$year.rel <- relevel(as.factor(df.comp$year.rel), ref = "-1") 

## Filter for balanced panel, remove closures and late openings
df.comp <- df.comp %>%
  left_join(df.comp %>% summarise(Counts = n(), MinYear = min(Year)), by = c("BHCMISID")) #%>%  filter(Counts == length(included.years)) #  filter(Counts < 13 & MinYear == 2009)    filter(Counts == length(included.years))

## Remove some weird shit in CT
df.comp <- df.comp %>% 
  filter(BHCMISID != "01E00010") %>% 
                mutate(HIV.prev = T6A_L1AND2_CB / Total * 100, 
         HIV.care = T6A_L1AND2_CA / T6A_L1AND2_CB,
         
         HepC.prev = T6A_L4B_CB / Total * 100,
         HepC.care = T6A_L4B_CA / T6A_L4B_CB,

         Asthma.prev = T6A_L5_CB / Total * 100,
         Asthma.care = T6A_L5_CA / T6A_L5_CB,

         # AbnormalPap.prev = T6A_L8_CB / Total * 100,
         # AbnormalPap.care = T6A_L8_CA / T6A_L8_CB,
         #
         # ImmunizationsGiven.prev = T6A_L24_CB / Total * 100,
         # ImmunizationsGiven.care = T6A_L24_CA / T6A_L24_CB,
         
         HeartDisease.prev = T6A_L10_CB / Total * 100, 
         HeartDisease.care = T6A_L10_CA / T6A_L10_CB,
         
          OverweightOrObesity.prev = T6A_L14A_CB / Total * 100, 
          OverweightOrObesity.care = T6A_L14A_CA / T6A_L14A_CB, 
         
         Depression.prev = T6A_L19A_CB / Total * 100, 
         Depression.care = T6A_L19A_CA / T6A_L19A_CB, 
         
         Diabetes.prev = T6A_L9_CB / Total * 100, 
         Diabetes.care = T6A_L9_CA / T6A_L9_CB, 
         
         Hypertension.prev = T6A_L11_CB / Total * 100, 
         Hypertension.care = T6A_L11_CA / T6A_L11_CB) %>%  #%>%  filter(STATE != 'CT')
select(BHCMISID:Year, Total:Pct.COM, HIV.prev:Hypertension.care , imm.rate:MinYear)



```




## Z: Competitive Shocks and Y: Outcomes

```{r}


clinics.in.zips <- uds.sites.full[!is.na(uds.sites.full$Zip),] %>%
  #filter(Year >= included.years[1]) %>% 
  group_by(Zip, Year) %>%
  summarise(Clinics = n_distinct(`BHCMIS ID`), Sites = n()) %>%
  arrange(desc(Clinics))


# Identify clinics in competitive zip codes
clinics.comp <- uds.sites.full[!is.na(uds.sites.full$Zip),] %>% 
  filter(Year >= included.years[1]) %>%
  select(`BHCMIS ID`, Zip, Year) %>% 
  unique() %>% 
  left_join(clinics.in.zips, by = c("Zip", "Year")) %>% 
  group_by(`BHCMIS ID`, Year) %>% 
  summarise(Clinics = max(Clinics)) %>% 
  pivot_wider(id_cols = `BHCMIS ID`, names_from = Year, values_from = Clinics) %>% 
  #filter(`2011` == 1 & `2012` == 1 ) %>%  #  & `2012` == 1 & `2013` == 1 & `2014` == 1 & `2015` == 1 & `2016` == 1) %>%   
  #filter(`2010` == 1 & `2011` == 1 & `2012` == 1) %>%  
  #left_join(chc.term, by = c("BHCMIS ID" = "ClinicID")) %>%
  #filter(is.na(NewClinicID)) %>%
  select(`BHCMIS ID`:`2023`) %>% 
  pivot_longer(cols = c(`2009`:`2023`)) %>% 
  group_by(`BHCMIS ID`) %>% 
  #filter(min(value) == 1 ) %>% 
  #filter(max(value) == last(value)) %>% 
  mutate(Tx = ifelse(value > 1, 1, 0)) 


# Classify clinics by introduction of competition
comp.initial <- clinics.comp %>%  #left_join(clinics.comp %>% mutate(Year = as.numeric(name)), uds.zip.totals, by = c("BHCMIS ID", "name" = "Reporting Year")) %>% 
  mutate(Year = as.numeric(name)) %>% 
  left_join(uds.sites.full[!is.na(uds.sites.full$Zip),] %>% 
              filter(Year >= included.years[1]) %>%
  group_by(`BHCMIS ID`, Year) %>% 
  summarise(Sites = n()), by = c("BHCMIS ID","Year")) %>% 
  ungroup() %>% 
  group_by(`BHCMIS ID`) %>% 
  mutate(Att = min(ifelse(Tx == 0, 2, 1)*Year, na.rm = TRUE) ) %>% 
  group_by(`BHCMIS ID`) %>% 
  mutate(Att = ifelse(Att < max(included.treat)+1, Att, 0)) %>% 
  ungroup() %>% 
  mutate(ID = as.numeric(factor(`BHCMIS ID`)))

# Expandors vs Expandees
comp.initial <- comp.initial %>% 
  left_join(
      left_join(comp.initial %>% select(`BHCMIS ID`, Att) %>% unique(), uds.sites.full[!is.na(uds.sites.full$Zip),] %>% 
                  filter(Year >= included.years[1]) %>%
        select(`BHCMIS ID`, Zip, Year) %>% 
        group_by(`BHCMIS ID`, Zip) %>% 
        summarise(YearFirstInZip = min(Year)) %>% 
        filter(YearFirstInZip %notin% min(included.years)) %>% 
        select(`BHCMIS ID`, YearFirstInZip) %>% 
        unique(), by = c("BHCMIS ID")) %>% #filter(`BHCMIS ID` == "H80CS00101") %>% 
        mutate(Expandor = ifelse(is.na(YearFirstInZip) | Att != YearFirstInZip, 0, 1)) %>%  #  is.na(YearFirstInZip) | Att != YearFirstInZip
        group_by(`BHCMIS ID`) %>% summarise(Expandor = max(Expandor)), by = c("BHCMIS ID")) 


dfc <- comp.initial %>% filter(Expandor == 0) %>% 
  left_join(df.comp, by = c("BHCMIS ID" = "BHCMISID", "Year"))


dfc <- dfc %>% 
  mutate(Qcomp = (dm.rate + htn.rate + crc.rate + pap.rate + childbmi.rate + adultbmi.rate ) / 6 * 100, 
         Qcomp.w = (dm.rate * dm.total + htn.rate * htn.total + crc.rate * crc.denom + pap.rate * pap.denom + childbmi.rate * childbmi.denom + adultbmi.rate * adultbmi.denom ) / 
           ( dm.total +  htn.total +  crc.denom +  pap.denom +  childbmi.denom +  adultbmi.denom ) * 100, 
               CostPerPat = ngla_expense / Total, 
               months_of_cash = as.numeric(months_of_cash),
               ngla_prog_serv_revenue = as.numeric(ngla_prog_serv_revenue),
               quick_ratio = as.numeric(quick_ratio),
               Liquidity = (Assets - Liabilities) / Assets,
               Profitability = ngla_revenue / ngla_expense * 100, #Assets, 
               Efficiency = ngla_revenue / Assets, #ngla_revenue / Assets,
               NetWorth = (Assets - Liabilities) / Liabilities, 
            Pexpenses = ngla_prog_serv_revenue / ngla_prog_expense, 
            LiabPctAssets = Liabilities / Assets * 100, 
            Eff = ngla_prog_serv_revenue / Assets, 
            LiabPctRev = ngla_prog_serv_revenue / ngla_expense) 

dfc <- dfc %>% 
  mutate(Liquidity = ifelse(is.infinite(Liquidity), NA, Liquidity), 
         Profitability = ifelse(is.infinite(Profitability), NA, Profitability), 
         Efficiency = ifelse(is.infinite(Efficiency), NA, Efficiency), 
         NetWorth = ifelse(is.infinite(NetWorth), NA, NetWorth), 
         Altman = (0.0656 * Liquidity + 0.0326 * quick_ratio + 0.0672 * Efficiency + 0.0105 * NetWorth) * 10) %>% 
         #Altman = 0.18 * quick_ratio + 0.3 * Profitability/100 + 0.81 * Efficiency + 0.14 * NetWorth) %>% 
  mutate(Att.random = ifelse(Att > 0, Att, NA), 
         Distress = ifelse(Altman < 2.6, 1, 0))


table(table(dfc$`BHCMIS ID`))



dfc %>% filter(ID.x == "90")

dfc %>% 
  filter(`BHCMIS ID` == "012070")

```

```{r}
uds.covariates %>% 
  filter(`BHCMISID` == "010180")
```




## D: HHI, and Bring them Together

```{r}

df.zip <- uds.zip %>% 
  inner_join(clinics.in.zips, by = c("ZipCode" = "Zip","ReportingYear" = "Year")) %>% 
  select(BHCMISID, GrantNumber, ReportingYear, ZipCode, NumberofPatients) 

df.zip.totals <- df.zip %>% 
  group_by( ReportingYear, ZipCode) %>% 
  summarise(Totals = sum(NumberofPatients))

df.zip.HHI <- df.zip %>% 
  group_by(BHCMISID, ReportingYear, ZipCode) %>% 
  summarise(ZipTotal = sum(NumberofPatients)) %>% 
  left_join(df.zip.totals, by = c("ReportingYear","ZipCode")) %>% 
  mutate(MS = ZipTotal / Totals * 100) %>% 
  ungroup() %>% 
  arrange(ZipCode, ReportingYear) %>% 
  group_by(ZipCode, ReportingYear) %>% 
  mutate(ZipHHI = sum(MS ^2)) %>% 
  group_by(BHCMISID, ReportingYear) %>% 
  mutate(ClinicTotal = sum(ZipTotal), 
         ClinicHHI = sum(ZipHHI * ZipTotal / ClinicTotal)) %>% 
  arrange(BHCMISID, ReportingYear, ZipCode)
  



df.zip <- df.zip %>% 
  left_join(df.zip.totals, by = c("ZipCode","ReportingYear")) %>% 
  group_by(BHCMISID, GrantNumber, ReportingYear) %>% 
  summarise(MS_num = sum(NumberofPatients, na.rm = TRUE), 
            MS_denom = sum(Totals, na.rm = TRUE)) %>% 
  mutate(MS = 100 - (MS_num / MS_denom * 100)) %>% 
  left_join(df.zip.HHI %>% select(BHCMISID, ReportingYear, ClinicHHI) %>% unique(), by = c("BHCMISID","ReportingYear"))

df.mt <- dfc %>% 
  left_join(df.zip, by = c("BHCMIS ID" = "BHCMISID", "Year" = "ReportingYear")) %>% 
  mutate(logPatsPerStaff = ifelse(is.infinite(log(Total / Staff)) | Staff < 5, NA, (Total / Staff))) %>% 
  mutate(Complexity = (HIV.prev + Asthma.prev + HeartDisease.prev +  Diabetes.prev + Hypertension.prev) / 5, 
         Intensity = (HIV.care + Asthma.care + HeartDisease.care +  Diabetes.care + Hypertension.care) / 5, 
         Intensity.w = (HIV.care * HIV.prev + HepC.care * HepC.prev + Asthma.care * Asthma.prev + HeartDisease.care * HeartDisease.prev + Depression.care * Depression.prev + Diabetes.care * Diabetes.prev + Hypertension.care * Hypertension.prev) / 
                  (HIV.prev+ HepC.prev + Asthma.prev + HeartDisease.prev + Depression.prev + Diabetes.prev + Hypertension.prev)) %>% 
  mutate(dm.rate = dm.rate * 100, 
         htn.rate = htn.rate * 100, 
         pap.rate = pap.rate * 100, 
         crc.rate = crc.rate * 100, 
         childbmi.rate = childbmi.rate * 100, 
         adultbmi.rate = adultbmi.rate * 100, 
         asthma.rate = asthma.rate * 100, 
         cad.rate = cad.rate * 100, 
         ivd.rate = ivd.rate * 100)


df.mt[df.mt$Year >= 2010,]$Complexity <- df.mt[df.mt$Year >= 2010,] %>% 
  select(HIV.prev, Depression.prev, HeartDisease.prev, Diabetes.prev, Hypertension.prev) %>% 
  rowMeans(na.rm = TRUE)

df.mt[df.mt$Year >= 2010,]$Intensity <- df.mt[df.mt$Year >= 2010,] %>% 
  select(HIV.care, Depression.care, HeartDisease.care, Diabetes.care, Hypertension.care) %>% 
  rowMeans(na.rm = TRUE)
  


```

## More Cleaning
```{r}

df.temptemp <- df.mt %>% 
    rename(ID = ID.x) %>% 
    group_by(ID) %>% 
  mutate(Closed = ifelse(lead(is.na(Sites)), 100, 0)) %>% 
  select(ClinicHHI, Att, `BHCMIS ID`, value, ID, MS, Year, Pct.NHA:Pct.Homeless, Qcomp, Total, Altman, logPatsPerStaff, 
         htn.rate, dm.rate, pap.rate, crc.rate, childbmi.rate, adultbmi.rate, Complexity, Intensity, Pct.MCD, Pct.MCR, Pct.COM, Pct.None, CostPerPat, quick_ratio, months_of_cash, Profitability, LiabPctAssets, Staff, Closed, pap.denom, crc.denom, childbmi.denom, adultbmi.denom, htn.total, dm.total, asthma.rate, cad.rate, ivd.rate, ngla_net_gain_loss, Liquidity, Efficiency, NetWorth, Liabilities) %>% 
  unique() 


## htn.total, dm.total, pap.denom, crc.denom, childbmi.denom, adultbmi.denom

df.temptemp <- df.temptemp %>% 
  group_by(ID) %>% 
  mutate(value_min = min(value, na.rm = TRUE), value_max = max(value, na.rm = TRUE), value_last = last(value, na_rm = TRUE), value_first = first(value, na_rm = TRUE)) %>% 
  mutate(Tx = value - value_first) %>% 

  filter(value_min == value_max | value_last > value_first) %>% 
  mutate(value = ifelse(value >= 6, 6, value)) #%>% group_by(ID) %>% mutate(max_Closures = max(Closed)) %>% filter(max_Closures == 0) 




df.temptemp <- df.temptemp %>% 
  left_join (df.temptemp %>% 
  filter(value > value_min) %>% 
  group_by(ID) %>% 
  summarise(Att = min(Year)), by = c("ID")) %>% 
  mutate(Att = ifelse(!is.na(Att.y), Att.y, Att.x)) %>% 
  select(ClinicHHI, Att, `BHCMIS ID`, value, ID, MS, Year, Pct.NHA:Pct.Homeless, Qcomp, Total, Altman, logPatsPerStaff, 
         htn.rate, dm.rate, pap.rate, crc.rate, childbmi.rate, adultbmi.rate, Complexity, Intensity, Pct.MCD, Pct.MCR, Pct.COM, Pct.None, CostPerPat, quick_ratio, months_of_cash, Profitability, LiabPctAssets, Staff, Closed:Tx) %>% 
  unique() 


coredata <- read_excel("//Users/markow/Dropbox/Git/UDS/UDS-2012-Full-Dataset.xlsx", sheet = "HealthCenterInfo", skip = 0) %>% select(GrantNumber, FundingCHC:UrbanRuralFlag)



df.temptemp <- df.temptemp %>%
  left_join(uds.cw %>% filter(Year == 2011) %>% select(ModernGranteeID, BHCMIS.ID:PH), by = c("BHCMIS ID" = "BHCMIS.ID")) %>%
  left_join(coredata %>% select(GrantNumber, UrbanRuralFlag), by = c("ModernGranteeID" = "GrantNumber")) %>% 
  mutate(ACA = ifelse((STATE %in% c('MI','NH') & Year >= 2014) |
                    (STATE %in% c('PA','IN','AK') & Year >= 2015) |
                    (STATE %in% c('MT','LA') & Year >= 2016) |
                    (STATE %in% c('VA','ME') & Year >= 2019) |
                    (STATE %in% c('ID','UT','NE') & Year >= 2020) |
                    (STATE %in% c('OK','MO') & Year >= 2021) |
                    (STATE %in% c('AZ','AR','CA','CO','CT','DE','DC','HI','IL','IA','KY','MD','MA','MN','NV','NJ','NM','NY','ND','OH','OR','PA','RI','VT','VA','WA') & Year >= 2014), 1, 0))


df.temptemp <- df.temptemp %>% 
  left_join(df.temptemp %>% 
  group_by(ID) %>% 
  summarise(n()) %>% 
  filter(`n()` != length(included.years)), by = c("ID")) %>% 
  filter(is.na(`n()`))



possible.vecs <- rep(included.treat, df.temptemp %>% 
  filter(Tx == 1 & Year > 2010) %>% 
  summarise(EarlyTx = min(Year)) %>% 
  select(EarlyTx) %>% 
  unlist() %>% 
  table() )

# 
# df.temptemp <- df.temptemp %>% 
#   left_join(df.temptemp %>% 
#   #filter(Year == 2012) %>% 
#   mutate(Treat = ifelse(Att > 0 & value_last - value_first > 0, "Treated", "Control")) %>% 
#   select(Treat, ID, Tx, Att, value_min, value_max, value_first, value_last) %>% 
#   group_by(Treat, ID, Att, value_min, value_max, value_first, value_last) %>% 
#   summarise(max(Tx, na.rm = TRUE)) %>% 
#   arrange(Att), by = c("ID"))
# # 


set.seed(123)
df.temptemp <- df.temptemp %>% 
  #filter(Year == 2012) %>% 
  mutate(Treat = ifelse(Att > 2009 & value_last - value_first > 0 , "Treated", "Control")) %>% 
  mutate(Att.random = ifelse(Treat == "Control", sample(possible.vecs, size = 1, replace = T), Att)) %>% 
  mutate(year.rel = Year - Att.random) %>% 
  mutate(Att = ifelse(value_min == value_max, 0, Att))


df.temptemp <- df.temptemp %>% 
  filter(!(Treat == "Control" & Att == 2009))




```


# Analysis

## Demographics 



## Balance between treated and controls
```{r}

df.temptemp %>% 
  filter(Year == 2012) %>% 
  mutate(Treat = ifelse(Att > 0 & value_last - value_first > 0, "Treated", "Control")) %>% 
  select(Treat, Total, Pct.NHA:Staff) %>% 
  #filter(!complete.cases(.)) %>% 
  tbl_summary(by = Treat, 
                statistic = list(all_continuous() ~ "{mean} ({sd})"),
missing = "no", digits = list(everything() ~ c(2))) %>% 
  add_p(pvalue_fun = function(x) style_pvalue(x, digits = 3)) 


df.temptemp %>% 
  filter(Year == 2023) %>% 
  mutate(Treat = ifelse(Att > 0, "Treated", "Control")) %>% 
  select(Treat, Total, Pct.NHA:Staff) %>% 
  ungroup() %>% 
  summarise(n(), sum(Total, na.rm = TRUE))


df.temptemp %>% 
  filter(Year == 2009) %>% 
  ungroup() %>% 
  select(Treat, value_first, value_last) %>% 
  mutate(Change = value_last - value_first) %>% 
  select(value_first, Change) %>% 
  table()





## Final Data
demo1 <- df.temptemp %>% 
  filter(year.rel %in% c(-1, 0)) %>% 
  ungroup() %>% 
  mutate(Gx = paste(Treat, year.rel, sep = ": Year Relative ")) %>% 
  select(Gx, Pct.NHA:Pct.Homeless, UrbanRuralFlag) %>% 
  tbl_summary(by = Gx, 
              missing = "no", # don't list missing data separately
      statistic = all_continuous() ~ "{mean} ({sd})",
      digits = all_continuous() ~ c(2,2)
    ) 



demo2 <- df.temptemp %>% 
  filter(year.rel %in% c(-1, 0)) %>% 
   ungroup() %>% 
  mutate(Gx = paste(Treat, year.rel, sep = ": Year Relative ")) %>% 
  select(year.rel, ID, Treat, Total, Pct.NHA:Pct.Homeless, UrbanRuralFlag) %>% 
  pivot_longer(c(Total:Pct.Homeless)) %>% 
  pivot_wider(id_cols = c(ID, name, Treat), names_from = year.rel, values_from = value) %>% 
  mutate(diff = `0` - `-1`) %>% 
  select(ID, name, Treat, diff) %>% 
  pivot_wider(id_cols = c(ID, Treat), names_from = name, values_from = diff) %>% 
  ungroup() %>% 
  select(Treat, Pct.NHA:Pct.Homeless) %>% 
  tbl_summary(by = Treat, 
              missing = "no", # don't list missing data separately
      statistic = all_continuous() ~ "{mean} ({sd})",
      digits = all_continuous() ~ c(2,2)
    ) %>% 
  add_difference()


tbl_merge(tbls = list(demo1, demo2)) %>%
  modify_spanning_header(everything() ~ NA_character_)


df.temptemp %>% 
  filter(Year == 2009) %>% 
  ungroup() %>% 
  select(`BHCMIS ID`, ID, Treat, value_first, value_last) %>% 
  mutate(Change = value_last - value_first) %>% 
  filter(Treat == "Control") %>% 
  arrange(desc(Change))



```



##  Trends over time, figure 1

```{r}
## Plot
p <- uds.sites.full[!is.na(uds.sites.full$Zip),] %>% 
  select(`BHCMIS ID`, Zip, Year) %>% 
  unique() %>% 
  left_join(clinics.in.zips, by = c("Zip", "Year")) %>%
  group_by(`BHCMIS ID`, Year) %>%
  summarise(Clinics = max(Clinics, na.rm = TRUE)) %>%
  group_by(Year, Clinics) %>% 
  summarise(Count = n()) %>% 
  mutate(CompetitorsInArea = factor(ifelse( Clinics < 4, Clinics - 1, "3+"))) %>% 
  group_by(Year, CompetitorsInArea) %>% 
  summarise(Count = sum(Count)) %>% 
  filter(CompetitorsInArea != "-Inf")


plot0 <- p %>% 
  arrange(CompetitorsInArea) %>% 
  ggplot(aes(x = Year, y = Count, group = CompetitorsInArea, color = CompetitorsInArea)) + ylab("FQHCs") + 
  geom_point(size = 1.1) + geom_line(size = 1.1) + theme_tufte_revised() + ggtitle("FQHCs by Number of Colocated FQHCs") + 
  geom_dl(label=c(rep("0 Rivals", length(unique(p$Year))), rep("1 Rival", length(unique(p$Year))), rep("2 Rivals", length(unique(p$Year))), rep("3+ Rivals", length(unique(p$Year)))), 
          method = list("last.points", hjust = 1, vjust = c(1.5, 2.5, 2.5, -1), cex = 1.5), inherit.aes=T ) + 
  guides(colour = "none") +theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"))

plot1 <- uds.sites.full[!is.na(uds.sites.full$Zip),] %>% 
            group_by(Zip, Year) %>% 
  summarise(Counts = n()) %>% 
  #summarise(Counts = n_distinct(`Grant Number`)) %>% 
  ungroup() %>% 
  group_by(Year, Counts) %>% 
  summarise(Zips = n()) %>% 
  mutate(Counts.f = as.factor(ifelse(Counts >= 2, "2+", Counts))) %>% 
  group_by(Counts.f, Year) %>% 
  summarise(Zips = sum(Zips)) %>% 
  #filter(Year >= 2010) %>% 
  ggplot(aes(x = Year, y = Zips, group = Counts.f, color = Counts.f)) + 
  geom_point(size = 1.1) + geom_line(size = 1.1) + theme_tufte_revised() + ggtitle("Zip Codes by Number of FQHC Sites") + 
  geom_dl(label=c(rep("1 Site", length(unique(p$Year))), rep("2+ Sites", length(unique(p$Year)))), method = list("last.points", hjust = 1, vjust = -1, cex = 1.5), inherit.aes=T ) + 
  guides(colour = "none") + ylim(0, 4000) +theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"))


p.desc <- ggarrange(plot1, plot0, ncol = 1) 

p.desc <- annotate_figure(p.desc, top = text_grob("FQHC Growth and Density by Zip and Clinic, UDS 1996 to 2021", face = "bold", size = 14))

#ggsave(filename = "Figure1.png", path = "/Users/markow/Dropbox/Writing/CHC Competitive Shocks/Figures", plot = p.desc, width = 8, height = 11)



# p.desc <- ggarrange(plot1, plot0, ncol = 2) 
# 
# p.desc <- annotate_figure(p.desc, top = text_grob("FQHC Growth and Density by Zip and Clinic, UDS 1996 to 2021", face = "bold", size = 14))

#ggsave(filename = "Picture1h.png", path = "/Users/jhm65/Dropbox/Writing/JMP_figures", plot = p.desc, width = 16, height = 9)


p.desc



```

##  Trends over time, figure 1 - black and white for milbank

```{r}

plot0 <- p %>% 
  arrange(CompetitorsInArea) %>% 
  ggplot(aes(x = Year, y = Count, group = CompetitorsInArea, linetype = CompetitorsInArea)) + ylab("FQHCs") + 
  #geom_point(size = 1.1) + 
  geom_line(size = 1.1) + theme_tufte_revised() + ggtitle("FQHCs by Number of Colocated FQHCs") + 
  #geom_dl(label=c(rep("0 Rivals", length(unique(p$Year))), rep("1 Rival", length(unique(p$Year))), rep("2 Rivals", length(unique(p$Year))), rep("3+ Rivals", length(unique(p$Year)))), 
   #       method = list("last.points", hjust = 1, vjust = c(-3, 2, 2.5, -1), cex = 1.5), inherit.aes=T ) + 
  #guides(linetype = "none") + 
  guides(linetype = guide_legend(title = "# other CHCs\nin Incumbent's\nService Area")) + 
  scale_linetype_manual(values=c(1,2,3, 4)) + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"))

plot1 <- uds.sites.full[!is.na(uds.sites.full$Zip),] %>% 
            group_by(Zip, Year) %>% 
  summarise(Counts = n()) %>% 
  #summarise(Counts = n_distinct(`Grant Number`)) %>% 
  ungroup() %>% 
  group_by(Year, Counts) %>% 
  summarise(Zips = n()) %>% 
  mutate(Counts.f = as.factor(ifelse(Counts >= 2, "2+", Counts))) %>% 
  group_by(Counts.f, Year) %>% 
  summarise(Zips = sum(Zips)) %>% 
  #filter(Year >= 2010) %>% 
  ggplot(aes(x = Year, y = Zips, group = Counts.f, linetype = Counts.f)) + 
  #geom_point(size = 1.1) + 
  geom_line(size = 1.1) + theme_tufte_revised() + 
  ggtitle("Zip Codes by Number of FQHC Sites") + 
  #geom_dl(label=c(rep("1 Site", length(unique(p$Year))), rep("2+ Sites", length(unique(p$Year)))), method = list("last.points", hjust = 1, vjust = -1, cex = 1.5), inherit.aes=T ) + 
  #guides(linetype = "none") + 
  ylim(0, 4000) +theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold")) + 
  scale_linetype_manual(values=c(5, 6)) + 
  guides(linetype = guide_legend(title = "# CHC Sites by\nZip Code"))


p.desc <- ggarrange(plot1, plot0, ncol = 1) 

p.desc <- annotate_figure(p.desc, top = text_grob("FQHC Growth and Density by Zip and Clinic, UDS 1996 to 2023", face = "bold", size = 14))

#ggsave(filename = "Figure1.png", path = "/Users/markow/Dropbox/Writing/CHC Competitive Shocks/Figures", plot = p.desc, width = 8, height = 11)



# p.desc <- ggarrange(plot1, plot0, ncol = 2) 
# 
# p.desc <- annotate_figure(p.desc, top = text_grob("FQHC Growth and Density by Zip and Clinic, UDS 1996 to 2021", face = "bold", size = 14))

#ggsave(filename = "Picture1h.png", path = "/Users/jhm65/Dropbox/Writing/JMP_figures", plot = p.desc, width = 16, height = 9)


p.desc


```




## Model

```{r}



# %>% 
#   group_by(ID) %>% 
#   mutate(Strata = min(Profitability, na.rm = TRUE)) %>% 
#   filter(Strata < 0)


coeffs <- c(0,0,0,0)

for (k in 1:28){

  #df.temptemptemp <- df.temptemp %>% mutate(Tx = ifelse(Tx > 1, 1, 0)) %>% filter(!is.na(Tx))
  df.temptemptemp <- df.temptemp %>% mutate(Tx = ifelse(Year >= Att & Att %notin% c(0, 2009, 2010), 1, 0)) %>% filter(!is.na(Tx))
  colnames(df.temptemptemp)[(16+k)] <- "Outcome"
  outlier.vals <- quantile(df.temptemptemp$Outcome, p = c(0.01, 0.99), na.rm = TRUE)
  df.temptemptemp <- df.temptemptemp %>% 
    mutate(Outcome = ifelse(Outcome <= outlier.vals[1], outlier.vals[1], 
                            ifelse(Outcome >= outlier.vals[2], outlier.vals[2], Outcome)))
  #model <- feols(Outcome ~ Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless   | I((10000 - ClinicHHI)/1000) ~ Tx + factor(Year) + factor(ID) , cluster = "ID", data = df.temptemptemp)
  #coeffs <- rbind(coeffs, model$coeftable[2,])
  model <- feols(Outcome ~ Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag | ID + Year | I((10000 - ClinicHHI)/1000) ~ Tx*value, cluster = "ID", data = df.temptemptemp)
  coeffs <- rbind(coeffs, model$coeftable[1,])
  

}



core.iv.estimates <- data.frame(cbind(colnames(df.temptemp)[17:44], (coeffs[-1,]))) %>% 
  #select(V1, Estimate, Pr...t.., Estimate.1, Pr...t...1) %>% 
  mutate(Estimate = round(as.numeric(Estimate), 2), `95% CI` = paste(round(as.numeric(Estimate) - 1.96 * as.numeric(`Std..Error`), 2), ", ", round(as.numeric(Estimate) + 1.96 * as.numeric(`Std..Error`), 2), sep = "")) %>% 
  select(V1, Estimate, `95% CI`)

core.iv.estimates <- core.iv.estimates
rownames(core.iv.estimates) <- NULL

core.iv.estimates %>% 
  kable("html", booktabs = T, col.names = c("Outcome","Estimate","95% CI")) %>% 
  kable_styling(latex_options = c("striped")) %>%
  pack_rows(index = c("Overall Impacts" = 4, "Quality of Care" = 6, "Patient Complexity" = 2, "Payer Mix" = 4, "Finances" = 6)) %>% 
  add_header_above(c("IV-Estimated LATE Effects of Competitive Shocks on Incumbent Clinics" = 3))



```




## First Stage DID Estimates and Event Study

```{r}
 did2s(
      data = df.temptemp %>% mutate(Tx = ifelse(Tx > 1, 1, 0)) %>% filter(!is.na(Tx)  ), 
      yname = "ClinicHHI", 
      treatment = "Tx",
        first_stage = ~ Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag | ID + Year , #Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.MCD + Pct.MCR + Pct.None | ID + Year , 
        second_stage = ~ i(Tx, ref = FALSE),
        cluster_var = "ID",
      verbose = TRUE
    )



    event_study(data = df.temptemp,
  yname = "ClinicHHI", idname = "ID", tname = "Year", gname = "Att", estimator = "all", xformla = ~Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag) %>%
  filter(abs(term) <= 6) %>%
  filter(estimator == "Gardner (2021)") %>%
  #filter(estimator == "Callaway and Sant'Anna (2020)") %>%
  ggplot(aes(x = term, y = estimate, color = estimator)) + geom_point(position = position_dodge(0.9), size = 3) + geom_errorbar(aes(ymin=estimate-1.96*std.error, ymax=estimate+1.96*std.error), width=.25, position = position_dodge(0.9), size = 0.8)  +
  #facet_wrap(~V1, scales = "free_y", ncol = 3) +
  theme_tufte_revised() + geom_vline(xintercept=-0.5, color="blue", linetype="dashed", alpha=.6)+ #theme(legend.position = "none", plot.title = element_text(size=18, face='bold')) +
  geom_hline(yintercept=0, color="black", linetype="dashed", alpha=.5) + ggtitle("FirstStage: ") + xlab("Year Relative to Competitive Shock") + ylab("Percentage Points")


  
  

```


## Heterogeneity by Starting Point
```{r}

 event_study(data = df.temptemp %>% filter(value_min == 1),
  yname = "Qcomp", idname = "ID", tname = "Year", gname = "Att", estimator = "all", xformla = ~Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag) %>%
  filter(abs(term) <= 6) %>%
  filter(estimator == "Gardner (2021)") %>%
  #filter(estimator == "Callaway and Sant'Anna (2020)") %>%
  ggplot(aes(x = term, y = estimate, color = estimator)) + geom_point(position = position_dodge(0.9), size = 3) + geom_errorbar(aes(ymin=estimate-1.96*std.error, ymax=estimate+1.96*std.error), width=.25, position = position_dodge(0.9), size = 0.8)  +
  #facet_wrap(~V1, scales = "free_y", ncol = 3) +
  theme_tufte_revised() + geom_vline(xintercept=-0.5, color="blue", linetype="dashed", alpha=.6)+ #theme(legend.position = "none", plot.title = element_text(size=18, face='bold')) +
  geom_hline(yintercept=0, color="black", linetype="dashed", alpha=.5) + ggtitle("FirstStage: ") + xlab("Year Relative to Competitive Shock") + ylab("Percentage Points")



 event_study(data = df.temptemp,
  yname = "Qcomp", idname = "ID", tname = "Year", gname = "Att", estimator = "all", xformla = ~Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag) %>%
  filter(abs(term) <= 8) %>%
  filter(estimator == "Gardner (2021)") %>%
  #filter(estimator == "Callaway and Sant'Anna (2020)") %>%
  ggplot(aes(x = term, y = estimate, color = estimator)) + geom_point(position = position_dodge(0.9), size = 3) + geom_errorbar(aes(ymin=estimate-1.96*std.error, ymax=estimate+1.96*std.error), width=.25, position = position_dodge(0.9), size = 0.8)  +
  #facet_wrap(~V1, scales = "free_y", ncol = 3) +
  theme_tufte_revised() + geom_vline(xintercept=-0.5, color="blue", linetype="dashed", alpha=.6)+ #theme(legend.position = "none", plot.title = element_text(size=18, face='bold')) +
  geom_hline(yintercept=0, color="black", linetype="dashed", alpha=.5) + ggtitle("FirstStage: ") + xlab("Year Relative to Competitive Shock") + ylab("Percentage Points")
 
 

 
  event_study(data = df.temptemp %>% mutate(Tx = ifelse(Tx > 1, 1, 0)) %>% filter(!is.na(Tx)) %>% mutate(Att = ifelse(Att == 2010, 0, Att)),
  yname = "Staff", idname = "ID", tname = "Year", gname = "Att", estimator = "all", xformla = ~ Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag) %>%
  filter(abs(term) <= 8) %>%
  filter(estimator == "Gardner (2021)") %>%
  #filter(estimator == "Callaway and Sant'Anna (2020)") %>%
  ggplot(aes(x = term, y = estimate, color = estimator)) + geom_point(position = position_dodge(0.9), size = 3) + geom_errorbar(aes(ymin=estimate-1.96*std.error, ymax=estimate+1.96*std.error), width=.25, position = position_dodge(0.9), size = 0.8)  +
  #facet_wrap(~V1, scales = "free_y", ncol = 3) +
  theme_tufte_revised() + geom_vline(xintercept=-0.5, color="blue", linetype="dashed", alpha=.6)+ #theme(legend.position = "none", plot.title = element_text(size=18, face='bold')) +
  geom_hline(yintercept=0, color="black", linetype="dashed", alpha=.5) + ggtitle("FirstStage: ") + xlab("Year Relative to Competitive Shock") + ylab("Percentage Points")

  
  
  
  outlier.vals <- quantile(df.temptemp$Altman, p = c(0.01, 0.99), na.rm = TRUE)
   event_study(data = df.temptemp %>% mutate(ifelse(Att == 2009, 0, Att)) %>% mutate(Altman = ifelse(Altman <= outlier.vals[1], outlier.vals[1], 
                            ifelse(Altman >= outlier.vals[2], outlier.vals[2], Altman))),
  yname = "Altman", idname = "ID", tname = "Year", gname = "Att", estimator = "all", xformla = ~Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag) %>%
  filter(abs(term) <= 7) %>%
  filter(estimator == "Gardner (2021)") %>%
  #filter(estimator != "Callaway and Sant'Anna (2020)") %>%
  ggplot(aes(x = term, y = estimate, color = estimator)) + geom_point(position = position_dodge(0.9), size = 3) + geom_errorbar(aes(ymin=estimate-1.96*std.error, ymax=estimate+1.96*std.error), width=.25, position = position_dodge(0.9), size = 0.8)  +
  #facet_wrap(~V1, scales = "free_y", ncol = 3) +
  theme_tufte_revised() + geom_vline(xintercept=-0.5, color="blue", linetype="dashed", alpha=.6)+ #theme(legend.position = "none", plot.title = element_text(size=18, face='bold')) +
  geom_hline(yintercept=0, color="black", linetype="dashed", alpha=.5) + ggtitle("Outcomes") + xlab("Year Relative to Competitive Shock") + ylab("Percentage Points")
   

```




## Alt DID estimates

```{r}


coeffs.did <- c(0,0,0,0)

for (k in 1:23){

  #df.temptemptemp <- df.temptemp %>% mutate(Tx = ifelse(Tx > 1, 1, 0)) %>% filter(!is.na(Tx)) #%>% group_by(ID) %>% mutate(EarlyHHI = first(ClinicHHI, na_rm = TRUE)) %>% filter(EarlyHHI < 9000)
  df.temptemptemp <- df.temptemp %>% mutate(Tx = ifelse(Year >= Att & Att %notin% c(0, 2009, 2010), 1, 0)) %>% filter(!is.na(Tx)) #%>% filter(Att %notin% c(2011))
  colnames(df.temptemptemp)[(16+k)] <- "Outcome"
  # Winsorized
  outlier.vals <- quantile(df.temptemptemp$Outcome, p = c(0.01, 0.99), na.rm = TRUE)
  df.temptemptemp <- df.temptemptemp %>% 
    mutate(Outcome = ifelse(Outcome <= outlier.vals[1], outlier.vals[1], 
                            ifelse(Outcome >= outlier.vals[2], outlier.vals[2], Outcome)))
  model <-  did2s(
      data = df.temptemptemp, 
      yname = "Outcome", 
      treatment = "Tx",
        first_stage = ~ Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag | ID + Year , #Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.MCD + Pct.MCR + Pct.None | ID + Year , 
        second_stage = ~ i(Tx, ref = FALSE),
        cluster_var = "ID",
      verbose = TRUE
    )


  coeffs.did <- rbind(coeffs.did, model$coeftable[1,])
  

}


core.did.estimates <- data.frame(cbind(colnames(df.temptemp)[17:39], (coeffs.did[-1,]))) %>% 
  #select(V1, Estimate, Pr...t.., Estimate.1, Pr...t...1) %>% 
  mutate(Estimate = round(as.numeric(Estimate), 2), `95% CI` = paste(round(as.numeric(Estimate) - 1.96 * as.numeric(`Std..Error`), 2), ", ", round(as.numeric(Estimate) + 1.96 * as.numeric(`Std..Error`), 2), sep = "")) %>% 
  select(V1, Estimate, `95% CI`, Pr...t..)

core.did.estimates <- core.did.estimates
rownames(core.did.estimates) <- NULL






winsors <- function(x){ Winsorize(x, val = quantile(x, probs = c(0.01, 0.99), na.rm = TRUE))} 





df.temptemp %>% 
  mutate(Post = ifelse(year.rel >= 0, 1, 0)) %>% 
  select(Post, Treat) %>% 
  cbind(
df.temptemp %>% 
  ungroup() %>% 
  select(Qcomp:Staff) %>% 
  summarise_all(winsors)
) %>% 
  group_by(Post, Treat) %>% 
  
  summarise_all(mean.nas) %>% 
  # summarise(Total = mean(Total, na.rm = TRUE), 
  #           Quality = mean(Qcomp, na.rm = TRUE), 
  #           Finances = mean(Altman, na.rm = TRUE)) %>% 
  pivot_longer(cols = Qcomp:Staff) %>% 
  mutate(value = round(value, 2)) %>% 
  #filter(name %in% c("Total", "Qcomp", "Altman")) %>% 
  pivot_wider(id_cols = name, names_from = c(Treat, Post), values_from = value) %>% 
  mutate(Unadjusted = (Treated_1 - Treated_0) - (Control_1 - Control_0)) %>% 
  rbind(
    
    cbind(name = "Closed", 
    df.temptemp %>% 
  mutate(Post = ifelse(year.rel >= 0, 1, 0)) %>% 
  filter(!is.na(value)) %>% 
  group_by(Post, Treat) %>% 
  select(Closed) %>% 
  summarise_all(mean.nas) %>% 
  # summarise(Total = mean(Total, na.rm = TRUE), 
  #           Quality = mean(Qcomp, na.rm = TRUE), 
  #           Finances = mean(Altman, na.rm = TRUE)) %>% 
  #mutate(value = round(value, 2)) %>% 
  #filter(name %in% c("Total", "Qcomp", "Altman")) %>% 
  pivot_wider(names_from = c(Treat, Post), values_from = Closed) %>% 
  mutate(Unadjusted = (Treated_1 - Treated_0) - (Control_1 - Control_0)))
  
  
  
  ) %>% 
  
  
  cbind(core.did.estimates) %>% 
   select(name, `Control_0`, `Control_1`, `Treated_0`, `Treated_1`, Unadjusted, Estimate, `95% CI`, Pr...t..) %>% 
  mutate(`% Change` = round(Estimate / `Treated_0` * 100, 1)) %>% 
  rename(Outcome = name) %>% 
  select(Outcome:Estimate, `95% CI`, Pr...t.., `% Change`) %>% 
  kable("html", booktabs = T, col.names = c("Outcome","Pre","Post","Pre","Post","Unadjusted DID","Estimate","95% CI","p-value", "% Change")) %>% 
  kable_styling(latex_options = c("striped")) %>%
  #pack_rows(index = c("Total Patients by Insurnace" = 4, "Quality Measure Components" = 6, "Financial Components" = 4)) %>% 
  add_header_above(c(" " = 1, "Control" = 2, "Treated" = 2, " " = 1, "Staggered DID" = 4))







```


## Benjamini Hochberg
```{r}
core.did.estimates %>% 
  arrange(`Pr...t..`) %>% 
  mutate(`Pr...t..` = as.numeric(`Pr...t..`)) %>% 
  cbind(c(1:nrow(core.did.estimates)) / nrow(core.did.estimates) * 0.1) %>% 
  mutate(Row = row_number()) %>% 
  ggplot(aes(x = Row, y = `Pr...t..`)) + geom_point() + 
  ylab("p-values") + xlab("Significance Rank") + geom_abline(slope = 1/nrow(core.did.estimates) * 0.1, intercept = 0, color="red", linetype="dashed", alpha=.5) + theme_minimal()


```




## Formal Pre-trends


```{r}


pretrends <- c(0,0,0,0,0)
for (k in 1:23){

  #df.temptemptemp <- df.temptemp %>% mutate(Tx = ifelse(Tx > 1, 1, 0)) %>% filter(!is.na(Tx)) #%>% group_by(ID) %>% mutate(EarlyHHI = first(ClinicHHI, na_rm = TRUE)) %>% filter(EarlyHHI < 9000)
  df.temptemptemp <- df.temptemp %>% mutate(Tx = ifelse(Year >= Att & Att %notin% c(0, 2009, 2010), 1, 0)) %>% filter(!is.na(Tx)) #%>% filter(Att %notin% c(2011))
  colnames(df.temptemptemp)[(16+k)] <- "Outcome"
  # Winsorized
  outlier.vals <- quantile(df.temptemptemp$Outcome, p = c(0.01, 0.99), na.rm = TRUE)
  df.temptemptemp <- df.temptemptemp %>% 
    mutate(Outcome = ifelse(Outcome <= outlier.vals[1], outlier.vals[1], 
                            ifelse(Outcome >= outlier.vals[2], outlier.vals[2], Outcome)))
  model <-  did2s(
      data = df.temptemptemp, 
      yname = "Outcome", 
      treatment = "Tx",
        first_stage = ~ Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag | ID + Year , #Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.MCD + Pct.MCR + Pct.None | ID + Year , 
        second_stage = ~ i(year.rel, ref = FALSE),
        cluster_var = "ID",
      verbose = TRUE
    )


pretrends <- rbind(pretrends, cbind(Outcome = colnames(df.temptemp[,(16+k)]), model$coeftable))
}





pretrends <- pretrends[-1,]

rownames(pretrends)
ordering <- as.numeric(gsub(pattern = "year.rel::", replacement = "", rownames(pretrends)))



cbind(ordering, data.frame(pretrends))[order(ordering),] %>% 
  filter(ordering %in% c(-6:-2)) %>% 
  filter(Outcome %notin% c("htn.rate","dm.rate","pap.rate","crc.rate","childbmi.rate","adultbmi.rate")) %>% 
  arrange(`Pr...t..`) %>% 
  mutate(P.value = as.numeric(`Pr...t..`)) %>% 
  cbind(c(1:85) / 85 * 0.1) %>% 
  mutate(Row = row_number()) %>% 
  ggplot(aes(x = Row, y = P.value)) + geom_point() + 
  ylab("p-values") + xlab("Significance Rank") + geom_abline(slope = 1/85 * 0.1, intercept = 0, color="red", linetype="dashed", alpha=.5) + theme_minimal() + 
  geom_abline(slope = 1/85, intercept = 0, color="blue", linetype="dashed", alpha=.5)






```



## Stratified by Baseline Market Density

```{r}

coeffs.did.strat <- c(0,0,0,0, 0, 0, 0, 0)

for (k in 1:23){

  #df.temptemptemp <- df.temptemp %>% mutate(Tx = ifelse(Tx > 1, 1, 0)) %>% filter(!is.na(Tx)) #%>% group_by(ID) %>% mutate(EarlyHHI = first(ClinicHHI, na_rm = TRUE)) %>% filter(EarlyHHI < 9000)
  df.temptemptemp <- df.temptemp %>% mutate(Tx = ifelse(Year >= Att & Att %notin% c(0, 2009, 2010), 1, 0)) %>% filter(!is.na(Tx)) #%>% filter(Att %notin% c(2011))
  colnames(df.temptemptemp)[(16+k)] <- "Outcome"
  # Winsorized
  outlier.vals <- quantile(df.temptemptemp$Outcome, p = c(0.01, 0.99), na.rm = TRUE)
  df.temptemptemp <- df.temptemptemp %>% 
    mutate(Outcome = ifelse(Outcome <= outlier.vals[1], outlier.vals[1], 
                            ifelse(Outcome >= outlier.vals[2], outlier.vals[2], Outcome)))
  
   model <-  did2s(
      data = df.temptemptemp,
      yname = "Outcome",
      treatment = "Tx",
        first_stage = ~ Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag | ID + Year , #Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.MCD + Pct.MCR + Pct.None | ID + Year ,
        second_stage =~ i(Tx*ifelse(value_min== 1, 1, 0), ref = FALSE) + i(Tx*ifelse(value_min>=2, 1, 0), ref = FALSE),
        #second_stage =~ i(Tx, ref = FALSE) + I(as.numeric(Tx) * as.numeric(value_min)) ,
        cluster_var = "ID",
      verbose = TRUE
    )

  coeffs.did.strat <- rbind(coeffs.did.strat, c(model$coeftable[1,], model$coeftable[2,]))


}


core.did.estimates.strat <- data.frame(cbind(colnames(df.temptemp)[17:39], (coeffs.did.strat[-1,]))) %>%
  #select(V1, Estimate, Pr...t.., Estimate.1, Pr...t...1) %>%
  mutate(EstimateFirst = round(as.numeric(Estimate), 2), `95% CI First` = paste(round(as.numeric(Estimate) - 1.96 * as.numeric(Std..Error), 2), ", ", round(as.numeric(Estimate) + 1.96 * as.numeric(Std..Error), 2), sep = "")) %>%
  mutate(EstimateSecond = round(as.numeric(Estimate.1), 2), `95% CI Second` = paste(round(as.numeric(Estimate.1) - 1.96 * as.numeric(Std..Error.1), 2), ", ", round(as.numeric(Estimate.1) + 1.96 * as.numeric(Std..Error.1), 2), sep = "")) %>%
  select(V1, EstimateFirst, `95% CI First`, Pr...t.., EstimateSecond, `95% CI Second`, Pr...t...1)

core.did.estimates.strat <- core.did.estimates.strat
rownames(core.did.estimates.strat) <- NULL

core.did.estimates.strat[c(1, 2, 3, 4, 11:13, 16:23),] 

#   model <-  did2s(
#       data = df.temptemptemp,
#       yname = "Outcome",
#       treatment = "Tx",
#         first_stage = ~ Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag | ID + Year , #Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.MCD + Pct.MCR + Pct.None | ID + Year ,
#         second_stage =~ i(Tx*ifelse(value_min== 1, 1, 0), ref = FALSE) + i(Tx*ifelse(value_min==2, 1, 0), ref = FALSE) + i(Tx*ifelse(value_min>= 3, 1, 0), ref = FALSE),
#         cluster_var = "ID",
#       verbose = TRUE
#     )
# 
#   coeffs.did.strat <- rbind(coeffs.did.strat, c(model$coeftable[1,], model$coeftable[2,], model$coeftable[3,]))
# 
# 
# }
# 
# 
# core.did.estimates.strat <- data.frame(cbind(colnames(df.temptemp)[17:39], (coeffs.did.strat[-1,]))) %>%
#   #select(V1, Estimate, Pr...t.., Estimate.1, Pr...t...1) %>%
#   mutate(EstimateFirst = round(as.numeric(Estimate), 2), `95% CI First` = paste(round(as.numeric(Estimate) - 1.96 * as.numeric(Std..Error), 2), ", ", round(as.numeric(Estimate) + 1.96 * as.numeric(Std..Error), 2), sep = "")) %>%
#   mutate(EstimateSecond = round(as.numeric(Estimate.1), 2), `95% CI Second` = paste(round(as.numeric(Estimate.1) - 1.96 * as.numeric(Std..Error.1), 2), ", ", round(as.numeric(Estimate.1) + 1.96 * as.numeric(Std..Error.1), 2), sep = "")) %>%
#   mutate(EstimateMore = round(as.numeric(Estimate.2), 2), `95% CI More` = paste(round(as.numeric(Estimate.2) - 1.96 * as.numeric(Std..Error.2), 2), ", ", round(as.numeric(Estimate.2) + 1.96 * as.numeric(Std..Error.2), 2), sep = "")) %>%
#   select(V1, EstimateFirst, `95% CI First`, Pr...t.., EstimateSecond, `95% CI Second`, Pr...t...1, EstimateMore, `95% CI More`, Pr...t...2)
# 
# core.did.estimates.strat <- core.did.estimates.strat
# rownames(core.did.estimates.strat) <- NULL
# 
# core.did.estimates.strat[c(1, 2, 3, 4, 11:13, 16:23),]


df.temptemp %>% 
  mutate(Post = ifelse(year.rel >= 0, 1, 0)) %>% 
  filter(!is.na(value) & value_min > 1) %>% 
  group_by(Post, Treat) %>% 
  select(Closed) %>% 
  summarise(mean.nas, n())

df.temptemp %>% 
  mutate(Post = ifelse(year.rel >= 0, 1, 0)) %>% 
  filter(!is.na(value) & value_min > 1) %>% 
  group_by(Post, Treat) %>% 
  select(Closed) %>% 
  summarise(n())

df.temptemp %>% 
  filter(Tx == 1 & Closed == 100 & value > 2)
```





## Stratified figure instead of table 
```{r}

strat.temp <- coeffs.did.strat
strat.temp[3,] <- strat.temp[3,] / 1000
strat.temp[23,] <- strat.temp[23,] / 100
strat.temp[18,] <- strat.temp[18,] / 100



strat.temp <- (cbind(core.did.estimates.strat[,1], strat.temp[-1,c(1:2)]) %>% 
  data.frame() %>% 
  mutate(Estimate = as.numeric(Estimate), 
         `Std..Error` = as.numeric(Std..Error)) %>% 
  mutate(LB = Estimate - Std..Error * 1.96, 
         UB = Estimate + Std..Error * 1.96) %>% 
  rename(Outcome = V1) %>% 
  mutate(Class = "First Shock"))[c(1, 2, 3, 4, 11:13, 16:23),c(1,2, 4:6)] %>% 
  rbind((cbind(core.did.estimates.strat[,1], strat.temp[-1,c(5:6)]) %>% 
  data.frame() %>% 
  mutate(Estimate = as.numeric(Estimate), 
         `Std..Error` = as.numeric(Std..Error)) %>% 
  mutate(LB = Estimate - Std..Error * 1.96, 
         UB = Estimate + Std..Error * 1.96) %>% 
  rename(Outcome = V1) %>% 
  mutate(Class = "Multiple Shocks"))[c(1, 2, 3, 4, 11:13, 16:23),c(1,2, 4:6)]) 




strat.temp %>% 
  mutate(Measure = ifelse(Outcome %in% c("Qcomp","Total","Altman","logPatsPerStaff","Staff","Closed"), "Overall Metrics", 
                          ifelse(Outcome %in% c("Pct.MCD","Pct.None","Complexity","Intensity"), "Patient Mix", "Financials"))) %>% 
  
ggplot(aes(y=Outcome, x=Estimate, xmin=LB, xmax=UB)) +
geom_point() + 

#this changes the features of the overall effects
#one could resize, reshape, or recolor these points if desired
xlab("Effect Estimates") + 
ylab(NULL) + 
#adds the CIs
geom_errorbarh(height=.1) +

#sets the scales
#note that I reverse the y axis to correctly order the effect #sizes based on my index variable
#scale_x_continuous(limits=c(-2.5,1), breaks = c(-2.5:1), name=xname)+
#scale_y_continuous(name = "", breaks=1:9, labels = t9.forest$X1, trans="reverse")+

#adding a vertical line at the effect = 0 mark
geom_vline(xintercept=0, color="black", linetype="dashed", alpha= 1)+

#faceting based on my subgroups
  #facet_wrap(~X1) +
facet_grid(Measure~Class, scales= "free_y", switch = 'y', space = "free_y") +
 

#thematic stuff
#ggtitle("Figure 3 - ATT Estimates by SubGroups")+
theme_tufte_revised()+
   theme(strip.placement = "outside") +
#theme(text=element_text(family="Times",size=12, color="black"))+
theme(panel.spacing = unit(1, "lines"))


#core.did.estimates.strat[,1] <- c("Composite Quality of Care, %","Total Patients, No.","Financial Resilience","Operational Efficiency","Clinical Complexity","Intensity","Medicaid, %","Uninsured, %","Cost Per Patient")




```



## Compared to pre-2020 estimates
```{r}


coeffs.did.pre2020 <- c(0,0,0,0)

for (k in 1:23){

  #df.temptemptemp <- df.temptemp %>% mutate(Tx = ifelse(Tx > 1, 1, 0)) %>% filter(!is.na(Tx)) #%>% group_by(ID) %>% mutate(EarlyHHI = first(ClinicHHI, na_rm = TRUE)) %>% filter(EarlyHHI < 9000)
  df.temptemptemp <- df.temptemp %>% mutate(Tx = ifelse(Year >= Att & Att %notin% c(0, 2009, 2010), 1, 0)) %>% filter(!is.na(Tx) & Year < 2020) #%>% filter(Att %notin% c(2011))
  colnames(df.temptemptemp)[(16+k)] <- "Outcome"
  # Winsorized
  outlier.vals <- quantile(df.temptemptemp$Outcome, p = c(0.01, 0.99), na.rm = TRUE)
  df.temptemptemp <- df.temptemptemp %>% 
    mutate(Outcome = ifelse(Outcome <= outlier.vals[1], outlier.vals[1], 
                            ifelse(Outcome >= outlier.vals[2], outlier.vals[2], Outcome)))
  model <-  did2s(
      data = df.temptemptemp, 
      yname = "Outcome", 
      treatment = "Tx",
        first_stage = ~ Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag | ID + Year , #Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.MCD + Pct.MCR + Pct.None | ID + Year , 
        second_stage = ~ i(Tx, ref = FALSE),
        cluster_var = "ID",
      verbose = TRUE
    )


  coeffs.did.pre2020 <- rbind(coeffs.did.pre2020, model$coeftable[1,])
  

}


core.did.estimates.pre2020 <- data.frame(cbind(colnames(df.temptemp)[17:39], (coeffs.did.pre2020[-1,]))) %>% 
  #select(V1, Estimate, Pr...t.., Estimate.1, Pr...t...1) %>% 
  mutate(Estimate = round(as.numeric(Estimate), 2), `95% CI` = paste(round(as.numeric(Estimate) - 1.96 * as.numeric(`Std..Error`), 2), ", ", round(as.numeric(Estimate) + 1.96 * as.numeric(`Std..Error`), 2), sep = "")) %>% 
  select(V1, Estimate, `95% CI`, Pr...t..)

core.did.estimates.pre2020 <- core.did.estimates.pre2020
rownames(core.did.estimates) <- NULL



cbind(core.did.estimates, core.did.estimates.pre2020)


```


## Event Study

```{r}



es.direct <- did2s(
  data = df.temptemp %>% mutate(Tx = ifelse(Year >= Att & Att %notin% c(0, 2009, 2010), 1, 0)) %>% filter(!is.na(Tx))  %>% mutate(rel_year = ifelse(Att == 0, Inf, Year - Att)) %>% filter(Att == 0 | value_first == 1), 
  yname = "Qcomp", 
  treatment = "Tx",
  first_stage = ~ Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag | ID + Year, 
    second_stage = ~ i(rel_year, ref = c(-7, Inf)) ,
    cluster_var = "ID", 
  verbose = FALSE)

es.indirect <- did2s(
  data = df.temptemp %>% mutate(Tx = ifelse(Year >= Att & Att %notin% c(0, 2009, 2010), 1, 0)) %>% filter(!is.na(Tx))  %>% mutate(rel_year = ifelse(Att == 0, Inf, Year - Att)) %>% filter(Att == 0 | value_first >= 2), 
  yname = "Qcomp", 
  treatment = "Tx",
  first_stage = ~ Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag | ID + Year, 
    second_stage = ~ i(rel_year, ref = c(-7, Inf)) ,
    cluster_var = "ID", 
  verbose = FALSE)


cbind(YearRel = c(gsub("rel_year::", "", rownames(es.direct$coeftable)), gsub("rel_year::", "", rownames(es.indirect$coeftable))), 
      rbind(cbind(Group = "Direct",es.direct$coeftable), cbind(Group = "Indirect",es.indirect$coeftable))) %>% 
  data.frame() %>% 
  mutate(estimate = as.numeric(Estimate), 
         std.error = as.numeric(Std..Error), 
         YearRel = as.numeric(YearRel)) %>% 
  filter(abs(YearRel) <= 6) %>% 
 ggplot(aes(x = YearRel, y = estimate, color = Group)) + geom_point(position = position_dodge(0.9), size = 3) + geom_errorbar(aes(ymin=estimate-1.96*std.error, ymax=estimate+1.96*std.error), width=.25, position = position_dodge(0.9), size = 0.8)  +
  #facet_wrap(~V1, scales = "free_y", ncol = 3) +
  theme_tufte_revised() + geom_vline(xintercept=-0.5, color="blue", linetype="dashed", alpha=.6)+ #theme(legend.position = "none", plot.title = element_text(size=18, face='bold')) +
  geom_hline(yintercept=0, color="black", linetype="dashed", alpha=.5) + xlab("Year Relative to Competitive Shock") + ylab("Percentage Points")


```





## BY Hand
```{r}

## TWFE First Stage
df.temptemptemp <- df.temptemp %>% select(ClinicHHI, Qcomp, MS, value, Year, ID, Pct.NHA:Pct.None, Tx, UrbanRuralFlag) %>% ungroup() %>% filter(complete.cases(.))

reduced <- lm(data = df.temptemptemp, Qcomp ~ value + factor(Year) + factor(ID) + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag )
firststage <- lm(data = df.temptemptemp, I((10000 - ClinicHHI)/1000) ~ value + factor(Year) + factor(ID) + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless+ UrbanRuralFlag )


model <- lm(data = df.temptemptemp, Complexity ~ firststage$fitted.values + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag+ factor(Year) + factor(ID))

m1coeffs_cl <- coeftest(model, vcov = vcovCL, cluster = ~ID)





# ## Callaway-Sant'Anna First Stage
# 
# example_attgt <- att_gt(yname = "ClinicHHI",
#                         tname = "Year",
#                         idname = "ID",
#                         gname = "Att",
#                         xformla = ~Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless,
#                         data = df.temptemp, 
#                         clustervars = "ID"
#                         )
# 
# # summarize the results
# aggte(example_attgt)


```




## Basic Linear Reg
```{r}

reduced <- lm(data = df.temptemptemp, Qcomp ~ value + factor(Year) + factor(ID) + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag )
head(summary(reduced)$coeff) %>% as.data.frame()

reduced <- lm(data = df.temptemptemp, Complexity ~ value + factor(Year) + factor(ID) + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag )
head(summary(reduced)$coeff) %>% as.data.frame()

# reduced <- lm(data = df.temptemptemp, Closed ~ value + factor(Year) + factor(ID) + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag )
# head(summary(reduced)$coeff) %>% as.data.frame()



```



## Why are the signs funky? 
We are likely picking up shifting trends in the level differences across values. 

```{r}
df.temptemp %>% #left_join(df.temptemp %>% filter(Tx == 1) %>% summarise(Att = min(Year)), by = c("ID")) %>% 
               mutate(Att = ifelse(is.na(Att), 0, Att)) %>% 
  mutate(value = ifelse(value >= 6, 6, value)) %>% 
  group_by(value, Year) %>% 
  summarise(HHI = mean(ClinicHHI, na.rm = TRUE)) %>% 
  ggplot(aes(x = Year, y = HHI, group = value, color = as.factor(value))) + geom_point() + geom_line()


df.temptemp %>% #left_join(df.temptemp %>% filter(Tx == 1) %>% summarise(Att = min(Year)), by = c("ID")) %>% 
               mutate(Att = ifelse(is.na(Att), 0, Att)) %>% 
  mutate(value = ifelse(value >= 6, 6, value)) %>% 
  group_by(value, Year) %>% 
  summarise(Quality = mean(Qcomp, na.rm = TRUE)) %>% 
  ggplot(aes(x = Year, y = Quality, group = value, color = as.factor(value))) + geom_point() + geom_line()
```





## Closures? Mergers? 

```{r}

df.temptemp %>% 
  filter(Closed == 100 & !is.na(Tx)) %>% 
  select(ModernGranteeID, `BHCMIS ID`, Year)
  
H80CS00003
```





## Changes in geographic distribution of resources by Distance to competitive zip

```{r}

## Treatment vs control, only in zip code of interest
df.z <- left_join(df.temptemp, 
                  #uds.zip %>% mutate(Zip = `ZipCode`) %>% select(`BHCMISID`, Zip) %>% unique() , by = c("BHCMIS ID" = "BHCMISID")) %>%
                  uds.sites.full[!is.na(uds.sites.full$Zip),] %>% filter(Year %in% c(2010:2023)) %>% select(`BHCMIS ID`, Zip) %>% unique() %>% filter(!is.na(Zip)), by = c("BHCMIS ID")) %>%
  left_join(uds.zip, by = c("BHCMIS ID" = "BHCMISID", "Year" = "ReportingYear", "Zip" = "ZipCode")) %>%
  
  ungroup() %>% 
  ###### MAJOR CHANGE: remove those CHCS wtih missing market share MS from GrantNumber
 #filter(!is.na(`MS`)) %>% 
  left_join(clinics.in.zips %>% select(Zip:Clinics), by = c("Zip","Year")) %>%
  rename(ID.chc = ID) %>% 
  mutate(Tx.z = ifelse(Clinics == 1 , 0, 
                ifelse(is.na(Clinics), NA, 1)), # | is.na(Clinics)
         ID = as.numeric(factor(paste(`BHCMIS ID`, Zip, sep = "-")))) %>%
  select(`BHCMIS ID`:Year, Att, ID, Zip:Tx.z, UrbanRuralFlag) %>%
  arrange(`BHCMIS ID`, Zip, Year) %>% 
  unique() #%>%  inner_join(df.qual.exp %>% filter(Year == 2015 & Total > 12050) %>% select(`Grant Number`), by = c("Grant Number"))  #& Zips < 3.75 or 4.75
  # %>%   filter(MarketShare > median(MarketShare, na.rm = TRUE) - 0.25) 

length(unique(df.z$ID))



df.z <- df.z %>% 
  left_join(df.z %>%
            filter(Tx.z == 1) %>%
            group_by(ID, Zip) %>%
            summarise(Att.z = min(Year)), by = c("ID", "Zip")) %>%
  mutate(Att.z = ifelse(is.na(Att.z), 0, Att.z)) #%>%
# inner_join(df.z %>% filter(!is.na(Clinics)) %>% group_by(ID) %>% summarise(n()) %>% filter(`n()` == length(unique(df.qual.exp$Year))), by = c("ID")) #%>% filter(Att == Att.z)


length(unique(df.z$ID))

df.z <- df.z %>% 
    left_join(uds.sites.full %>% 
              filter(`Location Setting` %in% c("All Other Clinic Types")) %>% 
              #filter(`Location Setting` %in% c("All Other Clinic Types","School") | is.na(`Location Setting`)) %>% 
              mutate(Type.num = ifelse(`Location Type` == "Seasonal", 0.33, 
                                ifelse(`Location Type` == "Mobile Van", 0.66, 1)), 
                     Schedule = ifelse(`Operational Schedule` == "Full-Time", 1, 
                                ifelse(`Operational Schedule` == "Part-Time", 0.5, 0)),
                     Calendar = ifelse(`Calendar Schedule` == "Year-Round", 1,
                                ifelse(`Calendar Schedule` == "Seasonal", 0.5, 0))) %>% 
              group_by(`BHCMIS ID`, Year, Zip) %>% 
              summarise(Sites = n(), Mean.Hours = mean(Access, na.rm = TRUE), Total.Hours = sum(Access, na.rm = TRUE), 
                        Perminance = sum(Type.num, na.rm = TRUE), Schedule = sum(Schedule, na.rm = TRUE), Calendar = sum(Calendar, na.rm = TRUE)), by = c("BHCMIS ID","Year", "Zip")) %>% 
  mutate(Sites = ifelse(is.na(Sites), 0, Sites), 
         Mean.Hours = ifelse(is.na(Mean.Hours), 0, Mean.Hours), 
         Total.Hours = ifelse(is.na(Total.Hours), 0, Total.Hours), 
         Perminance = ifelse(is.na(Perminance), 0, Perminance), 
         Schedule = ifelse(is.na(Schedule), 0, Schedule), 
         Calendar = ifelse(is.na(Calendar), 0, Calendar))

df.z <- df.z %>% 
  left_join(df.zip.totals, by = c("Zip" = "ZipCode","Year" = "ReportingYear")) %>% 
  mutate(MS = 100 - (NumberofPatients / Totals * 100)) %>% 
  left_join(df.zip.HHI, by = c("BHCMIS ID" = "BHCMISID","Year" = "ReportingYear","Zip" = "ZipCode"))



```

## Spatial Analysis

```{r}


df.z.temp <- df.z %>% mutate(Tx = ifelse(Year >= Att & Att %notin% c(0, 2009, 2010), 1, 0)) %>% #mutate(Tx = ifelse(value - 1 >= 1, 1, value - 1)) %>% 
  filter(!is.na(Tx)) %>% mutate(DirectlyTreated = ifelse(Att.z >= 2010, 1, 0)) %>% 
  #df.z %>% mutate(Tx = ifelse(value - 1 > 1, 1, value - 1)) %>% filter(!is.na(Tx)) %>% mutate(DirectlyTreated = ifelse(Att.z > 2010, 1, 0)) %>% 
  filter(!(Att == 0 & DirectlyTreated == 1)) %>% 
        mutate(Pct.MCD = Medicaid / NumberofPatients * 100, 
               Pct.MCR = Medicare / NumberofPatients * 100, 
               Pct.COM = Private / NumberofPatients * 100,
               Pct.None = Uninsured / NumberofPatients * 100 ) %>% 
  select(NumberofPatients, Pct.MCD:Pct.None, Total.Hours, Sites, Mean.Hours, ZipHHI, Perminance, Schedule, Calendar, Tx, DirectlyTreated, ID, Year, Zip, Att, `BHCMIS ID`, UrbanRuralFlag) %>% 
  ### DATA ERRORS
  filter(Total.Hours <= 1344.00)

 
coeffs <- c(0,0,0,0, 0, 0, 0, 0)

for (k in 1:9){

  df.z.temp2 <- df.z.temp %>% filter(Year >= 2012) #%>% 
  #   inner_join(df.z.temp %>%
  # filter(Year >= 2012) %>%
  # select(ID) %>%
  # group_by(ID) %>%
  # summarise(Counts = n()) %>%
  # filter(Counts == 12), by = c("ID"))
  
  
  #%>% filter(Att == 0 | Att > 2010)
  
  
  
  df.z.temp2 <- df.z.temp %>% filter(Year >= 2012) %>% filter(Att %notin% c(2009:2012))
  
  
  colnames(df.z.temp2)[k] <- "Outcome"
  
  
  # 
  #   outlier.vals <- quantile(df.z.temp2$Outcome, p = c(0.005, 0.995), na.rm = TRUE)
  # df.z.temp2 <- df.z.temp2 %>% 
  #   mutate(Outcome = ifelse(Outcome <= outlier.vals[1], outlier.vals[1], 
  #                           ifelse(Outcome >= outlier.vals[2], outlier.vals[2], Outcome)))
  
  
  
  model <-  did2s(
      data = df.z.temp2, 
      yname = "Outcome", 
      treatment = "Tx",
        first_stage = ~ 1 | ID + Year , #Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.MCD + Pct.MCR + Pct.None | ID + Year , 
        second_stage = ~ i(Tx * (1 - DirectlyTreated), ref = FALSE)  + I(Tx * DirectlyTreated),
      #second_stage = ~ i(Tx , ref = FALSE)  + I(Tx * DirectlyTreated),
        cluster_var = "ID",
      verbose = TRUE
    )


  coeffs <- rbind(coeffs, c(model$coeftable[2,], model$coeftable[1,]))

}


zip.estimates <- data.frame(cbind(colnames(df.z.temp)[1:9], (coeffs[-1,]))) %>% 
  #select(V1, Estimate, Pr...t.., Estimate.1, Pr...t...1) %>% 
  mutate(Estimate = round(as.numeric(Estimate), 2), `95% CI` = paste(round(as.numeric(Estimate) - 1.96 * as.numeric(`Std..Error`), 2), ", ", round(as.numeric(Estimate) + 1.96 * as.numeric(`Std..Error`), 2), sep = "")) %>% 
  mutate(Estimate.1 = round(as.numeric(Estimate.1), 2), `95% CI.1` = paste(round(as.numeric(Estimate.1) - 1.96 * as.numeric(`Std..Error.1`), 2), ", ", round(as.numeric(Estimate.1) + 1.96 * as.numeric(`Std..Error.1`), 2), sep = "")) %>% 
  select(V1, Estimate, `95% CI`, `Pr...t..`, Estimate.1, `95% CI.1`, `Pr...t...1`)

zip.estimates <- zip.estimates[c(9, 1, 6, 2:5, 7:8),]
rownames(zip.estimates) <- NULL

zip.estimates %>% 
  kable("html", booktabs = T, col.names = c("Outcome","Estimate","95% CI","p-value", "Estimate","95% CI", "p-value")) %>% 
  kable_styling(latex_options = c("striped")) %>%
  pack_rows(index = c("Overall Impacts" = 3, "Patient and Payer Mix" = 4, "Access" = 2)) %>% 
  add_header_above(c(" " = 1, "Directly Competitive" = 3, "Indirectly Competitive" = 3)) %>% 
  add_header_above(c("DID-Estimated Effects of Competitive Shocks on Zip Codes in Incumbent Clinics' Service Area" = 7))

## WATCH OUT FOR THE INTERACTION INTERPRETATION


did2s(
      data = df.z.temp2 %>% filter(Year >= 2012)   %>% mutate(rel_year = ifelse(Att == 0, Inf, Year - Att)) %>% left_join(df.temptemp %>% ungroup() %>% select(`BHCMIS ID`, value_min, value_first) %>% unique(), by = c("BHCMIS ID")) 
      %>% filter(Att == 0 | DirectlyTreated == 0), 
      yname = "Sites", 
      treatment = "Tx",
        first_stage = ~ 0 | ID + Year , #Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.MCD + Pct.MCR + Pct.None | ID + Year , 
        second_stage = ~ i(Tx*ifelse(value_first==1, 1, 0), ref = FALSE) + i(Tx*ifelse(value_first>=2, 1, 0), ref = FALSE),
        cluster_var = "ID",
      verbose = TRUE
    )

```
## Back of the envelop

```{r}



asdf <- df.z.temp %>% 
  filter(Year == 2012) %>% 
  filter(Att > 0) %>% 
  group_by(DirectlyTreated) %>% 
  summarise(Counts = n(), Hours = mean.nas(Total.Hours)) %>% 
  cbind(Changes = c(zip.estimates[3,5], zip.estimates[3,2])) %>% 
  summarise(Num = abs(Changes * Counts), Denom = Hours * Counts) %>% 
  colSums()
  

asdf[1] / asdf[2]
  

```



## Sites and Zips per clinic
```{r}

df.z.temp %>% 
  filter(Year == 2012) %>% 
  mutate(Treat = ifelse(Att > 0, 1, 0)) %>% 
  group_by(`BHCMIS ID`) %>% #, Treat
  filter(Sites > 0) %>% 
  summarise(Zips = n(), Sites = sum(Sites, na.rm = TRUE)) %>% 
  ungroup() %>% 
  #group_by(Treat) %>% 
  summarise(mean(Zips), mean(Sites))


  

```



## Event Study

```{r}

es.direct <- did2s(
  data = df.z.temp %>% filter(Year >= 2012)   %>% mutate(rel_year = ifelse(Att == 0, Inf, Year - Att)) %>% filter(Att == 0 | DirectlyTreated == 1), 
  yname = "Sites", 
  treatment = "Tx",
  first_stage = ~ 0 | ID + Year, 
    second_stage = ~ i(rel_year, ref = c(-7, Inf)) ,
    cluster_var = "ID", 
  verbose = FALSE)

es.indirect <- did2s(
  data = df.z.temp%>% filter(Year >= 2012)   %>% mutate(rel_year = ifelse(Att == 0, Inf, Year - Att)) %>% filter(Att == 0 | DirectlyTreated == 0), 
  yname = "Sites", 
  treatment = "Tx",
  first_stage = ~ 0 | ID + Year, 
    second_stage = ~ i(rel_year, ref = c(-7, Inf)) ,
    cluster_var = "ID", 
  verbose = FALSE)


cbind(YearRel = c(gsub("rel_year::", "", rownames(es.direct$coeftable)), gsub("rel_year::", "", rownames(es.indirect$coeftable))), 
      rbind(cbind(Group = "Direct",es.direct$coeftable), cbind(Group = "Indirect",es.indirect$coeftable))) %>% 
  data.frame() %>% 
  mutate(estimate = as.numeric(Estimate), 
         std.error = as.numeric(Std..Error), 
         YearRel = as.numeric(YearRel)) %>% 
  filter(abs(YearRel) <= 6) %>% 
 ggplot(aes(x = YearRel, y = estimate, color = Group)) + geom_point(position = position_dodge(0.9), size = 3) + geom_errorbar(aes(ymin=estimate-1.96*std.error, ymax=estimate+1.96*std.error), width=.25, position = position_dodge(0.9), size = 0.8)  +
  #facet_wrap(~V1, scales = "free_y", ncol = 3) +
  theme_tufte_revised() + geom_vline(xintercept=-0.5, color="blue", linetype="dashed", alpha=.6)+ #theme(legend.position = "none", plot.title = element_text(size=18, face='bold')) +
  geom_hline(yintercept=0, color="black", linetype="dashed", alpha=.5) + xlab("Year Relative to Competitive Shock") + ylab("Percentage Points")


```




## Are the closer and farther areas different?
```{r}

df.z.temp %>% 
  #select(Zip, Year, DirectlyTreated, Att) %>% 
  mutate(Status = ifelse(Att == 0, NA, 
                         ifelse(Att > 0 & DirectlyTreated == 0, "IndirectlyTreated","DirectlyTreated"))) %>% 
  inner_join(census, by = c("Zip" = "ZipCode", "Year" = "YEAR")) %>% 
  filter(Year == 2012) %>% 
  mutate(PctMedicaid = Medicaid / MCD.denom * 100, 
         PctUninsured = Uninsured / Unins.denom * 100, 
         PctPoverty = IncomeBelowPoverty / PovertyStatusDet * 100, 
         PctUnemployed = Unemployed / Unemp_denom * 100, 
         PctBlack = Black / TotalPop * 100, 
         PctHispanic = Hispanic / TotalPop * 100, 
         PctChildren = AgeUnder18 / TotalPop * 100, 
         PctElderly = Age65andOver / TotalPop * 100, 
         PctEducLow = EducLow / TotalPop * 100) %>% 
    select(Status, TotalPop, PctMedicaid:PctEducLow, UrbanRuralFlag) %>% 
    tbl_summary(by = Status, 
                statistic = list(all_continuous() ~ "{mean} ({sd})"), missing = "no") %>% 
  add_p()
  


```






## Auditing

```{r}

df.z.temp %>% 
  select(`BHCMIS ID`, Year, Zip, Att, DirectlyTreated)

uds.sites.full %>% 
  filter(Zip == "02301") %>% 
  select(Year, `BHCMIS ID`) %>% 
  unique() %>% 
  filter(Year >= 2010) %>% 
  arrange(Year, `BHCMIS ID`)

df.z %>% mutate(Tx = ifelse(value - 1 >= 1, 1, value - 1)) %>% filter(!is.na(Tx)) %>% mutate(DirectlyTreated = ifelse(Att.z >= 2010, 1, 0))


```





# Distance Intrustment



```{r}

## Treatment vs control, only in zip code of interest
df.z <- left_join(df.temptemp, 
                  #uds.zip %>% mutate(Zip = `ZipCode`) %>% select(`BHCMISID`, Zip) %>% unique() , by = c("BHCMIS ID" = "BHCMISID")) %>%
                  uds.sites.full[!is.na(uds.sites.full$Zip),] %>% filter(Year %in% c(2010:2021)) %>% select(`BHCMIS ID`, Zip) %>% unique() %>% filter(!is.na(Zip)), by = c("BHCMIS ID")) %>%
  left_join(uds.zip, by = c("BHCMIS ID" = "BHCMISID", "Year" = "ReportingYear", "Zip" = "ZipCode")) %>%
  filter(!is.na(GrantNumber)) %>% 
  left_join(clinics.in.zips %>% select(Zip:Clinics), by = c("Zip","Year")) %>%
  mutate(Tx.z = ifelse(Clinics == 1 , 0, 
                ifelse(is.na(Clinics), NA, 1)), # | is.na(Clinics)
         ID = as.numeric(factor(paste(`BHCMIS ID`, Zip, sep = "-")))) %>%
  select(`BHCMIS ID`:Year, Att, ID, Zip:Tx.z, Tx, UrbanRuralFlag) %>%
  arrange(`BHCMIS ID`, Zip, Year) %>% 
  unique() #%>%  inner_join(df.qual.exp %>% filter(Year == 2015 & Total > 12050) %>% select(`Grant Number`), by = c("Grant Number"))  #& Zips < 3.75 or 4.75
  # %>%   filter(MarketShare > median(MarketShare, na.rm = TRUE) - 0.25) 

df.z <- df.z %>% 
  left_join(df.z %>%
            filter(Tx.z == 1) %>%
            group_by(ID, Zip) %>%
            summarise(Att.z = min(Year)), by = c("ID", "Zip")) %>%
  mutate(Att.z = ifelse(is.na(Att.z), 0, Att.z)) #%>%
# inner_join(df.z %>% filter(!is.na(Clinics)) %>% group_by(ID) %>% summarise(n()) %>% filter(`n()` == length(unique(df.qual.exp$Year))), by = c("ID")) #%>% filter(Att == Att.z)


## Whole zip as one measure

df.z.full <- df.z %>% ############## NOTE: Original +500 effect was recoved with Att.z, not Att
  select(Zip, Att.z, Year) %>% 
  unique() %>% 
  left_join(uds.zip, by = c("Zip" = "ZipCode", "Year" = "ReportingYear")) %>% 
  left_join(df.temptemp %>% 
            select(`BHCMIS ID`, Year, Qcomp), by = c("BHCMISID" = "BHCMIS ID", "Year")) %>% 
  group_by(Zip, Year, Att.z) %>% 
  summarise(
    Total.z = sum(NumberofPatients, na.rm = TRUE), 
    Quality.z = sum(NumberofPatients * Qcomp, na.rm = TRUE) / Total.z) %>% 
  ungroup() %>% 
  mutate(ID = as.numeric(as.factor(Zip)))# %>% group_by(`Grant Number`, Year, Att) %>% summarise(ID = min(ID), Total.z = sum(Total.z, na.rm = TRUE)) # %>% filter(Year > 2015),


df.zip.1 <- df.z %>% select(ID, Year, Att, NumberofPatients, UrbanRuralFlag)
df.zip.2 <- df.z.full %>% select(ID, Year, Att.z, Total.z:Quality.z)


```



## Edit Centroids

```{r}
## Read in Centroid Data
zip.centroids <- read.csv("/Users/markow/Dropbox/Git/Data/ZIP_Code_Population_Weighted_Centroids.csv") %>% 
  mutate(ZipCode = str_pad(STD_ZIP5, 5, pad = "0")) %>% 
  select(ZipCode, X, Y)
## Add missing centroids
zip.centroids <- rbind(zip.centroids, c(ZipCode = "37243", X = -86.783, Y = 36.165), 
                                      c(ZipCode = "95951", X = -121.98, Y = 39.73), 
                                      c(ZipCode = "99733", X = -144.166941, Y = 65.799773), 
                       
                                      c(ZipCode = "04341", X = -69.4277, Y = 55.3255), 
                                      c(ZipCode = "04935", X = -69.5995, Y = 44.5884)
                      ) %>% 
  mutate(X = as.numeric(X), Y = as.numeric(Y))
```



## Describe where the rivals came from
```{r}

## Distance of Competitor to New Site
df.z.dist <- df.z.full %>% 
  filter(Att.z == Year) %>% 
  select(Zip:Total.z) %>% 
  left_join(uds.sites.full %>% select(`BHCMIS ID`, Year, Zip) %>% unique(), by = c("Zip","Year")) %>% 
  left_join(df.z %>% filter(Tx == 1) %>% select(`BHCMIS ID`, Year, Zip) %>% unique(), by = c("Zip","Year")) %>% 
  filter(`BHCMIS ID.x` != `BHCMIS ID.y`) 



df.z.dist <- df.z.dist %>% mutate(DistToClosestSite = NA, ZipOfClosestSite = NA)

for (g in 1:nrow(df.z.dist)){
#g <- 1
 temp <- rbind(zip.centroids %>% filter(ZipCode == df.z.dist[g,]$Zip), 
          zip.centroids %>% filter(ZipCode %in% unique(uds.sites.full[uds.sites.full$`BHCMIS ID` == df.z.dist[g,]$`BHCMIS ID.x` & uds.sites.full$Year == df.z.dist[g,]$Year,]$Zip))) %>% 
   unique()
  mm <- as.matrix(dist(as.matrix(temp$X, temp$Y), method = "euclidean"))[-1,1]
  df.z.dist[g,]$DistToClosestSite <-  min(mm) * 111.139
  df.z.dist[g,]$ZipOfClosestSite  <- ifelse(is.na(temp[2,]$ZipCode), temp[1,]$ZipCode, unlist(temp[-1,]$ZipCode[rank(mm) == 1]))
}

#df.z.dist[19,]$DistToClosestSite <- 0
df.z.dist <- df.z.dist %>% 
  filter(!is.infinite(DistToClosestSite))

df.z.dist <- df.z.dist %>% 
  inner_join(df.z.dist %>% group_by(`BHCMIS ID.y`) %>% summarise(Att.z = min(Att.z)), by = c("BHCMIS ID.y", "Att.z")) %>% 
  unique()

mean(df.z.dist$DistToClosestSite)
quantile(df.z.dist$DistToClosestSite, probs = c(0, 0.1, 0.25, 0.5, 0.75, 0.9, 1))

# mean(df.z.dist[df.z.dist$ZipFilter == 1,]$DistToClosestSite)
# mean(df.z.dist[df.z.dist$ZipFilter == 2,]$DistToClosestSite)
# 
# quantile(df.z.dist[df.z.dist$ZipFilter == 1,]$DistToClosestSite, probs = c(0, 0.1, 0.25, 0.5, 0.75, 0.9, 1))
# quantile(df.z.dist[df.z.dist$ZipFilter == 2,]$DistToClosestSite, probs = c(0, 0.1, 0.25, 0.5, 0.75, 0.9, 1))


zipsize <- zctas(starts_with = c(df.z.dist$Zip, df.z.dist$ZipOfClosestSite), year = 2010)


## Original Figure
df.z.dist.plot <- df.z.dist %>% 
  left_join(zipsize %>% select(GEOID10, ALAND10), by = c("Zip" = "GEOID10")) %>% 
  left_join(uds.sites.full %>% select(Zip, `Site State`) %>% unique(), by = c("Zip")) %>% 
  left_join(census %>% select(ZipCode, YEAR, TotalPop), by = c("Year" = "YEAR", "Zip" = "ZipCode")) %>% 
  arrange(desc(DistToClosestSite)) %>% 
  mutate(Area.SQmiles = ALAND10 / 2.59e6) %>% 
  mutate(Density.NewZip = TotalPop / Area.SQmiles, 
         l.density = log(TotalPop / Area.SQmiles)) %>% 
  unique()



df.z.dist.plot %>% 
  ggplot(aes(x = log(Density.NewZip), y = DistToClosestSite)) + geom_point(aes(size = Area.SQmiles)) +
  ggtitle("Distance from Rival's newly competing zip ocde to closest incumbent zip code by Density and Area of newly competing zip code")

summary(lm(DistToClosestSite ~ log(Density.NewZip), data = df.z.dist.plot))



# Updated Figure
df.z.dist.plot <- df.z.dist.plot %>% 
  select(Zip:ZipOfClosestSite, Density.NewZip) %>% 
  left_join(zipsize %>% select(GEOID10, ALAND10), by = c("ZipOfClosestSite" = "GEOID10")) %>% 
  left_join(uds.sites.full %>% select(Zip, `Site State`) %>% unique(), by = c("ZipOfClosestSite" = "Zip")) %>% 
  left_join(census %>% select(ZipCode, YEAR, TotalPop), by = c("Year" = "YEAR", "ZipOfClosestSite" = "ZipCode")) %>% 
  arrange(desc(DistToClosestSite)) %>% 
  mutate(Area.SQmiles = ALAND10 / 2.59e6) %>% 
  mutate(Density.Origin = TotalPop / Area.SQmiles)


df.z.dist.plot %>% 
  ggplot(aes(x = log(Density.NewZip), y = DistToClosestSite, color = log(Density.Origin))) + geom_point() +
  scale_colour_gradientn(colours = terrain.colors(10))+ theme_minimal()+
  ylab("Distance from Competative to closest Rival Site (km)") +
  ggtitle("Distance from newly competative Zip to Rival's closest existing zip, by log Density of areas")


p <- df.z.dist.plot %>% 
  filter(!is.na(Density.NewZip) & !is.na(Density.Origin)) %>% 
  #filter(DistToClosestSite < 25) %>% 
  ggplot(aes(x = log(Density.Origin), y = log(Density.NewZip))) + 
  geom_point(aes(size = DistToClosestSite, colour = DistToClosestSite)) + 
  scale_colour_gradientn(colours = c("green","lightblue","purple"),
                         values = c(1.0,0.7,0.1,0))  +#scale_colour_gradientn(colours = terrain.colors(10))+ 
  theme_minimal() + ylab("Log Population Density of Newly Competitive Zip Code") + 
  xlab("Log Population Density of Nearest Zip Code in Rival's Service Area") + 
  labs(color = "Distance Travelled to\nOpen New Site (km)") + 
  ggtitle("Population Density and Distance Rival Traveled to Open Competitive Care Delivery Location") + 
  #guides(size = FALSE) + 
  xlim(0, 12) + ylim(0, 12) + 
theme_tufte_revised()
p


p <- df.z.dist.plot %>% 
  filter(!is.na(Density.NewZip) & !is.na(Density.Origin)) %>% 
  #filter(DistToClosestSite < 25) %>% 
  ggplot(aes(x = log(Density.Origin), y = log(Density.NewZip))) + 
  geom_point(aes(colour = DistToClosestSite, alpha = sqrt(DistToClosestSite)), size = 3) + 
  scale_color_viridis(option = "D", direction = -1) + 
  scale_colour_gradientn(colours = c("brown","darkorange", "gold","darkgreen"),
                         values = c(1.0,0.7,0.3, 0.1,0)) + 
  #scale_colour_gradientn(colours = c("green","royalblue","purple"),
  #                       values = c(1.0,0.7,0.2, 0))  +#scale_colour_gradientn(colours = terrain.colors(10))+ 
  theme_minimal() + ylab("Log Population Density of Newly Competitive Zip Code") + 
  xlab("Log Population Density of Nearest Zip Code in Rival's Service Area") + 
  labs(color = "Distance Travelled to\nOpen New Site (km)") + 
  ggtitle("Population Density and Distance Rival Traveled to Open Competitive Care Delivery Location") + 
  guides(alpha = FALSE) + 
  xlim(0, 12) + ylim(0, 12) + 
theme_tufte_revised()
p


# p <- df.z.dist.plot %>% 
#   filter(!is.na(Density.NewZip) & !is.na(Density.Origin)) %>% 
#   #filter(DistToClosestSite < 25) %>% 
#   ggplot(aes(x = log(Density.Origin), y = log(Density.NewZip))) + 
#   geom_point(aes(colour = DistToClosestSite, alpha = sqrt(DistToClosestSite), size = DistToClosestSite)) + 
#   scale_color_viridis(option = "D", direction = -1) + 
#   scale_colour_gradientn(colours = c("brown","darkorange", "gold","darkgreen"),
#                          values = c(1.0,0.7,0.3, 0.1,0)) + 
#   #scale_colour_gradientn(colours = c("green","royalblue","purple"),
#   #                       values = c(1.0,0.7,0.2, 0))  +#scale_colour_gradientn(colours = terrain.colors(10))+ 
#   theme_minimal() + ylab("Log Population Density of Newly Competitive Zip Code") + 
#   xlab("Log Population Density of Nearest Zip Code in Rival's Service Area") + 
#   labs(color = "Distance Travelled to\nOpen New Site (km)", size = "Distance Travelled to\nOpen New Site (km)") + 
#   ggtitle("Population Density and Distance Rival Traveled to Open Competitive Care Delivery Location") + 
#   guides(alpha = FALSE) + 
#   xlim(0, 12) + ylim(0, 12) + 
# theme_tufte_revised()
# p




ggsave(filename = "Figure2.png", path = "/Users/markow/Dropbox/Writing/CHC Competitive Shocks/Figures", plot = p, width = 11, height = 8)

summary(lm(log(Density.NewZip) ~ log(Density.Origin) * I(DistToClosestSite / 10), data = df.z.dist.plot))

df.z.dist.plot %>% 
  arrange(desc(DistToClosestSite)) %>% 
  select(ZipOfClosestSite) %>% unlist()

quantile(df.z.dist.plot$DistToClosestSite)
quantile(df.z.dist.plot$DistToClosestSite, probs = 0.95)

nrow(df.z.dist.plot[df.z.dist.plot$DistToClosestSite < 16.09,])/nrow(df.z.dist.plot)
hist(df.z.dist.plot$DistToClosestSite, breaks = 50, xlim = c(0, 100))

df.z.dist.plot[df.z.dist.plot$DistToClosestSite > 16.09,] %>% 
  summarise(median((Density.NewZip), na.rm = TRUE), median((Density.Origin), na.rm = TRUE)) %>% 
  unlist()


df.z.dist.plot[df.z.dist.plot$DistToClosestSite > 16.09,] %>% 
  left_join(df.temptemp %>% filter(Year == 2011), by = c("BHCMIS ID.y" = "BHCMIS ID"))





df.z.dist %>% 
  arrange(DistToClosestSite) %>% 
  ggplot(aes(x=DistToClosestSite)) + 
  geom_histogram(binwidth = 1, fill="lightgrey", color="white") + 
  xlim(0, 100) +
  stat_bin(aes(y=cumsum(..count..)/sum(..count..)*100 *3/2), binwidth = 1, geom="line", color="blue") + 
  scale_y_continuous(name = 'Number of Rivals', 
                     sec.axis = sec_axis(~.*2/3, name = "Cumulative percentage (%)")) + 
  theme_tufte_revised() + 
  ggtitle("FQHC Rivals by Distance from Service Area to New Competitive Zip") + 
  xlab("Distance Travelled (km)")

```



## Find distance to rival for all CHCs in sample

```{r}


zipdist <- uds.zip %>% 
  filter(ReportingYear == 2012) %>% 
  select(BHCMISID, GrantNumber, ZipCode) %>% 
  unique() %>% 
  left_join(df.z.temp %>% filter(Year == 2012), by = c("BHCMISID" = "BHCMIS ID", "ZipCode" = "Zip")) %>% 
  filter(is.na(ID)) %>% 
  select(`BHCMISID`:ZipCode) %>% 
  left_join(uds.zip %>% filter(ReportingYear ==2012), by = c("ZipCode")) %>% 
  select(ZipCode, BHCMISID.x, BHCMISID.y) %>% 
  filter(BHCMISID.x != BHCMISID.y)
  

## This next line takes a minute to run
zipdist <- df.z.temp %>%
  left_join(zipdist %>%
  select(BHCMISID.x, ZipCode) %>%
  unique(), by = c("BHCMIS ID" = "BHCMISID.x")) %>%
  select(`BHCMIS ID`, Zip, Att, DirectlyTreated, Tx, ZipCode, UrbanRuralFlag) %>%
  unique()



zipdist <- zipdist %>% 
  #group_by(`BHCMIS ID`) %>% 
  mutate(CountingIDs = as.numeric(as.factor(`BHCMIS ID`))) %>% 
  group_by(CountingIDs)



zipdist <- zipdist %>% mutate(DistToClosestSite = NA, ZiplevelDistToClosestSite = NA, DistToFarthestSite = NA)

for (g in c(1:695, 697:795, 797:800, 802:847, 849:852)){ 
  
  temp1 <- zipdist %>% 
  filter(CountingIDs == g)
  
  leaveout <- length(unique(temp1$Zip))
  temp <- zip.centroids %>% filter(ZipCode %in% c(unique(temp1$Zip), unique(temp1$ZipCode)))

    ## Calc Farthest Site Distance
  mm <- as.matrix(dist(as.matrix(temp$X, temp$Y), method = "euclidean", diag = TRUE))[c(1:leaveout),-c(1:leaveout)]
  zipdist[zipdist$CountingIDs == g,]$DistToFarthestSite <-  max(mm) * 111.139
  
  ## Calc Closest Site Distance
  mm <- as.matrix(dist(as.matrix(temp$X, temp$Y), method = "euclidean", diag = TRUE))[c(1:leaveout),-c(1:leaveout)]
  zipdist[zipdist$CountingIDs == g,]$DistToClosestSite <-  min(mm) * 111.139
  
  
## Calc Closest Site Distance by zip
  if (is.null(dim(mm))) {
          ZipLevel <- data.frame(Zip = unique(temp1$Zip), ZiplevelDistToClosestSite = min(mm, na.rm = TRUE) * 111.139)
  }else{
      ZipLevel <- data.frame(Zip = unique(temp1$Zip), ZiplevelDistToClosestSite = apply(mm, 1, FUN = min, na.rm = TRUE) * 111.139)
  }
  
  zipdist[zipdist$Zip %in% ZipLevel$Zip & zipdist$CountingIDs == g,]$ZiplevelDistToClosestSite <- zipdist[zipdist$Zip %in% ZipLevel$Zip & zipdist$CountingIDs == g,] %>% 
        ungroup() %>% 
    select(`BHCMIS ID`:DistToClosestSite) %>% 
    left_join(ZipLevel, by = c("Zip")) %>% 
    select(ZiplevelDistToClosestSite) %>% 
    unlist()
  
  if (as.integer(g/100) == g/100) {print(g)}
  
} 



zipdist


length(unique(zipdist$`BHCMIS ID`))





```




## Alt by year
Takes a couple minutes to run (~ 15)

```{r}


# zipdist <- uds.zip %>%
#  # filter(ReportingYear == 2012) %>%
#   select(BHCMISID, GrantNumber, ZipCode, ReportingYear) %>%
#   unique() %>%
#   left_join(df.z.temp , by = c("BHCMISID" = "BHCMIS ID", "ZipCode" = "Zip","ReportingYear" = "Year")) %>%
#   filter(is.na(ID)) %>%
#   select(`BHCMISID`:ZipCode, ReportingYear) %>%
#   left_join(uds.zip, by = c("ZipCode","ReportingYear")) %>%
#   select(ZipCode, BHCMISID.x, BHCMISID.y, ReportingYear) %>%
#   filter(BHCMISID.x != BHCMISID.y)
# 
# inclusion <- zipdist %>%
#   select(BHCMISID.x, ZipCode, ReportingYear) %>%
#   unique()
# 
# 
# ## This next line takes a minute to run
# zipdist <- df.z.temp %>%
#   left_join(inclusion, by = c("BHCMIS ID" = "BHCMISID.x", "Year" = "ReportingYear")) %>%
#   select(`BHCMIS ID`, Zip, Att, DirectlyTreated, Tx, ZipCode, Year) %>%
#   unique()
# 
# 
# 
# zipdist <- zipdist %>%
#   filter(Year >= 2012) %>%
#   #group_by(`BHCMIS ID`) %>%
#   mutate(CountingIDs = as.numeric(factor(paste(`BHCMIS ID`, Year, sep = "-"))))
# 
# 
# length(unique(zipdist$CountingIDs))
# 
# 
# zipdist <- zipdist %>% mutate(DistToClosestSite = NA)
# 
# for (g in c(1:9301)){
# 
#   temp1 <- zipdist %>%
#   filter(CountingIDs == g)
# 
#   leaveout <- length(unique(temp1$Zip))
#   temp <- zip.centroids %>% filter(ZipCode %in% c(unique(temp1$Zip), unique(temp1$ZipCode)))
# 
#   mm <- as.matrix(dist(as.matrix(temp$X, temp$Y), method = "euclidean", diag = TRUE))[-c(1:leaveout),c(1:leaveout)]
#   zipdist[zipdist$CountingIDs == g,]$DistToClosestSite <-  min(mm) * 111.139
# 
#   if (as.integer(g/100) == g/100) {print(g)}
# }
# 
# 
# zipdist






```





## Find closest baseline distance

```{r}


df.iv <- df.temptemp %>%
  mutate(Tx = ifelse(Tx > 1, 1, 0)) %>%
  filter(!is.na(Tx)) %>%
  left_join(zipdist %>%
  select(`BHCMIS ID`, DistToClosestSite, ZiplevelDistToClosestSite, DistToFarthestSite) %>%
  unique(), by = c("BHCMIS ID")) %>%
  #mutate(DistToClosestSite = ifelse(DistToClosestSite > 100, 100, DistToClosestSite)) %>% 
  mutate(Z = log(1 / (DistToClosestSite / DistToFarthestSite))) %>%
  filter(!is.infinite(Z))


iv_model <- feols(df.iv, Pct.None ~ Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag | Year | I((10000 - ClinicHHI)/1000) ~ Z , cluster = "ID")
summary(iv_model)


summary(lm(data = df.iv, Tx ~ Z))


# df.iv <- df.temptemp %>% 
#   mutate(Tx = ifelse(Tx > 1, 1, 0)) %>% 
#   filter(!is.na(Tx)) %>% 
#   left_join(zipdist %>% 
#   group_by(`BHCMIS ID`, Year) %>% 
#   mutate(DistToClosestSite = min(DistToClosestSite, na.rm = TRUE)) %>% 
# select(`BHCMIS ID`, Year, DistToClosestSite) %>% 
# unique(), by = c("BHCMIS ID", "Year")) %>% 
#   mutate(Z = log(1 / DistToClosestSite)) %>% 
#   filter(!is.infinite(Z)) 




# %>%  
#   ungroup()%>% 
#   select(Qcomp, Complexity, Pct.NHA:Pct.COM, Tx, ID, ClinicHHI, MHC, HO, PH, Z, Year) %>% 
#   filter(complete.cases(.)) 


hist(df.iv$Z, na.rm = T)




```



# Alt analysis 

## Core Estimates

```{r}
coeffs <- c(0,0,0,0)

for (k in 1:28){

  df.temptemptemp <- df.iv 
  colnames(df.temptemptemp)[(16+k)] <- "Outcome"
  #model <- feols(Outcome ~ Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless   | I((10000 - ClinicHHI)/1000) ~ Tx + factor(Year) + factor(ID) , cluster = "ID", data = df.temptemptemp)
  #coeffs <- rbind(coeffs, model$coeftable[2,])
  model <- feols(Outcome ~ Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.FarmWorker + Pct.Homeless + UrbanRuralFlag | Year | I((10000 - ClinicHHI)/1000) ~ Z, cluster = "ID", data = df.temptemptemp)
  coeffs <- rbind(coeffs, model$coeftable[1,])
  

}



core.iv.estimates.alt <- data.frame(cbind(colnames(df.temptemp)[17:44], (coeffs[-1,]))) %>% 
  #select(V1, Estimate, Pr...t.., Estimate.1, Pr...t...1) %>% 
  mutate(Estimate = round(as.numeric(Estimate), 2), `95% CI` = paste(round(as.numeric(Estimate) - 1.96 * as.numeric(`Std..Error`), 2), ", ", round(as.numeric(Estimate) + 1.96 * as.numeric(`Std..Error`), 2), sep = "")) %>% 
  select(V1, Estimate, `95% CI`)

rownames(core.iv.estimates.alt) <- NULL

core.iv.estimates.alt %>% 
  kable("html", booktabs = T, col.names = c("Outcome","Estimate","95% CI")) %>% 
  kable_styling(latex_options = c("striped")) %>%
  pack_rows(index = c("Overall Impacts" = 4, "Quality of Care" = 6, "Patient Complexity" = 2, "Payer Mix" = 4, "Finances" = 6)) %>% 
  add_header_above(c("IV-Estimated LATE Effects of Competitive Shocks on Incumbent Clinics" = 3))



```




## Alt Spatial Analysis

```{r}


df.z.temp2 <- df.z.temp %>% 
  left_join(df.iv %>% ungroup() %>%  select(`BHCMIS ID`, Z, MHC, HO, PH, value) %>% unique(), by = c("BHCMIS ID"))
  


feols(Sites ~ 1 |  Year | Tx*DirectlyTreated ~  Z, cluster = "ID", data = df.z.temp2)


did2s(
      data = df.z.temp2,
      yname = "NumberofPatients",
      treatment = "Tx",
        first_stage = ~ 1 | ID + Year , #Pct.NHA + Pct.NHB + Pct.HL + Pct.LessThan100pctFPL + Pct.MCD + Pct.MCR + Pct.None | ID + Year ,
        second_stage = ~ i(Tx * (1 - DirectlyTreated), ref = FALSE)  + I(Tx * DirectlyTreated),
        cluster_var = "ID",
      verbose = TRUE
    )


```


# Save Datasets
```{r}
#df.z.temp %>% write_csv("/Users/markow/Dropbox/Git/Competition/data_processed/final_manuscript_allocation.csv")
#df.temptemp %>% write_csv("/Users/markow/Dropbox/Git/Competition/data_processed/final_manuscript_core.csv")
```



