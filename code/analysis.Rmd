
## What's happening with the closures?
```{r}

closures <- uds.sites[!is.na(uds.sites$Zip),] %>% 
  select(`Grant Number`, Zip, Year) %>% 
  unique() %>% 
  left_join(clinics.in.zips, by = c("Zip", "Year")) %>% 
  group_by(`Grant Number`, Year) %>% 
  summarise(Clinics = max(Clinics)) %>% 
  pivot_wider(id_cols = `Grant Number`, names_from = Year, values_from = Clinics) %>% 
  filter(`2014` == 1 & `2015` == 1 & `2016` == 1 ) %>% 
  left_join(chc.term, by = c("Grant Number" = "ClinicID")) %>% 
  filter(!is.na(NewClinicID))

closures <- closures %>% pivot_longer(`2014`:`2021`) %>%
  mutate(Outcome = ifelse(!is.na(NewClinicID) & is.na(value), 1, 0))


closures <- closures %>% 
  left_join(closures %>% 
    group_by(`Grant Number`) %>% 
    filter(value > 1) %>% 
    filter(name == min(name)) %>% 
    select(`Grant Number`, name), by = c("Grant Number")) %>% 
  #rename(Year = name.x) %>% 
  mutate(Att = as.numeric(ifelse(is.na(name.y), "0", name.y)), 
         Year = as.numeric(name.x)) %>% 
    select(`Grant Number`, Year, Att, Outcome) %>% 
  rbind( df.qual.exp %>% 
  mutate(Outcome = 0) %>% 
  select(`Grant Number`, Year, Att, Outcome)) %>% 
  mutate(ID = as.numeric(factor(`Grant Number`)), 
         Tx = ifelse(Year >= Att, 1, 0))

summary(lm(data = closures, Outcome ~ Tx + as.factor(Year)))

cs.output.expand <- att_gt( yname = "Outcome",
                      tname = "Year",
                      idname = "ID",
                      gname = "Att",
                      xformla = ~1,
                      data = closures, 
                      control_group = "nevertreated",
                      panel = FALSE, 
                      clustervars = "ID",
                      base_period = "universal"
                      )
aggte(cs.output.expand, type = "simple", na.rm = TRUE)
```






## Play environment
```{r}


cs.output.expand <- att_gt( yname = "Qcomp",
                      tname = "Year",
                      idname = "ID",
                      gname = "Att",
                      xformla = ~Pct.NHB.y + Pct.HL.y + Pct.LessThan100pctFPL.y + Pct.FarmWorker.y + Pct.Homeless.y + Pct.Children.y,
                      data = df.qual.exp %>% 
  left_join(cw %>% left_join(staffing, by = c("EIN")) %>% 
  select(`Grant Number`, Year, Staff) %>% mutate(Year = as.numeric(Year), Staff = as.numeric(Staff)), by = c("Grant Number","Year")) %>% 
    left_join(df.qual.exp %>% filter(Year == 2016) %>% select(`Grant Number`, Pct.NHA:Pct.Children), by = c("Grant Number")) %>% 
    filter(ZipFilter == 1), # / (Cash + Investments + Receivables + `Gross land, buildings and equipment (LBE)`) * 1000), # %>% inner_join(df.qual.exp %>% filter(Year == 2016 & `Surplus as a pct of before dep expenses`< 2) %>% select(`Grant Number`), by = c("Grant Number")),  # %>% select(Year, ID, Att, `Gross land, buildings and equipment (LBE)`) %>% filter(!is.na(`Gross land, buildings and equipment (LBE)`)), ### Split surplus pct after dep at 0 and 0.05 in 2016 plus ZipFilter ==2
                      control_group = "nevertreated",
                      panel = TRUE, 
                      clustervars = "ID",
                      base_period = "universal"
                      )
aggte(cs.output.expand, type = "simple", na.rm = TRUE)


cs.output.expand.agg.dyn.0 <- aggte(cs.output.expand, type = "simple", na.rm = TRUE)
cs.output.expand.agg.dyn <- aggte(cs.output.expand, type = "dynamic", na.rm = TRUE)
data.frame(Year = cs.output.expand.agg.dyn$egt, 
           Estimate = cs.output.expand.agg.dyn$att.egt, 
           CILB = cs.output.expand.agg.dyn$att.egt - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt,
           CIUB = cs.output.expand.agg.dyn$att.egt + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt) %>% 
  # mutate(CILB = replace(CILB, Year == -1, NA), 
  #        CIUB = replace(CIUB, Year == -1, NA)) %>% 
  #filter(abs(Year) < 4) %>% 
  ggplot(mapping = aes(x = Year, y = Estimate)) + 
  geom_vline(xintercept=-0.5, linetype = "dashed", color = "red") + 
  geom_hline(yintercept=0, linetype = "dashed", color = "grey") + 
  geom_point() + geom_errorbar(aes(ymin=CILB, ymax=CIUB), width=.2) + theme_tufte_revised()



summary(df.qual.exp[df.qual.exp$Year %in% c(2016:2019),]$`Liabilities (as pct of assets)`)

# Surplus as a pct of after dep expenses
# Liabilities (as pct of assets)
# Qcomp
# Gross land, buildings and equipment (LBE)

df.qual.exp %>%
  #filter(Att == 2020 & Year == 2020) %>%
  select(Att, Year, `Gross land, buildings and equipment (LBE)`, Sites, Altmans.Z, None) %>%
  mutate(Treat = ifelse(Att > 0, 1, 0)) %>%
  group_by(Att, Year) %>%
  summarize(Outcome = mean(None, na.rm = TRUE)) %>%
 # mutate(Outcome = ifelse(Outcome < -5, -5, Outcome)) %>%
  ggplot(aes(x = Year, y = Outcome, group = factor(Att), color = factor(Att))) + geom_point() #+ geom_jitter()



# uds.zip.totals %>% 
#   mutate(LowInc = (None + MCD) / Total) %>% 
#   filter(LowInc < 0.5 & `Reporting Year` == 2019)
#summary(lm(data = df.qual.exp, Qcomp ~ MarketShare + factor(Year) + factor(`Grant Number`)))


#df.qual.exp %>% filter(Year == 2016 & `Surplus as a pct of after dep expenses` < 0 & ZipFilter == 2)


```




## Quick Matching to see if shit changes
```{r}

# df.match <- df.qual.exp %>% filter(Year == 2015) %>%
#   select(`Grant Number`, Att, MCD, Total, Sites, Pct.NHB, Pct.HL, Pct.Children, Pct.LessThan100pctFPL)
# 
# 
# FIPS <- df.match$`Grant Number`
# X <- as.matrix(df.match[,c(3:9)])
# Tr <- ifelse(df.match$Att > 0, 1, 0)
# 
# summary(X)
# 
# m <- Match(Tr = Tr, X = X, M = 1) #, replace = TRUE)
# #mb <- MatchBalance(Treatment ~ . - FIPS, data=df.match, match.out=m, nboots=500)
# 
# df.matched <- data.frame(FIPS[m$index.treated], FIPS[m$index.control]) %>%
#   mutate(Paired = paste(FIPS[m$index.treated], FIPS[m$index.control], sep = "-"))
# 
# df.matched <- rbind(df.matched %>%
#         select(FIPS.m.index.treated., Paired) %>%
#         rename(FIPS = FIPS.m.index.treated.) %>%
#         mutate(Treatment = 1),
#       df.matched %>%
#         select(FIPS.m.index.control., Paired) %>%
#         rename(FIPS = FIPS.m.index.control.) %>%
#         mutate(Treatment = 0)) %>%
#   rename(`Grant Number` = FIPS)
# 
# df.qual.exp <- inner_join(df.matched %>% select(`Grant Number`, Treatment), df.qual.exp, by = c("Grant Number")) # %>% unique()

```





# Figures

## Prep for the robustness tests
```{r}
atts <- c("Primo", rep(0, 6))

# cbind("Sites", round(cbind(cs.output.expand.agg.dyn.0$overall.att, 
#       cs.output.expand.agg.dyn.0$overall.att - 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
#       cs.output.expand.agg.dyn.0$overall.att + 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
#       cs.output.expand.agg.dyn$overall.att, 
#       cs.output.expand.agg.dyn$overall.att - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$overall.se, 
#       cs.output.expand.agg.dyn$overall.att + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$overall.se), 3))
z <- c("Primo", 0) #cs.output.expand$Wpval

```



## Figure 0 - Demographics
```{r}
df.qual.exp %>% 
  mutate(Treat = ifelse(Att > 0, 1, 0)) %>% 
  mutate(Groups = ifelse(Treat == 1 & Expandor == 0, "Treated", 
                  ifelse(Treat == 0 & Expandor == 0, "Control", 
                  ifelse(Treat == 0 & Expandor == 1, "Expandor Comp", "Expandor No Comp")))) %>% 
  filter(Year == 2015) %>%  #z & ZipFilter == 2) %>% 
  select(Sites, Zips, #MarketShare, 
         Total, None:MCD, IMM2yo:DepScrn, Groups, Pct.NHA:Pct.NHW, Pct.LessThan200pctFPL, Pct.Homeless:Pct.Children, `Liabilities (as pct of assets)`, `Gross land, buildings and equipment (LBE)`, `Surplus as a pct of after dep expenses`) %>% #SwitchEMR, InterOrgHITexchange, UDSQualRep.highlowuse, 
  tbl_summary(by = Groups, 
              statistic = all_continuous() ~ "{mean} ({sd})") %>% 
  add_p(test = everything() ~ "t.test") 


df.qual.exp %>% mutate(Treat = ifelse(Att > 0, 1, 0)) %>% group_by(Treat) %>% summarise(n())


df.qual.exp %>% 
  filter(Year %in% c(2015, 2016)) %>% 
  mutate(Groups = ifelse(is.na(Personnel), "NoFins", "Fins")) %>% 
 #z & ZipFilter == 2) %>% 
  select(Sites, Zips, #MarketShare, 
         Total, None:MCD, #IMM2yo:DepScrn, 
         Groups, Pct.NHA:Pct.NHW, Pct.LessThan200pctFPL, Pct.Homeless:Pct.Children) %>% #SwitchEMR, InterOrgHITexchange, UDSQualRep.highlowuse, 
  tbl_summary(by = Groups, 
              statistic = all_continuous() ~ "{mean} ({sd})", digits = all_continuous() ~ 2) %>% 
  add_p(test = everything() ~ "t.test")

df.qual.exp %>% 
  mutate(Groups = ifelse(is.na(Personnel), "NoFins", "Fins")) %>% 
  group_by(Groups) %>% 
  summarise(n())

R.version

442*5
37*5
518/1877

442+37

```







## Figure 1 - Trends over time

```{r}
## Plot
p <- uds.sites[!is.na(uds.sites$Zip),] %>% 
  select(`Grant Number`, Zip, Year) %>% 
  unique() %>% 
  left_join(clinics.in.zips, by = c("Zip", "Year")) %>% 
  group_by(`Grant Number`, Year) %>% 
  summarise(Clinics = max(Clinics)) %>% 
  group_by(Year, Clinics) %>% 
  summarise(Count = n()) %>% 
  mutate(CompetitorsInArea = factor(ifelse( Clinics < 4, Clinics - 1, "3+"))) %>% 
  group_by(Year, CompetitorsInArea) %>% 
  summarise(Count = sum(Count))

plot <- p %>% 
  ggplot(aes(x = Year, y = Count, group = CompetitorsInArea, color = CompetitorsInArea)) + 
  geom_point() + geom_line() + theme_minimal() + 
  ggtitle("Figure 1 - Counts of FQHCs by number of competing FQHCs in service area, 2014-2021") + ylab("Number of FQHCs") 
plot + scale_color_discrete(name = "Competitors")

## Table
uds.sites[!is.na(uds.sites$Zip),] %>% 
  select(`Grant Number`, Zip, Year) %>% 
  unique() %>% 
  left_join(clinics.in.zips, by = c("Zip", "Year")) %>% 
  group_by(`Grant Number`, Year) %>% 
  summarise(Clinics = max(Clinics)) %>% 
  group_by(Year, Clinics) %>% 
  summarise(Count = n()) %>% 
  mutate(CompetitorsInArea = factor(ifelse( Clinics < 4, Clinics - 1, "3+"))) %>% 
  group_by(Year, CompetitorsInArea) %>% 
  summarise(Count = sum(Count)) %>% 
  pivot_wider(id_cols = CompetitorsInArea, names_from = Year, values_from = Count) 


plot0 <- p %>% 
  arrange(CompetitorsInArea) %>% 
  ggplot(aes(x = Year, y = Count, group = CompetitorsInArea, color = CompetitorsInArea)) + ylab("FQHCs") + 
  geom_point() + geom_line() + theme_tufte_revised() + ggtitle("FQHCs by Number of Rival Clinics") + 
  geom_dl(label=c(rep("0 Competitors", 8), rep("1 Competitor", 8), rep("2 Competitors", 8), rep("3+ Competitors", 8)), 
          method = list("last.points", hjust = 1, vjust = 3, cex = 0.75), inherit.aes=T ) + 
  guides(colour = "none")

plot1 <- uds.sites[!is.na(uds.sites$Zip),] %>% 
            group_by(Zip, Year) %>% 
  summarise(Counts = n()) %>% 
  #summarise(Counts = n_distinct(`Grant Number`)) %>% 
  ungroup() %>% 
  group_by(Year, Counts) %>% 
  summarise(Zips = n()) %>% 
  mutate(Counts.f = as.factor(ifelse(Counts >= 2, "2+", Counts))) %>% 
  group_by(Counts.f, Year) %>% 
  summarise(Zips = sum(Zips)) %>% 
  ggplot(aes(x = Year, y = Zips, group = Counts.f, color = Counts.f)) + 
  geom_point() + geom_line() + theme_tufte_revised() + ggtitle("Zip Codes by Number of FQHC Sites") + 
  geom_dl(label=c(rep("1 Site", 8), rep("2+ Sites", 8)), method = list("last.points", hjust = 1, vjust = -0.5, cex = 0.75), inherit.aes=T ) + 
  guides(colour = "none")


p.desc <- ggarrange(plot1, plot0) 

annotate_figure(p.desc, top = text_grob("Figure 2 - FQHC Growth and Density by Zip and Clinic", face = "bold", size = 14))


# rbind(uds.sites %>% 
#   group_by(`Grant Number`, `Site Name`) %>% 
#   summarise(Year = min(Year)) %>% 
#   group_by(Year) %>% 
#   summarise(Counts = n()) %>% 
#   mutate(Type = "Opened"), 
#   uds.sites %>% 
#   group_by(`Grant Number`, `Site Name`) %>% 
#   summarise(Year = max(Year)) %>% 
#   group_by(Year) %>% 
#   summarise(Counts = n()) %>% 
#   mutate(Type = "Closed")) %>% 
#   filter(Year %in% c(2015:2019))

```


```{r}

# df.z %>% 
#   group_by(as.factor(Att), Year) %>% 
#   summarise(outcome = mean(Total.z, na.rm = TRUE)) %>% 
#   ggplot(aes(x = Year, y = outcome, color = `as.factor(Att)`)) + geom_point()

# 
# cs.output.expand <- att_gt( yname = "Total.z",
#                       tname = "Year",
#                       idname = "ID",
#                       gname = "Att",
#                       xformla = ~1,
#                       data = df.z, # %>%  group_by(`Grant Number`, Year, Att) %>% summarise(Zips = n(), ID = min(ID), Total.z = sum(Total.z, na.rm = TRUE) ), # %>% filter(Year > 2015),
#                       control_group = "nevertreated",
#                       clustervars = "ID",
#                       panel = FALSE,
#                       base_period = "universal"
#                       )
# aggte(cs.output.expand, type = "simple", na.rm = TRUE)
# 
# 
# cs.output.expand <- att_gt( yname = "Total.z",
#                       tname = "Year",
#                       idname = "ID",
#                       gname = "Att.z",
#                       xformla = ~1,
#                       data = df.z %>% group_by(`Grant Number`, Year, Att, Att.z) %>% summarise(Zips = n(), ID = min(ID), Total.z = sum(Total.z, na.rm = TRUE) ) %>% filter(Att == Att.z), # %>% filter(Year > 2015),
#                       control_group = "nevertreated",
#                       clustervars = "ID",
#                       panel = FALSE,
#                       base_period = "universal"
#                       )
# aggte(cs.output.expand, type = "simple", na.rm = TRUE)
# 
# #uds.zip %>% filter(`Grant Number` == "H80CS00030" & `Zip Code` == '48264')



```






## Figure 2 - Focused analysis, patient attribution in service area (where they have sites)
```{r}

## Treatment vs control, only in zip code of interest
df.z <- left_join(df.qual.exp #%>% filter(`Grant Number` != "H80CS00225")
                  , #uds.zip %>% mutate(Zip = `Zip Code`) %>% select(`Grant Number`, Zip) %>% unique() , by = c("Grant Number")) %>%
                  uds.sites[!is.na(uds.sites$Zip),] %>%
                    filter(Year %in% c(2015:2019)) %>% 
              select(`Grant Number`, Zip) %>%
              unique() , by = c("Grant Number")) %>%
  left_join(uds.zip %>%
            mutate(  Total.z = `Total Number of Patients`, 
                     MCD.z = `Medicaid_CHIP_Other Public Patients`,
                     MCR.z = `Medicare Patients`,
                     COM.z = `Private Patients`, 
                     None.z = `None_Uninsured Patients`) %>%
            select(`Grant Number`, `Reporting Year`, `Zip Code`, Total.z:None.z), by = c("Grant Number", "Year" = "Reporting Year", "Zip" = "Zip Code")) %>%
  left_join(clinics.in.zips %>% select(Zip:Clinics), by = c("Zip","Year")) %>%
  mutate(Tx.z = ifelse(Clinics == 1 , 0, 
                ifelse(is.na(Clinics), NA, 1)), # | is.na(Clinics)
         ID = as.numeric(factor(paste(`Grant Number`, Zip, sep = "-")))) %>%
  select(`Grant Number`:Year, ZipFilter, Att, ID, Zip:Tx.z) %>%
  arrange(`Grant Number`, Zip, Year) %>% 
  unique() #%>%  inner_join(df.qual.exp %>% filter(Year == 2015 & Total > 12050) %>% select(`Grant Number`), by = c("Grant Number"))  #& Zips < 3.75 or 4.75
  # %>%   filter(MarketShare > median(MarketShare, na.rm = TRUE) - 0.25) 

df.z <- df.z %>%
  left_join(df.z %>%
            filter(Tx.z == 1) %>%
            group_by(ID, Zip) %>%
            summarise(Att.z = min(Year)), by = c("ID", "Zip")) %>%
  mutate(Att.z = ifelse(is.na(Att.z), 0, Att.z)) #%>%
# inner_join(df.z %>% filter(!is.na(Clinics)) %>% group_by(ID) %>% summarise(n()) %>% filter(`n()` == length(unique(df.qual.exp$Year))), by = c("ID")) #%>% filter(Att == Att.z)


### NOTE: The aabove commented lines are very important, they decide if only the service area or whole catchment is included in analysis.  
# cs.output.expand <- att_gt( yname = "Outcome",
#                       tname = "Year",
#                       idname = "ID",
#                       gname = "Att",
#                       xformla = ~1,
#                       data = df.z %>% group_by(`Grant Number`, Year, Att) %>% summarise(ID = min(ID), Outcome = sum(MCD.z, na.rm = TRUE) ), # %>% filter(Year > 2015),
#                       control_group = "nevertreated",
#                       clustervars = "ID",
#                       panel = TRUE,
#                       base_period = "universal"
#                       )
# aggte(cs.output.expand, type = "simple", na.rm = TRUE)



## Whole zip as one measure

df.z.full <- df.z %>% ############## NOTE: Original +500 effect was recoved with Att.z, not Att
  select(Zip, ZipFilter, Att.z, Year) %>% 
  unique() %>% 
  left_join(uds.zip, by = c("Zip" = "Zip Code", "Year" = "Reporting Year")) %>% 
  left_join(uds.6b.rates %>% 
            mutate(Quality = (IMM2yo + Pap + ChildBMI + AdultBMI + Tobac + CRC + DepScrn) / 7) %>% 
            select(GrantNumber, Year, Quality), by = c("Grant Number" = "GrantNumber", "Year")) %>% 
  group_by(Zip, ZipFilter, Year, Att.z) %>% 
  summarise(
    Total.z = sum(`Total Number of Patients`, na.rm = TRUE), 
    MCD.z = sum(`Medicaid_CHIP_Other Public Patients`, na.rm = TRUE),
    MCR.z = sum(`Medicare Patients`, na.rm = TRUE),
    COM.z = sum(`Private Patients`, na.rm = TRUE),
    None.z = sum(`None_Uninsured Patients`, na.rm = TRUE), 
    Quality.z = sum(`Total Number of Patients` * Quality, na.rm = TRUE) / Total.z) %>% 
  ungroup() %>% 
  mutate(ID = as.numeric(as.factor(Zip)))# %>% group_by(`Grant Number`, Year, Att) %>% summarise(ID = min(ID), Total.z = sum(Total.z, na.rm = TRUE)) # %>% filter(Year > 2015),


df.zip.1 <- df.z %>% select(ID, ZipFilter, Year, Att, Total.z:None.z)
df.zip.2 <- df.z.full %>% select(ID, ZipFilter, Year, Att.z, Total.z:Quality.z)


## Start the loop

for (k in 1:3){
  
atts.zip.1 <- rep(0, 6)
atts.zip.2 <- rep(0, 6)
  
if (k == 1){temp.1.root <- df.zip.1
            temp.2.root <- df.zip.2} else 
  if (k == 2){temp.1.root <- df.zip.1 %>% filter(ZipFilter == 2)
              temp.2.root <- df.zip.2 %>% filter(ZipFilter == 2)} else
    if (k == 3){temp.1.root <- df.zip.1 %>% filter(ZipFilter == 1)
                temp.2.root <- df.zip.2 %>% filter(ZipFilter == 1)} 

for (i in 5:9){

  temp.1 <- temp.1.root[,c(1:4, i)]
  colnames(temp.1) <- c("ID", "ZipFilter", "Year","Att","Outcome")

   temp.2 <- temp.2.root[,c(1:4, i)]
  colnames(temp.2) <- c("ID", "ZipFilter", "Year","Att","Outcome")
  

  
    # Incumbent only
cs.output.expand <- att_gt( yname = "Outcome",
                      tname = "Year",
                      idname = "ID",
                      gname = "Att",
                      xformla = ~1,
                      data = temp.1,
                      control_group = "nevertreated",
                      clustervars = "ID",
                      panel = FALSE,
                      base_period = "universal"
                      )

cs.output.expand.agg.dyn.0 <- aggte(cs.output.expand, type = "simple", na.rm = TRUE)
cs.output.expand.agg.dyn <- aggte(cs.output.expand, type = "dynamic", na.rm = TRUE)

data.frame(Year = cs.output.expand.agg.dyn$egt,
           Estimate = cs.output.expand.agg.dyn$att.egt,
           CILB = cs.output.expand.agg.dyn$att.egt - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt,
           CIUB = cs.output.expand.agg.dyn$att.egt + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt) %>%
  ggplot(mapping = aes(x = Year, y = Estimate)) +
  geom_vline(xintercept=-0.5, linetype = "dashed", color = "red") +
  geom_hline(yintercept=0, linetype = "dashed", color = "grey") +
  geom_point() +
  geom_errorbar(aes(ymin=CILB, ymax=CIUB), width=.2) +
  ggtitle("Total Zip") +
  theme_tufte_revised()

atts.zip.1 <- rbind(atts.zip.1, 
                    cbind(colnames(df.zip.1)[i], 
                          round(mean(temp.1[temp.1$Att == 0 & temp.1$Year == min(temp.1$Year),]$Outcome, na.rm = TRUE), 3), 
                          round(mean(temp.1[temp.1$Att > 0 & temp.1$Year == min(temp.1$Year),]$Outcome, na.rm = TRUE) - mean(temp.1[temp.1$Att == 0 & temp.1$Year == min(temp.1$Year),]$Outcome, na.rm = TRUE), 3), 
                          round(cbind(cs.output.expand.agg.dyn.0$overall.att, 
                          cs.output.expand.agg.dyn.0$overall.att - (1.96 * cs.output.expand.agg.dyn.0$overall.se), 
                          cs.output.expand.agg.dyn.0$overall.att + (1.96 * cs.output.expand.agg.dyn.0$overall.se)), 3)))


# Incumbent + Competitor
cs.output.expand <- att_gt( yname = "Outcome",
                      tname = "Year",
                      idname = "ID",
                      gname = "Att",
                      xformla = ~1,
                      data = temp.2, 
                      control_group = "nevertreated",
                      clustervars = "ID",
                      panel = FALSE,
                      base_period = "universal"
                      )

cs.output.expand.agg.dyn.0 <- aggte(cs.output.expand, type = "simple", na.rm = TRUE)
cs.output.expand.agg.dyn <- aggte(cs.output.expand, type = "dynamic", na.rm = TRUE)

data.frame(Year = cs.output.expand.agg.dyn$egt,
           Estimate = cs.output.expand.agg.dyn$att.egt,
           CILB = cs.output.expand.agg.dyn$att.egt - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt,
           CIUB = cs.output.expand.agg.dyn$att.egt + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt) %>%
  ggplot(mapping = aes(x = Year, y = Estimate)) +
  geom_vline(xintercept=-0.5, linetype = "dashed", color = "red") +
  geom_hline(yintercept=0, linetype = "dashed", color = "grey") +
  geom_point() +
  geom_errorbar(aes(ymin=CILB, ymax=CIUB), width=.2) +
  ggtitle("Total Zip") +
  theme_tufte_revised()

atts.zip.2 <- rbind(atts.zip.2, cbind(colnames(df.zip.2)[i], 
                                      round(mean(temp.2[temp.2$Att == 0 & temp.2$Year == min(temp.2$Year),]$Outcome, na.rm = TRUE), 3), 
                                      round(mean(temp.2[temp.2$Att > 0 & temp.2$Year == min(temp.2$Year),]$Outcome, na.rm = TRUE) - mean(temp.2[temp.2$Att == 0 & temp.2$Year == min(temp.2$Year),]$Outcome, na.rm = TRUE), 3), 
                                      round(cbind(cs.output.expand.agg.dyn.0$overall.att,
      cs.output.expand.agg.dyn.0$overall.att - (1.96 * cs.output.expand.agg.dyn.0$overall.se),
      cs.output.expand.agg.dyn.0$overall.att + (1.96 * cs.output.expand.agg.dyn.0$overall.se)), 3)))

}

## For the full sample only


## For Larger vs Smaller FQHCs only
if (k == 1){atts.zip.full <-  cbind(atts.zip.1[-1,], atts.zip.2[-1,]) } else 
  if (k == 2){atts.zip.larger <- cbind(atts.zip.1[-1,], atts.zip.2[-1,])} else
    if (k == 3){atts.zip.smaller <- cbind(atts.zip.1[-1,], atts.zip.2[-1,])}

}


df.zip.1 %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(Treat) %>% summarise(n(), n_distinct(ID))
df.zip.2 %>% mutate(Treat = ifelse(Att.z > 0, 'Treat','Control')) %>% group_by(Treat) %>% summarise(n(), n_distinct(ID))


table.names <- rbind(cbind((df.zip.1 %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(Treat) %>% summarise(n()))[2,2], 
            (df.zip.1 %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(Treat) %>% summarise(n()))[1,2]), 
      cbind((df.zip.2 %>% mutate(Treat = ifelse(Att.z > 0, 'Treat','Control')) %>% group_by(Treat) %>% summarise(n()))[2,2], 
            (df.zip.2 %>% mutate(Treat = ifelse(Att.z > 0, 'Treat','Control')) %>% group_by(Treat) %>% summarise(n()))[1,2]))


## Figure 2 - Full Figure
rbind(atts.zip.full, atts.zip.larger, atts.zip.smaller) %>% 
   kable("html", booktabs = T, col.names = c("Outcome", "C_0", "T_0 - C_0", "DID Estimate", "LB", "UB", "Outcome", "C_0", "T_0 - C_0", "DID Estimate", "LB", "UB")) %>%
  kable_styling(latex_options = c("striped")) %>%
  pack_rows(index = c("Full Sample" = 5, "More Market Share Only" = 5, "Less Market Share Only" = 5)) %>% 
  add_header_above(c(" " = 1, "Incumbent vs Controls (FQHC-Zip units)" = 6, "Incumbent & Competitor vs Controls (zip units)" = 6)) %>% 
  add_footnote(c("C_0 and T_0 are mean values for each sample in control and treatment groups in first year of panel",
                 paste("Full Sample Incumbent vs Control has ", table.names[1,1], "treatment and ", table.names[1,2], " control FQHC-Zip-Years"), 
                 paste("Full Sample Incumbent & Control vs Control has ", table.names[2,1], "treatment and ", table.names[2,2], " control Zip-Years")))


cbind(rep(c("Total","Medicaid","Medicare","Commerical","Uninsured"), 3), rbind(atts.zip.full, atts.zip.larger, atts.zip.smaller)[,2:6]) %>% 
   kable("html", booktabs = T, col.names = c("Outcome", "C_0", "T_0 - C_0", "DID Estimate", "LB", "UB")) %>%
  kable_styling(latex_options = c("striped")) %>%
  row_spec(c(1, 2, 6, 7, 10, 11, 12),bold=T, italic = T, hline_after = T) %>% 
  pack_rows(index = c("Panel A: Full Sample" = 5, "Panel B: Higher Low-Income Market Share Subgroup" = 5, "Panel B: Lower Low-Income Market Share Subgroup" = 5)) %>% 
  add_footnote(c("C_0 and T_0 are mean values for each sample in control and treatment groups in first year of panel",
                 paste("Full Sample Incumbent vs Control has ", table.names[1,1], "treatment and ", table.names[1,2], " control FQHC-Zip-Years"), 
                 paste("Full Sample Incumbent & Control vs Control has ", table.names[2,1], "treatment and ", table.names[2,2], " control Zip-Years")))

```



## Nicer Table 

```{r}
df.zip.1 %>% 
  filter(Year %in% c(2016, 2019)) %>% 
  mutate(Tx = ifelse(Att > 0, 1, 0)) %>% 
  group_by(Year, Tx) %>% 
  summarise(mean(Total.z, na.rm = TRUE), 
            mean(MCD.z, na.rm = TRUE), 
            mean(MCR.z, na.rm = TRUE), 
            mean(COM.z, na.rm = TRUE), 
            mean(None.z, na.rm = TRUE)) %>% 
  arrange(Tx, Year) %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(unadj = (V4 - V3) - (V2 - V1) )

cbind(c("Total","Medicaid","Medicare","Commerical","Uninsured"), atts.zip.full[,2:6]) %>% 
   kable("html", booktabs = T, col.names = c("Outcome", "C_0", "T_0 - C_0", "DID Estimate", "LB", "UB")) %>%
  kable_styling(latex_options = c("striped")) %>%
  row_spec(c(1, 2),bold=T, italic = T, hline_after = T) %>% 
  #pack_rows(index = c("Panel A: Full Sample" = 5, "Panel B: Higher Low-Income Market Share Subgroup" = 5, "Panel B: Lower Low-Income Market Share Subgroup" = 5)) %>% 
  add_footnote(c("C_0 and T_0 are mean values for each sample in control and treatment groups in first year of panel",
                 paste("Full Sample Incumbent vs Control has ", table.names[1,1], "treatment and ", table.names[1,2], " control FQHC-Zip-Years"), 
                 paste("Full Sample Incumbent & Control vs Control has ", table.names[2,1], "treatment and ", table.names[2,2], " control Zip-Years")))
```


## Look at the Market as a whole


```{r}


df.market <- df.z.full %>% #filter(ZipFilter == 1)
                        left_join(df.z %>% select(`Grant Number`,Zip) %>% unique(), by = c("Zip")) %>% 
  mutate(V1 = 1, V2 = ifelse(ZipFilter == 2, 1, 0), V3 = ifelse(ZipFilter == 1, 1, 0)) %>% 
                       select(Year, ID, Att.z, Quality.z, `Grant Number`, Total.z:None.z, V1:V3) %>%
  # inner_join(df.qual.exp %>% filter(Year == 2015) %>%
  #                                           mutate(ZipFilter = ifelse(Total < 12000, 1,
  #                                                              ifelse(Total > 12000, 2, NA))) %>% select(`Grant Number`, ZipFilter), by = c("Grant Number")) %>%
  inner_join(df.qual.exp %>% filter(Year == 2016) %>% mutate(ZipFilter = ifelse(`Surplus as a pct of before dep expenses` < 2, 1, 2)) %>% select(`Grant Number`, ZipFilter), by = c("Grant Number")) %>% 
  select(Year, ZipFilter, ID, Att.z, Quality.z, Total.z:None.z, V1:V3) %>% 
  mutate(V4 = ifelse(ZipFilter == 2, 1, 0), V5 = ifelse(ZipFilter == 1, 1, 0)) %>% 
  unique() 


### Incumbnet + Competitors, Quality 
cs.output.expand <- att_gt( yname = "Quality.z",
                      tname = "Year",
                      idname = "ID",
                      gname = "Att.z",
                      xformla = ~1,
                      data = df.market %>% filter(V5 == 1), 
                      control_group = "nevertreated",
                      clustervars = "ID",
                      panel = TRUE,
                      base_period = "universal"
                      )

cs.output.expand.agg.dyn.0 <- aggte(cs.output.expand, type = "simple", na.rm = TRUE)
cs.output.expand.agg.dyn <- aggte(cs.output.expand, type = "dynamic", na.rm = TRUE)

data.frame(Year = cs.output.expand.agg.dyn$egt,
           Estimate = cs.output.expand.agg.dyn$att.egt,
           CILB = cs.output.expand.agg.dyn$att.egt - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt,
           CIUB = cs.output.expand.agg.dyn$att.egt + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt) %>%
  ggplot(mapping = aes(x = Year, y = Estimate)) +
  geom_vline(xintercept=-0.5, linetype = "dashed", color = "red") +
  geom_hline(yintercept=0, linetype = "dashed", color = "grey") +
  geom_point() +
  geom_errorbar(aes(ymin=CILB, ymax=CIUB), width=.2) +
  ggtitle("Total Change in Market Quality") +
  theme_tufte_revised()



```



## Figure 2 plots that are nicer
```{r}







## Plot of this shit, all payors
f2.picture.full <- rbind(rbind(atts.zip.full, atts.zip.larger, atts.zip.smaller)[,c(1:6)]) %>%  #, rbind(atts.zip.full, atts.zip.larger, atts.zip.smaller)[,c(7:12)]) %>% 
  as.data.frame() %>% 
  mutate(Model = c(rep("Incumbent Only", 3*5)), #, rep("Incumbent & Competitor", 3*5)), 
         Sample = rep(c(rep("Full Sample", 5), rep("More Market Share", 5), rep("Less Market Share", 5)), 1))

#### Clean up the data
row.names(f2.picture.full) <- NULL
colnames(f2.picture.full) <- c("Payor", "C_0", "T_0 - C_0", "Estimate", "LB", "UB", "Model","Sample")
f2.picture.full[,4:6] <- sapply(f2.picture.full[,4:6], as.numeric)
f2.picture.full$Sample <- factor(f2.picture.full$Sample, levels = c("Full Sample", "More Market Share","Less Market Share"))
f2.picture.full$Payor <- gsub(f2.picture.full$Payor, pattern = ".z", replacement = "")
f2.picture.full$Payor <- factor(f2.picture.full$Payor, levels = c("None", "MCR","COM","MCD","Total"))
f2.picture.full$Model <- factor(f2.picture.full$Model, levels = c("Incumbent Only","Incumbent & Competitor"))
f2.picture.full$Total <- ifelse(f2.picture.full$Payor == "Total", "Total", "Payor")
f2.picture.full$Total <- factor(f2.picture.full$Total, levels = c("Total","Payor"))

### Plot
f2.p.totals.inc <- ggplot(data=f2.picture.full #%>% filter(Sample == "Full Sample")
                          , aes(y=Payor, x=Estimate, xmin=LB, xmax=UB)) +
geom_point() + 

#this changes the features of the overall effects
#one could resize, reshape, or recolor these points if desired
xlab("DID Estimates - Patients") + 
ylab(NULL) + 
#adds the CIs
geom_errorbarh(height=.1) +

#sets the scales
#note that I reverse the y axis to correctly order the effect #sizes based on my index variable
#scale_x_continuous(limits=c(-2.5,1), breaks = c(-2.5:1), name=xname)+
#scale_y_continuous(name = "", breaks=1:9, labels = t9.forest$X1, trans="reverse")+

#adding a vertical line at the effect = 0 mark
geom_vline(xintercept=0, color="black", linetype="dashed", alpha=.5)+

#faceting based on my subgroups
  #facet_wrap(~X1) +
facet_grid(Total~Sample, scales= "free_y", switch = 'y', space = "free_y")+
 

#thematic stuff
#ggtitle("Figure 3 - ATT Estimates by SubGroups")+
theme_tufte_revised()+
   theme(strip.placement = "outside") +
#theme(text=element_text(family="Times",size=12, color="black"))+
theme(panel.spacing = unit(1, "lines")) +
  ggtitle("Figure 3, CS-DID Estimates on Patient Panel and Payor (FQHC-zip-year units)")

f2.p.totals.inc #+ theme(panel.spacing = unit(1, "lines"),  title =  element_text(face = "bold", size = 12))



```




## Figure 3 - Primary Results




```{r}

df.sum <- df.qual.exp %>% #filter(`Grant Number` != "H80CS00225") %>% 
  
  ungroup() %>% 
  #filter(MarketShare < median(MarketShare, na.rm = TRUE) - 0.25) %>% 
  #inner_join(df.qual.exp %>% filter(Year == 2015 & Total < 12000) %>% select(`Grant Number`), by = c("Grant Number")) %>%  #& Zips < 3.75 or 4.75
  # select(`Grant Number`, Year, ID, Att, Sites, Qcomp, Altmans.Z) %>%
  # inner_join(df.qual.exp %>% filter(Year == 2015) %>% mutate(ZipFilter = ifelse(Zips < 1.75, 1, 
  #                                                                        ifelse(Zips > 4.75, 2, NA))) %>% select(`Grant Number`, ZipFilter), by = c("Grant Number")) %>%
  select(Year, ZipFilter, ID, Att, Sites, Qcomp, Altmans.Z)
 


for (k in 1:3){
  
atts.sum <- rep(0, 7)
fig3.sum <- rep(0, 5)

if (k ==1){df.sum.root <- df.sum} else
  if (k == 2){df.sum.root <- df.sum %>% filter(ZipFilter == 2)} else
    if (k == 3){df.sum.root <- df.sum %>% filter(ZipFilter == 1)} 

  

for (i in 5:ncol(df.sum)){
  
  temp <- df.sum.root[,c(1:4, i)]
  colnames(temp) <- c("Year", "ZipFilter", "ID","Att", "Outcome")
  temp$Outcome
  
  # temp <- temp %>%
  #   mutate(Outcome = ifelse(Outcome < quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[1], quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[1],
  #                    ifelse(Outcome > quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[2], quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[2], Outcome)))

  
cs.output.expand <- att_gt( yname = "Outcome",
                      tname = "Year",
                      idname = "ID",
                      gname = "Att",
                      xformla = ~1,
                      data = temp, # %>% filter(Year >= 2015 & Year <= 2020), 
                      control_group = "nevertreated",
                      clustervars = "ID",
                      panel = FALSE, 
                      base_period = "universal"
                      )
cs.output.expand.agg.dyn.0 <- aggte(cs.output.expand, type = "simple", na.rm = TRUE)
cs.output.expand.agg.dyn <- aggte(cs.output.expand, type = "dynamic", na.rm = TRUE)

atts.sum <- rbind(atts.sum, cbind(colnames(df.sum)[i], round(mean(temp[temp$Att == 0 & temp$Year == min(temp$Year),]$Outcome, na.rm = TRUE), 3), round(mean(temp[temp$Att > 0 & temp$Year == min(temp$Year),]$Outcome, na.rm = TRUE) - mean(temp[temp$Att == 0 & temp$Year == min(temp$Year),]$Outcome, na.rm = TRUE), 3), round(cbind(cs.output.expand.agg.dyn.0$overall.att, 
      cs.output.expand.agg.dyn.0$overall.att - 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn.0$overall.att + 1.96 * cs.output.expand.agg.dyn.0$overall.se), 3)))

atts <- rbind(atts, cbind(colnames(df.sum)[i], round(cbind(cs.output.expand.agg.dyn.0$overall.att, 
      cs.output.expand.agg.dyn.0$overall.att - 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn.0$overall.att + 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn$overall.att, 
      cs.output.expand.agg.dyn$overall.att - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$overall.se, 
      cs.output.expand.agg.dyn$overall.att + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$overall.se), 3)))
z <- rbind(z, c(colnames(df.sum)[i], cs.output.expand$Wpval))

fig3.sum <- rbind(fig3.sum, 
                 data.frame(Outcome = colnames(df.sum)[i], 
                      Year = cs.output.expand.agg.dyn$egt, 
           Estimate = cs.output.expand.agg.dyn$att.egt, 
           CILB = cs.output.expand.agg.dyn$att.egt - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt,
           CIUB = cs.output.expand.agg.dyn$att.egt + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt))
}



rownames(fig3.sum) <- NULL
if (k == 1){atts.sum.full <- atts.sum[-1,]} else 
 if (k == 2){atts.sum.larger <- atts.sum[-1,]} else 
   {atts.sum.smaller <- atts.sum[-1,]}

}

#Event Study Plots
fig3.sum[-1,] %>%
  ggplot(mapping = aes(x = Year, y = Estimate)) +
  facet_wrap(~Outcome, scales = "free_y") +
  ylab("Percentage Points") +
  geom_vline(xintercept=-0.5, linetype = "dashed", color = "red") +
  geom_hline(yintercept=0, linetype = "dashed", color = "grey") +
  geom_point() + geom_errorbar(aes(ymin=CILB, ymax=CIUB), width=.2) +
  ggtitle("fig3 - Event Study") +
  theme_tufte_revised()



table.names <- rbind(cbind((df.sum %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(Treat) %>% summarise(n()))[2,2], 
            (df.sum %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(Treat) %>% summarise(n()))[1,2]), 
      cbind((df.sum %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(ZipFilter, Treat) %>% summarise(n()))[4,3], 
            (df.sum %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(ZipFilter, Treat) %>% summarise(n()))[3,3]), 
      cbind((df.sum %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(ZipFilter, Treat) %>% summarise(n()))[2,3], 
            (df.sum %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(ZipFilter, Treat) %>% summarise(n()))[1,3]))
 
## Table
rbind(atts.sum.full, atts.sum.larger, atts.sum.smaller) %>% 
   kable("html", booktabs = T, col.names = c("Outcome", "C_0", "T_0 - C_0", "DID Estimate", "LB", "UB"), caption = "Fig 3 - FQHC Responses by Market Share") %>%
  kable_styling(latex_options = c("striped")) %>%
  pack_rows(index = c("Full" = 3, "Above Median Market Share FQHCs" = 3, "Below Median Market Share FQHCs" = 3)) %>% 
  add_footnote(c("Atlman's Z is a measure of Financial Distress",
                 "C_0 and T_0 are mean values for each sample in control and treatment groups in first year of panel",
                 paste("Full Sample has ", table.names[1,1], "treatment and ", table.names[1,2], " control FQHC-Years")))

## Better Figure
f3.picture.full <- rbind(cbind("Full Sample", atts.sum.full), cbind("More Market Share", atts.sum.larger), cbind("Less Market Share", atts.sum.smaller) ) %>% 
  as.data.frame()

### Clean up the data
row.names(f3.picture.full) <- NULL
colnames(f3.picture.full) <- c("MarketShare", "Measure", "C_0", "T_0 - C_0", "Estimate", "LB", "UB")
f3.picture.full[,3:7] <- sapply(f3.picture.full[,3:7], as.numeric)
f3.picture.full$MarketShare <- factor(f3.picture.full$MarketShare, levels = c("Full Sample", "More Market Share","Less Market Share"))
# f3.picture.full$Payor <- gsub(f3.picture.full$Payor, pattern = ".z", replacement = "")
# f3.picture.full$Payor <- factor(f3.picture.full$Payor, levels = c("None", "MCR","COM","MCD","Total"))
# f3.picture.full$Model <- factor(f3.picture.full$Model, levels = c("Incumbent Only","Incumbent & Competitor"))
# f3.picture.full$Total <- ifelse(f3.picture.full$Payor == "Total", "Total", "Payor")
# f3.picture.full$Total <- factor(f3.picture.full$Total, levels = c("Total","Payor"))


### Plot
f3.p.totals.full <- ggplot(data=f3.picture.full, aes(y=Measure, x=Estimate, xmin=LB, xmax=UB)) +
geom_point() + 

#this changes the features of the overall effects
#one could resize, reshape, or recolor these points if desired
xlab("DID Estimates") + 
ylab(NULL) + 
#adds the CIs
geom_errorbarh(height=.1) +

#sets the scales
#note that I reverse the y axis to correctly order the effect #sizes based on my index variable
#scale_x_continuous(limits=c(-2.5,1), breaks = c(-2.5:1), name=xname)+
#scale_y_continuous(name = "", breaks=1:9, labels = t9.forest$X1, trans="reverse")+

#adding a vertical line at the effect = 0 mark
geom_vline(xintercept=0, color="black", linetype="dashed", alpha=.5)+

#faceting based on my subgroups
  #facet_wrap(~X1) +
facet_grid(~MarketShare, scales= "free", switch = 'y', space = "free_y")+
 

#thematic stuff
#ggtitle("Figure 3 - ATT Estimates by SubGroups")+
theme_tufte_revised()+
   theme(strip.placement = "outside") +
#theme(text=element_text(family="Times",size=12, color="black"))+
theme(panel.spacing = unit(1, "lines")) +
  ggtitle("Figure 3, FQHC Performance Reactions by Market Share")

f3.p.totals.full

```



## Figure 4 - Split by profitability





```{r}

df.sum <- df.qual.exp %>% #filter(`Grant Number` != "H80CS00225") %>% 
  ungroup() %>% 
  #rename(`Grant Number` = Grant.Number, `Surplus as a pct of before dep expenses` = Surplus.as.a.pct.of.after.dep.expenses) %>% 
  #filter(MarketShare < 0.4) %>%  #median(MarketShare, na.rm = TRUE) - 0.25
  #inner_join(df.qual.exp %>% filter(Year == 2015 & Total < 15000) %>% select(`Grant Number`), by = c("Grant Number")) %>%  #& Zips < 1.75 or 7.75
  select(`Grant Number`, Year, ID, Att, Sites, Qcomp, Altmans.Z) %>%
  # inner_join(df.qual.exp %>% filter(Year == 2015) %>%
  #                                           mutate(ZipFilter = ifelse(Total < 12000, 1,
  #                                                              ifelse(Total > 12000, 2, NA))) %>% select(`Grant Number`, ZipFilter), by = c("Grant Number")) %>%
  inner_join(df.qual.exp %>% filter(Year == 2016) %>% mutate(ZipFilter = ifelse(`Surplus as a pct of before dep expenses` < 2, 1, 2)) %>% select(`Grant Number`, ZipFilter), by = c("Grant Number")) %>% 
  select(Year, ZipFilter, ID, Att, Sites, Qcomp, Altmans.Z) %>% 
  unique() 
 
#summary(df.qual.exp[df.qual.exp$Year == 2015,]$Qcomp)

for (k in 2:3){
  
atts.sum <- rep(0, 7)
fig4.sum <- rep(0, 5)

if (k ==1){df.sum.root <- df.sum} else
  if (k == 2){df.sum.root <- df.sum %>% filter(ZipFilter == 2)} else
    if (k == 3){df.sum.root <- df.sum %>% filter(ZipFilter == 1)} 

  

for (i in 5:ncol(df.sum)){
  
  temp <- df.sum.root[,c(1:4, i)]
  colnames(temp) <- c("Year", "ZipFilter", "ID","Att", "Outcome")
  temp$Outcome
  
  # temp <- temp %>%
  #   mutate(Outcome = ifelse(Outcome < quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[1], quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[1],
  #                    ifelse(Outcome > quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[2], quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[2], Outcome)))

  
cs.output.expand <- att_gt( yname = "Outcome",
                      tname = "Year",
                      idname = "ID",
                      gname = "Att",
                      xformla = ~1,
                      data = temp , 
                      control_group = "nevertreated",
                      clustervars = "ID",
                      panel = FALSE, 
                      base_period = "universal"
                      )
cs.output.expand.agg.dyn.0 <- aggte(cs.output.expand, type = "simple", na.rm = TRUE)
cs.output.expand.agg.dyn <- aggte(cs.output.expand, type = "dynamic", na.rm = TRUE)

atts.sum <- rbind(atts.sum, cbind(colnames(df.sum)[i], round(mean(temp[temp$Att == 0 & temp$Year == min(temp$Year),]$Outcome, na.rm = TRUE), 3), round(mean(temp[temp$Att > 0 & temp$Year == min(temp$Year),]$Outcome, na.rm = TRUE) - mean(temp[temp$Att == 0 & temp$Year == min(temp$Year),]$Outcome, na.rm = TRUE), 3), round(cbind(cs.output.expand.agg.dyn.0$overall.att, 
      cs.output.expand.agg.dyn.0$overall.att - 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn.0$overall.att + 1.96 * cs.output.expand.agg.dyn.0$overall.se), 3)))

atts <- rbind(atts, cbind(colnames(df.sum)[i], round(cbind(cs.output.expand.agg.dyn.0$overall.att, 
      cs.output.expand.agg.dyn.0$overall.att - 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn.0$overall.att + 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn$overall.att, 
      cs.output.expand.agg.dyn$overall.att - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$overall.se, 
      cs.output.expand.agg.dyn$overall.att + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$overall.se), 3)))
z <- rbind(z, c(colnames(df.sum)[i], cs.output.expand$Wpval))

fig4.sum <- rbind(fig4.sum, 
                 data.frame(Outcome = colnames(df.sum)[i], 
                      Year = cs.output.expand.agg.dyn$egt, 
           Estimate = cs.output.expand.agg.dyn$att.egt, 
           CILB = cs.output.expand.agg.dyn$att.egt - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt,
           CIUB = cs.output.expand.agg.dyn$att.egt + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt))
}



rownames(fig4.sum) <- NULL
if (k == 1){atts.sum.full <- atts.sum[-1,]} else 
 if (k == 2){atts.sum.larger <- atts.sum[-1,]} else 
   {atts.sum.smaller <- atts.sum[-1,]}

}

#Event Study Plots
fig4.sum[-1,] %>%
  ggplot(mapping = aes(x = Year, y = Estimate)) +
  facet_wrap(~Outcome, scales = "free_y") +
  ylab("Percentage Points") +
  geom_vline(xintercept=-0.5, linetype = "dashed", color = "red") +
  geom_hline(yintercept=0, linetype = "dashed", color = "grey") +
  geom_point() + geom_errorbar(aes(ymin=CILB, ymax=CIUB), width=.2) +
  ggtitle("fig4 - Event Study") +
  theme_tufte_revised()



table.names <- rbind(cbind((df.sum %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(Treat) %>% summarise(n()))[2,2], 
            (df.sum %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(Treat) %>% summarise(n()))[1,2]), 
      cbind((df.sum %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(ZipFilter, Treat) %>% summarise(n()))[4,3], 
            (df.sum %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(ZipFilter, Treat) %>% summarise(n()))[3,3]), 
      cbind((df.sum %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(ZipFilter, Treat) %>% summarise(n()))[2,3], 
            (df.sum %>% mutate(Treat = ifelse(Att > 0, 'Treat','Control')) %>% group_by(ZipFilter, Treat) %>% summarise(n()))[1,3]))
 
## Table
rbind(atts.sum.larger, atts.sum.smaller) %>% 
   kable("html", booktabs = T, col.names = c("Outcome", "C_0", "T_0 - C_0", "DID Estimate", "LB", "UB")) %>%
  kable_styling(latex_options = c("striped")) %>%
  pack_rows(index = c("Profitable FQHCs" = 3, "Unprofitable/Budget Neutral FQHCs" = 3)) %>% 
  add_footnote(c("Atlman's Z is a measure of Financial Distress",
                 "C_0 and T_0 are mean values for each sample in control and treatment groups in first year of panel",
                 paste("Profitable FQHCs Sample has ", table.names[2,1], "treatment and ", table.names[2,2], " control FQHC-Years"), 
                 paste("Unprofitable and Budget Neutral FQHCs Sample has ", table.names[3,1], "treatment and ", table.names[3,2], " control FQHC-Years")))

## Better Figure
f4.picture.full <- rbind(cbind("Full Sample", atts.sum.full), cbind("Profitable", atts.sum.larger), cbind("Unprofitable/Budget Neutral", atts.sum.smaller) ) %>% 
  as.data.frame()

### Clean up the data
row.names(f4.picture.full) <- NULL
colnames(f4.picture.full) <- c("Profitability", "Measure", "C_0", "T_0 - C_0", "Estimate", "LB", "UB")
f4.picture.full[,3:7] <- sapply(f4.picture.full[,3:7], as.numeric)
# f4.picture.full$Sample <- factor(f4.picture.full$Sample, levels = c("Full Sample", "More Market Share","Less Market Share"))
# f4.picture.full$Payor <- gsub(f4.picture.full$Payor, pattern = ".z", replacement = "")
# f4.picture.full$Payor <- factor(f4.picture.full$Payor, levels = c("None", "MCR","COM","MCD","Total"))
# f4.picture.full$Model <- factor(f4.picture.full$Model, levels = c("Incumbent Only","Incumbent & Competitor"))
# f4.picture.full$Total <- ifelse(f4.picture.full$Payor == "Total", "Total", "Payor")
# f4.picture.full$Total <- factor(f4.picture.full$Total, levels = c("Total","Payor"))


### Plot
f4.p.totals.full <- ggplot(data=f4.picture.full, aes(y=Measure, x=Estimate, xmin=LB, xmax=UB)) +
geom_point() + 

#this changes the features of the overall effects
#one could resize, reshape, or recolor these points if desired
xlab("DID Estimates") + 
ylab(NULL) + 
#adds the CIs
geom_errorbarh(height=.1) +

#sets the scales
#note that I reverse the y axis to correctly order the effect #sizes based on my index variable
#scale_x_continuous(limits=c(-2.5,1), breaks = c(-2.5:1), name=xname)+
#scale_y_continuous(name = "", breaks=1:9, labels = t9.forest$X1, trans="reverse")+

#adding a vertical line at the effect = 0 mark
geom_vline(xintercept=0, color="black", linetype="dashed", alpha=.5)+

#faceting based on my subgroups
  #facet_wrap(~X1) +
facet_grid(~Profitability, scales= "free", switch = 'y', space = "free_y")+
 

#thematic stuff
#ggtitle("Figure 3 - ATT Estimates by SubGroups")+
theme_tufte_revised()+
   theme(strip.placement = "outside") +
#theme(text=element_text(family="Times",size=12, color="black"))+
theme(panel.spacing = unit(1, "lines")) +
  ggtitle("Figure 4, FQHC Performance Reactions by Profitability")

f4.p.totals.full
```


## True Figure 3 - Responses
```{r}

fig3 <- rbind(f3.picture.full %>% rename(Subgroup = MarketShare), f4.picture.full[-c(1:3),] %>% rename(Subgroup = Profitability)) %>% 
  mutate(Measure = ifelse(Measure == "Sites", "Number of Sites", 
                   ifelse(Measure == "Qcomp", "Quality of Care", 
                   ifelse(Measure == "Altmans.Z", "Financial Stability", NA))))

f3.full <- ggplot(data=fig3[1:3,], aes(y=Measure, x=Estimate, xmin=LB, xmax=UB)) +
  geom_point() + 

#this changes the features of the overall effects
#one could resize, reshape, or recolor these points if desired
xlab("DID Estimates") + 
ylab(NULL) + 
#adds the CIs
geom_errorbarh(height=.1) +

#sets the scales
#note that I reverse the y axis to correctly order the effect #sizes based on my index variable
#scale_x_continuous(limits=c(-2.5,1), breaks = c(-2.5:1), name=xname)+
#scale_y_continuous(name = "", breaks=1:9, labels = t9.forest$X1, trans="reverse")+

#adding a vertical line at the effect = 0 mark
geom_vline(xintercept=0, color="black", linetype="dashed", alpha=.5)+

#faceting based on my subgroups
  #facet_wrap(~X1) +
facet_grid(~Subgroup, scales= "free", switch = 'y', space = "free_y")+
 

#thematic stuff
#ggtitle("Figure 3 - ATT Estimates by SubGroups")+
theme_tufte_revised()+
   theme(strip.placement = "outside") +
#theme(text=element_text(family="Times",size=12, color="black"))+
theme(panel.spacing = unit(1, "lines")) 


f3.mark <- ggplot(data=fig3[4:9,], aes(y=Measure, x=Estimate, xmin=LB, xmax=UB)) +
  geom_point() + 

#this changes the features of the overall effects
#one could resize, reshape, or recolor these points if desired
xlab("DID Estimates") + 
ylab(NULL) + 
#adds the CIs
geom_errorbarh(height=.1) +

#sets the scales
#note that I reverse the y axis to correctly order the effect #sizes based on my index variable
#scale_x_continuous(limits=c(-2.5,1), breaks = c(-2.5:1), name=xname)+
#scale_y_continuous(name = "", breaks=1:9, labels = t9.forest$X1, trans="reverse")+

#adding a vertical line at the effect = 0 mark
geom_vline(xintercept=0, color="black", linetype="dashed", alpha=.5)+

#faceting based on my subgroups
  #facet_wrap(~X1) +
facet_grid(~Subgroup, scales= "free", switch = 'y', space = "free_y")+
 

#thematic stuff
#ggtitle("Figure 3 - ATT Estimates by SubGroups")+
theme_tufte_revised()+
   theme(strip.placement = "outside") +
#theme(text=element_text(family="Times",size=12, color="black"))+
theme(panel.spacing = unit(1, "lines")) 


f3.prof <- ggplot(data=fig3[10:15,], aes(y=Measure, x=Estimate, xmin=LB, xmax=UB)) +
  geom_point() + 

#this changes the features of the overall effects
#one could resize, reshape, or recolor these points if desired
xlab("DID Estimates") + 
ylab(NULL) + 
#adds the CIs
geom_errorbarh(height=.1) +

#sets the scales
#note that I reverse the y axis to correctly order the effect #sizes based on my index variable
#scale_x_continuous(limits=c(-2.5,1), breaks = c(-2.5:1), name=xname)+
#scale_y_continuous(name = "", breaks=1:9, labels = t9.forest$X1, trans="reverse")+

#adding a vertical line at the effect = 0 mark
geom_vline(xintercept=0, color="black", linetype="dashed", alpha=.5)+

#faceting based on my subgroups
  #facet_wrap(~X1) +
facet_grid(~Subgroup, scales= "free", switch = 'y', space = "free_y")+
 

#thematic stuff
#ggtitle("Figure 3 - ATT Estimates by SubGroups")+
theme_tufte_revised()+
   theme(strip.placement = "outside") +
#theme(text=element_text(family="Times",size=12, color="black"))+
theme(panel.spacing = unit(1, "lines")) 




gt <- grid.arrange(f3.full,                            
             f3.mark, f3.prof,                         
             ncol = 3, nrow = 2, 
             layout_matrix = rbind(c(1,  2, 2), c(1,  3, 3)))


# Add labels to the arranged plots
p <- as_ggplot(gt) +                                # transform to a ggplot
 draw_plot_label(label = c("Panel A", "Panel B", "Panel C"), size = 15,
                 x = c(0, 0.33, 0.33), y = c(1, 1, 0.5)) # Add labels
p


```


## Figure for Paper

```{r}
df.qual.exp %>% 
  filter(Year %in% c(2016, 2019)) %>% 
  mutate(Tx = ifelse(Att > 0, 1, 0)) %>% 
  group_by(Year, Tx) %>% 
  summarise(mean(Sites, na.rm = TRUE), 
            mean(Qcomp, na.rm = TRUE), 
            mean(Altmans.Z, na.rm = TRUE), 
            mean(Efficiency, na.rm = TRUE)) %>% 
  arrange(Tx, Year) %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(unadj = (V4 - V3) - (V2 - V1) )
```


## Figure for Poster

```{r}

poster.fig3 <- cbind(Group = c(rep("Panel A", 3),rep("Panel B", 6),rep("Panel C", 6)), fig3) %>% 
  mutate(Measure = as.factor(Measure)) %>% 
  mutate(Measure = fct_reorder(Measure, desc(Measure))) %>% 

ggplot(aes(y=Subgroup, x=Estimate, xmin=LB, xmax=UB)) +
geom_point() + 

#this changes the features of the overall effects
#one could resize, reshape, or recolor these points if desired
xlab("DID Estimates") + 
ylab(NULL) + 
#adds the CIs
geom_errorbarh(height=.1) +

#sets the scales
#note that I reverse the y axis to correctly order the effect #sizes based on my index variable
#scale_x_continuous(limits=c(-2.5,1), breaks = c(-2.5:1), name=xname)+
#scale_y_continuous(name = "", breaks=1:9, labels = t9.forest$X1, trans="reverse")+

#adding a vertical line at the effect = 0 mark
geom_vline(xintercept=0, color="black", linetype="dashed", alpha=.5)+

#faceting based on my subgroups
  #facet_wrap(~X1) +
facet_grid(Group~Measure, scales = "free", switch = 'y', space = "free_y")+

#thematic stuff
#ggtitle("Figure 3 - ATT Estimates by SubGroups")+
theme_tufte_revised()+
   theme(strip.placement = "outside") +
#theme(text=element_text(family="Times",size=12, color="black"))+
theme(panel.spacing = unit(1, "lines"),  strip.text =  element_text(face = "bold", size = 16))

poster.fig3
```



## Figure 5 - Financing

```{r}




df.comp <- df.qual.exp %>% #filter(`Grant Number` != "H80CS00225") %>% 
  ungroup() %>% 
  #inner_join(df.qual.exp %>% filter(Year == 2015 & Zips < 4.75) %>% select(`Grant Number`), by = c("Grant Number")) %>%  #& Zips < 3.75 or 4.75
  #filter(MarketShare > median(MarketShare, na.rm = TRUE)) %>% 
    select(Year, ZipFilter, ID, Att, `Total revenue (unrestricted & restricted)`, `Total net assets`, `Surplus as a pct of before dep expenses`, 
           `Staffing`, `Liabilities`, `Gross land, buildings and equipment (LBE)`, Liquidity, Profitability, Efficiency, NetWorth)
 
  

for (k in 1:3){
  
atts.comp <- rep(0, 7)
fig3.comp <- rep(0, 5)

if (k ==1){df.comp.root <- df.comp} else
  if (k == 2){df.comp.root <- df.comp %>% filter(ZipFilter == 2)} else
    if (k == 3){df.comp.root <- df.comp %>% filter(ZipFilter == 1)} 

  

for (i in 5:ncol(df.comp)){
  
 # if (i %in% c(6, 7, 19)){temp <- df.comp.root[df.comp.root$Year %in% c(2015:2019), c(1:4, i)]} else {temp <- df.comp.root[,c(1:4, i)]}
  temp <- df.comp.root[,c(1:4, i)]
  #temp <- df.comp.root[df.comp.root$Year %in% c(2015:2019), c(1:4, i)]
  colnames(temp) <- c("Year", "ZipFilter", "ID","Att", "Outcome")
  temp$Outcome
  
  # temp <- temp %>%
  #   mutate(Outcome = ifelse(Outcome < quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[1], quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[1],
  #                    ifelse(Outcome > quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[2], quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[2], Outcome)))

  
cs.output.expand <- att_gt( yname = "Outcome",
                      tname = "Year",
                      idname = "ID",
                      gname = "Att",
                      xformla = ~1,
                      data = temp, # %>% filter(Year >= 2016), 
                      control_group = "nevertreated",
                      clustervars = "ID",
                      panel = FALSE, 
                      base_period = "universal"
                      )
cs.output.expand.agg.dyn.0 <- aggte(cs.output.expand, type = "simple", na.rm = TRUE)
cs.output.expand.agg.dyn <- aggte(cs.output.expand, type = "dynamic", na.rm = TRUE)

atts.comp <- rbind(atts.comp, cbind(colnames(df.comp)[i], round(mean(temp[temp$Att == 0 & temp$Year == min(temp$Year),]$Outcome, na.rm = TRUE), 3), round(mean(temp[temp$Att > 0 & temp$Year == min(temp$Year),]$Outcome, na.rm = TRUE) - mean(temp[temp$Att == 0 & temp$Year == min(temp$Year),]$Outcome, na.rm = TRUE), 3), round(cbind(cs.output.expand.agg.dyn.0$overall.att, 
      cs.output.expand.agg.dyn.0$overall.att - 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn.0$overall.att + 1.96 * cs.output.expand.agg.dyn.0$overall.se), 3)))

atts <- rbind(atts, cbind(colnames(df.comp)[i], round(cbind(cs.output.expand.agg.dyn.0$overall.att, 
      cs.output.expand.agg.dyn.0$overall.att - 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn.0$overall.att + 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn$overall.att, 
      cs.output.expand.agg.dyn$overall.att - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$overall.se, 
      cs.output.expand.agg.dyn$overall.att + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$overall.se), 3)))
z <- rbind(z, c(colnames(df.comp)[i], cs.output.expand$Wpval))

fig3.comp <- rbind(fig3.comp, 
                 data.frame(Outcome = colnames(df.comp)[i], 
                      Year = cs.output.expand.agg.dyn$egt, 
           Estimate = cs.output.expand.agg.dyn$att.egt, 
           CILB = cs.output.expand.agg.dyn$att.egt - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt,
           CIUB = cs.output.expand.agg.dyn$att.egt + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt))
}



rownames(fig3.comp) <- NULL
if (k == 1){atts.comp.full <- atts.comp[-1,]} else 
 if (k == 2){atts.comp.larger <- atts.comp[-1,]} else 
   {atts.comp.smaller <- atts.comp[-1,]}

}

#Event Study Plots
fig3.comp[-1,] %>%
  ggplot(mapping = aes(x = Year, y = Estimate)) +
  facet_wrap(~Outcome, scales = "free_y") +
  ylab("Percentage Points") +
  geom_vline(xintercept=-0.5, linetype = "dashed", color = "red") +
  geom_hline(yintercept=0, linetype = "dashed", color = "grey") +
  geom_point() + geom_errorbar(aes(ymin=CILB, ymax=CIUB), width=.2) +
  ggtitle("fig3 - Event Study") +
  theme_tufte_revised()




 cbind(atts.comp.full, atts.comp.larger, atts.comp.smaller) %>% 
   kable("html", booktabs = T, col.names = rep(c("Outcome", "C_0", "T_0 - C_0", "DID Estimate", "LB", "UB"), 3)) %>%
  kable_styling(latex_options = c("striped")) %>%
  #pack_rows(index = c("Financial" = 5, "" = 5, "Profitability" = 5)) %>% 
  add_header_above(c(" " = 1, "Full" = 6, "More Market Share Clinics" = 6, "Less Market Share Clinics" = 6)) %>% 
  #pack_rows(index = c("Larger FQHCs" = 15, "Smaller FQHCs" = 15)) %>% 
  add_footnote(c(""))



```






## Figure 5 - Financing these changes


```{r}


df.fin <- df.qual.exp %>% #filter(`Grant Number` != "H80CS00225") %>% 
  ungroup() %>% 
  #filter(MarketShare > median(MarketShare, na.rm = TRUE)) %>% 
  select(`Grant Number`, Year, ID, Att, `Total revenue (unrestricted & restricted)`, `Total net assets`, `Surplus as a pct of before dep expenses`, 
           `Staffing`, `Liabilities`, `Gross land, buildings and equipment (LBE)`, Liquidity, Profitability, Efficiency, NetWorth) %>%
  inner_join(df.qual.exp %>% filter(Year == 2016) %>% mutate(ZipFilter = ifelse(`Surplus as a pct of before dep expenses` < 2, 1, 2)) %>% select(`Grant Number`, ZipFilter), by = c("Grant Number")) %>% 
    select(Year, ZipFilter, ID, Att, `Total revenue (unrestricted & restricted)`, `Total net assets`, `Surplus as a pct of before dep expenses`, 
           `Staffing`, `Liabilities`, `Gross land, buildings and equipment (LBE)`, Liquidity, Profitability, Efficiency, NetWorth)

for (k in 1:3){
  
atts.fin <- rep(0, 7)
fig3.fin <- rep(0, 5)

if (k ==1){df.fin.root <- df.fin} else
  if (k == 2){df.fin.root <- df.fin %>% filter(ZipFilter == 2)} else
    if (k == 3){df.fin.root <- df.fin %>% filter(ZipFilter == 1)} 

  

for (i in 5:ncol(df.fin)){
  
  temp <- df.fin.root[,c(1:4, i)]
  #temp <- df.fin.root[df.fin.root$Year %in% c(2015:2019), c(1:4, i)]
  colnames(temp) <- c("Year", "ZipFilter", "ID","Att", "Outcome")
  temp$Outcome
  
  # temp <- temp %>%
  #   mutate(Outcome = ifelse(Outcome < quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[1], quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[1],
  #                    ifelse(Outcome > quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[2], quantile(temp$Outcome, probs = c(0.05, 0.95), na.rm = TRUE)[2], Outcome)))

  
cs.output.expand <- att_gt( yname = "Outcome",
                      tname = "Year",
                      idname = "ID",
                      gname = "Att",
                      xformla = ~1,
                      data = temp, # %>% filter(Year >= 2016), 
                      control_group = "nevertreated",
                      clustervars = "ID",
                      panel = FALSE, 
                      base_period = "universal"
                      )
cs.output.expand.agg.dyn.0 <- aggte(cs.output.expand, type = "simple", na.rm = TRUE)
cs.output.expand.agg.dyn <- aggte(cs.output.expand, type = "dynamic", na.rm = TRUE)

atts.fin <- rbind(atts.fin, cbind(colnames(df.fin)[i], round(mean(temp[temp$Att == 0 & temp$Year == min(temp$Year),]$Outcome, na.rm = TRUE), 3), round(mean(temp[temp$Att > 0 & temp$Year == min(temp$Year),]$Outcome, na.rm = TRUE) - mean(temp[temp$Att == 0 & temp$Year == min(temp$Year),]$Outcome, na.rm = TRUE), 3), round(cbind(cs.output.expand.agg.dyn.0$overall.att, 
      cs.output.expand.agg.dyn.0$overall.att - 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn.0$overall.att + 1.96 * cs.output.expand.agg.dyn.0$overall.se), 3)))

atts <- rbind(atts, cbind(colnames(df.fin)[i], round(cbind(cs.output.expand.agg.dyn.0$overall.att, 
      cs.output.expand.agg.dyn.0$overall.att - 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn.0$overall.att + 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn$overall.att, 
      cs.output.expand.agg.dyn$overall.att - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$overall.se, 
      cs.output.expand.agg.dyn$overall.att + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$overall.se), 3)))
z <- rbind(z, c(colnames(df.fin)[i], cs.output.expand$Wpval))

fig3.fin <- rbind(fig3.fin, 
                 data.frame(Outcome = colnames(df.fin)[i], 
                      Year = cs.output.expand.agg.dyn$egt, 
           Estimate = cs.output.expand.agg.dyn$att.egt, 
           CILB = cs.output.expand.agg.dyn$att.egt - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt,
           CIUB = cs.output.expand.agg.dyn$att.egt + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$se.egt))
}



rownames(fig3.fin) <- NULL
if (k == 1){atts.fin.full <- atts.fin[-1,]} else 
 if (k == 2){atts.fin.larger <- atts.fin[-1,]} else 
   {atts.fin.smaller <- atts.fin[-1,]}

}

#Event Study Plots
fig3.fin[-1,] %>%
  ggplot(mapping = aes(x = Year, y = Estimate)) +
  facet_wrap(~Outcome, scales = "free_y") +
  ylab("Percentage Points") +
  geom_vline(xintercept=-0.5, linetype = "dashed", color = "red") +
  geom_hline(yintercept=0, linetype = "dashed", color = "grey") +
  geom_point() + geom_errorbar(aes(ymin=CILB, ymax=CIUB), width=.2) +
  ggtitle("fig3 - Event Study") +
  theme_tufte_revised()




 cbind(atts.fin.full, atts.fin.larger, atts.fin.smaller) %>% 
   kable("html", booktabs = T, col.names = rep(c("Outcome", "C_0", "T_0 - C_0", "DID Estimate", "LB", "UB"), 3)) %>%
  kable_styling(latex_options = c("striped")) %>%
  pack_rows(index = c("General Measures" = 4, "Altmans Z Components" = 5)) %>% 
  add_header_above(c(" " = 1, "Full" = 6, "Profitable" = 6, "Unprofitable" = 6)) %>% 
  #pack_rows(index = c("Larger FQHCs" = 15, "Smaller FQHCs" = 15)) %>% 
  add_footnote(c(""))
```



## True Figure 4
```{r}
fields <- 10
fig4 <- cbind(c(rep("Full", fields), rep("More Market Share", fields), rep("Less Market Share", fields), rep('Profitable', fields), rep('Unprofitable/Budget Neutral', fields)), 
      rbind(atts.comp.full, atts.comp.larger, atts.comp.smaller, atts.fin.larger, atts.fin.smaller)) %>% 
  data.frame() 

colnames(fig4) <- c("Subgroup", "Measure", "C_0", "T_0 - C_0", "Estimate", "LB", "UB")

fig4$Measure <- ifelse(fig4$Measure == 'Gross land, buildings and equipment (LBE)', 'Property and Buildings', fig4$Measure)


fig4$C_0 <- as.numeric(fig4$C_0)
fig4$`T_0 - C_0` <- as.numeric(fig4$`T_0 - C_0`)
fig4$Estimate <- as.numeric(fig4$Estimate)
fig4$LB <- as.numeric(fig4$LB)
fig4$UB <- as.numeric(fig4$UB)

fig4$Groups <- ifelse(fig4$Measure %in% c('Total revenue (unrestricted & restricted)','Property and Buildings','Staffing', 'Liabilities'), 'Mechanisms', 
               ifelse(fig4$Measure %in% c('Liquidity','Efficiency'), 'Financing', NA))

rownames(fig4) <- NULL



fig4 %>% 
  filter(Groups == 'Mechanisms' ) %>% 
ggplot(aes(y=Measure, x=Estimate, xmin=LB, xmax=UB)) +
geom_point() + 

#this changes the features of the overall effects
#one could resize, reshape, or recolor these points if desired
xlab("DID Estimates") + 
ylab(NULL) + 
#adds the CIs
geom_errorbarh(height=.1) +

#sets the scales
#note that I reverse the y axis to correctly order the effect #sizes based on my index variable
#scale_x_continuous(limits=c(-2.5,1), breaks = c(-2.5:1), name=xname)+
#scale_y_continuous(name = "", breaks=1:9, labels = t9.forest$X1, trans="reverse")+

#adding a vertical line at the effect = 0 mark
geom_vline(xintercept=0, color="black", linetype="dashed", alpha=.5) +

#faceting based on my subgroups
  #facet_wrap(~X1) +
facet_grid(~Subgroup, scales = "free_y", switch = 'y', space = "free_y")+
 

#thematic stuff
#ggtitle("Figure 3 - ATT Estimates by SubGroups")+
theme_tufte_revised()+
   theme(strip.placement = "outside") +
#theme(text=element_text(family="Times",size=12, color="black"))+
theme(panel.spacing = unit(1, "lines")) +
  ggtitle("Figure 2, Incumbent Only (FQHC-zip-year units)")



# fig4 %>% 
#   select(Measure:UB) %>% 
#   filter(Measure %notin% c('Total revenue (unrestricted & restricted)', 'Total expenses before depreciation', 'Surplus as a pct of before dep expenses')) %>% 
#   kable("html", booktabs = T, col.names = c("Outcome", "C_0", "T_0 - C_0", "DID Estimate", "LB", "UB")) %>%
#   kable_styling(latex_options = c("striped")) %>%
#   pack_rows(index = c("General Measures" = 4, "Altmans Z Components" = 5)) %>% 
#   add_header_above(c(" " = 1, "Full" = 6, "Profitable" = 6, "Unprofitable" = 6)) %>% 
#   #pack_rows(index = c("Larger FQHCs" = 15, "Smaller FQHCs" = 15)) %>% 
#   add_footnote(c(""))

library(formattable)
fig4$C_0 <- currency(fig4$C_0, digits = 0L)
fig4$`T_0 - C_0` <- currency(fig4$`T_0 - C_0`, digits = 0L)
fig4$Estimate <- currency(fig4$Estimate, digits = 0L)
fig4$LB <- currency(fig4$LB, digits = 0L)
fig4$UB <- currency(fig4$UB, digits = 0L)

fig4 %>% 
  filter(Groups == 'Mechanisms' ) %>% 
  select(Measure:UB) %>% 
  kable("html", booktabs = T, col.names = c("Outcome", "C_0", "T_0 - C_0", "DID Estimate", "LB", "UB")) %>%
  kable_styling(latex_options = c("striped")) %>%
  row_spec(c(6, 14),bold=T, italic = T, hline_after = T) %>% 
  row_spec(c(19),bold=F, italic = T, hline_after = T) %>% 
  pack_rows(index = c("Panel A: Full Sample" = 4, "Panel B: Higher Low-Income Market Share Subgroup" = 4, "Panel B: Lower Low-Income Market Share Subgroup" = 4, 
                      "Panel C: Profitable Subgroup" = 4, "Panel C: Unprofitable/Budget Neutral Subgroup" = 4)) %>% 
  #add_header_above(c(" " = 1, "Full" = 6, "Profitable" = 6, "Unprofitable" = 6)) %>% 
  #pack_rows(index = c("Larger FQHCs" = 15, "Smaller FQHCs" = 15)) %>% 
  add_footnote(c(""))

```






# Robustness Testing



## Service Area Overlap measurement - Plausible Exogeneity

- >99% of zips in sample have unmet Low income, Medicaid, or Uninsured need at baseline
- Distance of Rival's new zip code to nearest existing zip code in service area,  75% are below 10km. All those > 10km to nearest site are in rural areas traveling across very low density land
```{r}

## Need
df.z.full %>% 
  filter(Year == 2015) %>% 
  left_join(census, by = c("Zip" = "ZipCode", "Year" = "YEAR")) %>% 
  mutate(Pct.Total = Total.z / TotalPop, Pct.LowInc = Total.z / (IncomeBelowPoverty / PovertyStatusDet * TotalPop), Pct.MCD = MCD.z / (Medicaid / MCD.denom * TotalPop), Pct.None = None.z / (Uninsured / Unins.denom * TotalPop) ) %>% 
  select(Zip:Att.z, Pct.Total:Pct.None) %>% 
  mutate(NeedMore = ifelse(Pct.LowInc < 1 | Pct.MCD < 1 | Pct.None < 1, 1, 0), 
         Tx = ifelse(Att.z > 0, 1, 0)) %>% 
  #group_by(Tx) %>% 
  mutate(#n(), 
            NeedMore = NeedMore, 
            NeedLowIncome = ifelse(Pct.LowInc < 1, 1, 0), 
            NeedMCD = ifelse(Pct.MCD < 1, 1, 0),
            NeedNone = ifelse(Pct.None < 1, 1, 0)) %>% 
  select(Tx, NeedMore:NeedNone) %>% 
  filter(!is.na(NeedMore)) %>% 
  tbl_summary(by = Tx) %>% 
  add_p()


## Distance of Competitor to New Site
df.z.dist <- df.z.full %>% 
  filter(Att.z == Year) %>% 
  select(Zip:Total.z) %>% 
  left_join(uds.sites %>% select(`Grant Number`, Year, Zip) %>% unique(), by = c("Zip","Year")) %>% 
  left_join(df.z %>% filter(Tx == 1) %>% select(`Grant Number`, Year, Zip) %>% unique(), by = c("Zip","Year")) %>% 
  filter(`Grant Number.x` != `Grant Number.y`)

## Read in Centroid Data
zip.centroids <- read.csv("//Users/jhm65/Dropbox/Git/Data/ZIP_Code_Population_Weighted_Centroids.csv") %>% 
  mutate(ZipCode = str_pad(STD_ZIP5, 5, pad = "0")) %>% 
  select(ZipCode, X, Y)
## Add missing centroids
zip.centroids <- rbind(zip.centroids, c(ZipCode = "37243", X = -86.783, Y = 36.165), 
                                      c(ZipCode = "95951", X = -121.98, Y = 39.73)) %>% 
  mutate(X = as.numeric(X), Y = as.numeric(Y))

df.z.dist <- df.z.dist %>% mutate(DistToClosestSite = NA, ZipOfClosestSite = NA)

for (g in 1:nrow(df.z.dist)){
#g <- 3
 temp <- rbind(zip.centroids %>% filter(ZipCode == df.z.dist[g,]$Zip), 
          zip.centroids %>% filter(ZipCode %in% unique(uds.sites[uds.sites$`Grant Number` == df.z.dist[g,]$`Grant Number.x` & uds.sites$Year == df.z.dist[g,]$Year,]$Zip))) %>% 
   unique()
  mm <- as.matrix(dist(as.matrix(temp$X, temp$Y), method = "euclidean"))[-1,1]
  df.z.dist[g,]$DistToClosestSite <-  min(mm) * 111.139
  df.z.dist[g,]$ZipOfClosestSite  <- ifelse(is.na(temp[2,]$ZipCode), temp[1,]$ZipCode, unlist(temp[-1,]$ZipCode[rank(mm) == 1]))
}

df.z.dist[19,]$DistToClosestSite <- 0


mean(df.z.dist$DistToClosestSite)
quantile(df.z.dist$DistToClosestSite, probs = c(0, 0.1, 0.25, 0.5, 0.75, 0.9, 1))

mean(df.z.dist[df.z.dist$ZipFilter == 1,]$DistToClosestSite)
mean(df.z.dist[df.z.dist$ZipFilter == 2,]$DistToClosestSite)

quantile(df.z.dist[df.z.dist$ZipFilter == 1,]$DistToClosestSite, probs = c(0, 0.1, 0.25, 0.5, 0.75, 0.9, 1))
quantile(df.z.dist[df.z.dist$ZipFilter == 2,]$DistToClosestSite, probs = c(0, 0.1, 0.25, 0.5, 0.75, 0.9, 1))


zipsize <- zctas(starts_with = c(df.z.dist$Zip, df.z.dist$ZipOfClosestSite), year = 2010)


## Original Figure
df.z.dist.plot <- df.z.dist %>% 
  left_join(zipsize %>% select(GEOID10, ALAND10), by = c("Zip" = "GEOID10")) %>% 
  left_join(uds.sites %>% select(Zip, `Site State`) %>% unique(), by = c("Zip")) %>% 
  left_join(census %>% select(ZipCode, YEAR, TotalPop), by = c("Year" = "YEAR", "Zip" = "ZipCode")) %>% 
  arrange(desc(DistToClosestSite)) %>% 
  mutate(Area.SQmiles = ALAND10 / 2.59e6) %>% 
  mutate(Density.NewZip = TotalPop / Area.SQmiles, 
         l.density = log(TotalPop / Area.SQmiles))


df.z.dist.plot %>% 
  ggplot(aes(x = log(Density.NewZip), y = DistToClosestSite)) + geom_point(aes(size = Area.SQmiles)) +
  ggtitle("Distance from Rival's newly competing zip ocde to closest incumbent zip code by Density and Area of newly competing zip code")

summary(lm(DistToClosestSite ~ log(Density.NewZip), data = df.z.dist.plot))



# Updated Figure
df.z.dist.plot <- df.z.dist.plot %>% 
  select(Zip:ZipOfClosestSite, Density.NewZip) %>% 
  left_join(zipsize %>% select(GEOID10, ALAND10), by = c("ZipOfClosestSite" = "GEOID10")) %>% 
  left_join(uds.sites %>% select(Zip, `Site State`) %>% unique(), by = c("ZipOfClosestSite" = "Zip")) %>% 
  left_join(census %>% select(ZipCode, YEAR, TotalPop), by = c("Year" = "YEAR", "ZipOfClosestSite" = "ZipCode")) %>% 
  arrange(desc(DistToClosestSite)) %>% 
  mutate(Area.SQmiles = ALAND10 / 2.59e6) %>% 
  mutate(Density.Origin = TotalPop / Area.SQmiles)


df.z.dist.plot %>% 
  ggplot(aes(x = log(Density.NewZip), y = DistToClosestSite, color = log(Density.Origin))) + geom_point() +
  scale_colour_gradientn(colours = terrain.colors(10))+ theme_minimal()+
  ylab("Distance from Competative to closest Rival Site (km)") +
  ggtitle("Distance from newly competative Zip to Rival's closest existing zip, by log Density of areas")


p <- df.z.dist.plot %>% 
  ggplot(aes(x = log(Density.Origin), y = log(Density.NewZip))) + 
  geom_point(aes(size = DistToClosestSite, colour = DistToClosestSite)) + 
  scale_colour_gradientn(colours = c("green","lightblue","purple"),
                         values = c(1.0,0.7,0.1,0))  +#scale_colour_gradientn(colours = terrain.colors(10))+ 
  theme_minimal() + ylab("Log Population Density of New Zip Code") + 
  xlab("Log Population Density of Nearest Service Area Zip Code") + 
  labs(color = "Distance Travelled to\nOpenNew Site (km)") + 
  guides(size = FALSE) + xlim(0.5, 11.5) + ylim(0.5, 11.5)
p


summary(lm(log(Density.Origin) ~ log(Density.NewZip), data = df.z.dist.plot))


```


## Estimate effects of competition on nearest FQHC, takes 20 minutes to run code
```{r}

## Build the first part of the dataset

df.spill <- df.z %>% 
  left_join(df.z.dist %>% 
  select(`Grant Number.y`, Zip) %>% 
    unique() %>% 
    rename(ZipOfComp = Zip), by = c("Grant Number" = "Grant Number.y")) %>% 
  #filter(!is.na(ZipOfComp)) %>% 
  mutate(ZipOfComp = ifelse(`Grant Number` == "H80CS00765", 95991, ZipOfComp)) %>% 
  left_join(zip.centroids, by = c("Zip" = "ZipCode")) %>% 
  left_join(zip.centroids, by = c("ZipOfComp" = "ZipCode")) %>% 
  mutate(Dist = sqrt((X.x - X.y) ^ 2 + (Y.x - Y.y) ^ 2) * 111.139) %>% 
  mutate(Dist.f = ifelse(is.na(Dist), "-1",
                  ifelse(Dist == 0, 0, 
                  ifelse(Dist > 0 & Dist < 20, 1, 
                  ifelse(Dist >= 20 & Dist < 50, 2, 3))))) %>% 
  #filter(is.na(Dist.f) | Dist.f == 2) %>% 
  left_join(uds.sites %>% 
              filter(`Location Setting` %in% c("All Other Clinic Types")) %>% 
              mutate(Type.num = ifelse(`Location Type` == "Seasonal", 0.33, 
                                ifelse(`Location Type` == "Mobile Van", 0.66, 1)), 
                     Schedule = ifelse(`Operational Schedule` == "Full-Time", 1, 
                                ifelse(`Operational Schedule` == "Part-Time", 0.5, 0)),
                     Calendar = ifelse(`Calendar Schedule` == "Year-Round", 1,
                                ifelse(`Calendar Schedule` == "Seasonal", 0.5, 0))) %>% 
              group_by(`Grant Number`, Year, Zip) %>% 
              summarise(Sites = n(), Mean.Hours = mean(Access, na.rm = TRUE), Total.Hours = sum(Access, na.rm = TRUE), 
                        Perminance = sum(Type.num, na.rm = TRUE), Schedule = sum(Schedule, na.rm = TRUE), Calendar = sum(Calendar, na.rm = TRUE)), by = c("Grant Number","Year", "Zip")) %>% 
  mutate(Sites = ifelse(is.na(Sites), 0, Sites), 
         Mean.Hours = ifelse(is.na(Mean.Hours), 0, Mean.Hours), 
         Total.Hours = ifelse(is.na(Total.Hours), 0, Total.Hours), 
         Perminance = ifelse(is.na(Perminance), 0, Perminance), 
         Schedule = ifelse(is.na(Schedule), 0, Schedule), 
         Calendar = ifelse(is.na(Calendar), 0, Calendar))

dist.vecs <- df.spill[!is.na(df.spill$Dist),]$Dist

df.spill %>% 
  group_by(Dist.f) %>% 
  summarise(n())



## Find neighbors based on some circle around FQHC zip

mm <- dist(zip.centroids[,2:3])
mm <- as.matrix(mm) * 111.139

mm.2 <- mm[zip.centroids$ZipCode %in% unique(df.spill$Zip),]

mm.2 <- as.matrix((mm.2 < 50) + 0 )
rowSums(mm.2)



mm.3 <- c(CenterZip = 0, Year = 0, Competing.Sites = 0)
for (g in 1:dim(mm.2)[1]){
  mm.3 <- rbind(mm.3, cbind(CenterZip = zip.centroids[rownames(mm.2)[g],]$ZipCode, zip.centroids[names(mm.2[g,][which(as.vector(mm.2[g,] == 1))]),]) %>% 
  left_join(uds.sites %>% filter(Year %in% c(2015:2019)) %>% group_by(Year, Zip) %>% summarise(Sites.Total = n()), by = c("ZipCode" = "Zip")) %>% 
  left_join(df.spill %>% select(`Grant Number`, Year, Zip, Sites), by = c("ZipCode" = "Zip", "Year")) %>% 
  mutate(Sites.Total = ifelse(is.na(Sites.Total), 0, Sites.Total), 
         Sites = ifelse(is.na(Sites), 0, Sites), 
         Competing.Sites = Sites.Total - Sites) %>% 
  filter(CenterZip != ZipCode) %>% 
  group_by(CenterZip, Year) %>% 
  summarise(Competing.Sites = sum(Competing.Sites)) %>% 
    as.matrix())
}

mm.3 <- mm.3[-1,]

#mm.100 <- mm.3 %>% data.frame() 
#mm.60 <- mm.3 %>% data.frame() 
#mm.50 <- mm.3 %>% data.frame() 
#mm.20 <- mm.3 %>% data.frame() 
#mm.10 <- mm.3 %>% data.frame() 

#mm.3 <- mm.50 


```


```{r}
cs.output.expand <- att_gt( yname = "Total.Hours",
                      tname = "Year",
                      idname = "ID",
                      gname = "Att",
                      xformla = ~1,
                      data = df.spill %>% filter(Dist.f %in% c("-1",3)), # %>% filter(Year > 2015),
                      control_group = "nevertreated",
                      clustervars = "ID",
                      panel = TRUE,
                      base_period = "universal"
                      )
aggte(cs.output.expand, type = "simple", na.rm = TRUE)
```



## Control for spatial Spillovers
```{r}



df.spill2 <- df.spill %>% 
  left_join(mm.3 %>% data.frame() %>% mutate(Year = as.numeric(Year)), by = c("Zip" = "CenterZip","Year")) %>% 
  mutate(Competing.Sites = as.numeric(ifelse(is.na(Competing.Sites), 0, Competing.Sites)), 
         D = ifelse(Competing.Sites > 0, 1, 0))

#length(unique(df.spill2[is.na(df.spill2$Dist),]$Zip))  1893 or 1893 * 5

set.seed(234)  #232
df.spill2 <- df.spill2 %>% mutate(Dist = ifelse(is.na(Dist), rep(sample(dist.vecs, 1893, replace = T), each = 5), Dist), 
                                  Att.viz = ifelse(Att == 0, rep(sample(c(2017:2019), 1893, replace = T), each = 5), Att)) %>% 
  mutate(Dist.rounded = as.factor(ceiling(Dist / 10))) 


df.spill2 <- df.spill2 %>% 
  ungroup() %>% 
  #filter(MarketShare < median(MarketShare, na.rm = TRUE)) %>% 
  select(`Grant Number`, Tx, D, Att, Att.viz, Dist, Dist.rounded, Year, Zip, Total.Hours, Sites, Perminance, Schedule, Calendar, Total.z, MCD.z, MCR.z, COM.z, None.z) %>%
  inner_join(df.qual.exp %>% filter(Year == 2016) %>% mutate(ZipFilter = ifelse(`Surplus as a pct of before dep expenses` < 2, 1, 2)) %>% select(`Grant Number`, ZipFilter), by = c("Grant Number")) %>% 
    select(Tx, D, Dist, Year, Zip, `Grant Number`, ZipFilter, Att, Att.viz, Dist.rounded, Total.Hours, Sites, Perminance, Schedule, Calendar, Total.z, MCD.z, MCR.z, COM.z, None.z) # %>% filter(ZipFilter == 2)

  i <- 11
  df.temp <- df.spill2[,c(1:5, i)]
  names(df.temp) <- c("Tx", "D", "Dist", "Year", "Zip", 'Outcome')
  model_feols_clustered <- feols(Outcome ~ Tx*as.numeric(Dist / 10) + D | Year + Zip, cluster = ~ Zip, data = df.temp)
  TEs <- data.frame(model_feols_clustered$coeftable)[1,]
  TEs_Dist <- data.frame(model_feols_clustered$coeftable)[nrow(model_feols_clustered$coeftable),]


for (i in 12:20){
  df.temp <- df.spill2[,c(1:5, i)]
  names(df.temp) <- c("Tx", "D", "Dist", "Year", "Zip", 'Outcome')
  model_feols_clustered <- feols(Outcome ~ Tx*as.numeric(Dist / 10) + D | Year + Zip, cluster = ~ Zip, data = df.temp)
  TEs <- rbind(TEs, data.frame(model_feols_clustered$coeftable)[1,])
  TEs_Dist <- rbind(TEs_Dist, data.frame(model_feols_clustered$coeftable)[nrow(model_feols_clustered$coeftable),])
}



p.spill <- df.spill2 %>% 
  mutate(Treats = ifelse(Att == 0 & Year >=  Att.viz, 1, Tx)) %>% 
  filter(Att > 0) %>% 
  group_by(Dist.rounded, Treats) %>% 
  summarise(Counts = n(), Sites = mean(Sites, na.rm = TRUE), Total.z = mean(Total.z, na.rm = TRUE), Total.Hours = mean(Total.Hours, na.rm = TRUE), MCD.z = mean(MCD.z, na.rm = TRUE)) %>% 
  pivot_wider(id_cols = Dist.rounded, names_from = Treats, values_from = c(Counts, Sites, Total.z, Total.Hours, MCD.z)) %>% 
  mutate(Sites = Sites_1 - Sites_0, 
         Total.z = Total.z_1 - Total.z_0, 
         Total.Hours = Total.Hours_1 - Total.Hours_0, 
         MCD.z = MCD.z_1 - MCD.z_0) %>% 
  left_join(df.spill2 %>% 
  mutate(Treats = ifelse(Att == 0 & Year >= Att.viz, 1, Tx)) %>% 
  filter(Att == 0) %>% 
  group_by(Dist.rounded, Treats) %>% 
  summarise(Counts = n(), Sites = mean(Sites, na.rm = TRUE), Total.z = mean(Total.z, na.rm = TRUE), Total.Hours = mean(Total.Hours, na.rm = TRUE), MCD.z = mean(MCD.z, na.rm = TRUE)) %>% 
  pivot_wider(id_cols = Dist.rounded, names_from = Treats, values_from = c(Counts, Sites, Total.z, Total.Hours, MCD.z)) %>% 
  mutate(Sites.control = Sites_1 - Sites_0, 
         Total.z.control = Total.z_1 - Total.z_0, 
         Total.Hours.control = Total.Hours_1 - Total.Hours_0, 
         MCD.z.control = MCD.z_1 - MCD.z_0) %>% 
    select(Dist.rounded, Sites.control:MCD.z.control), by = c("Dist.rounded")) %>% 
  mutate( Locations = Sites - Sites.control, 
         `Patients` = Total.z - Total.z.control, 
         `Patients - Medicaid Only` = MCD.z - MCD.z.control, 
         `Hours per Week` = Total.Hours - Total.Hours.control) %>% 
  select(Dist.rounded:Counts_1, `Locations`:`Hours per Week`) %>% 
  mutate(Dist.rounded = as.numeric(paste(Dist.rounded, 0, sep = ""))) %>% 
  pivot_longer(cols = c( `Locations`:`Hours per Week`)) %>% 
  mutate(`Treated Zips` = Counts_0 / 3) %>% 
  ggplot(aes(x = Dist.rounded, y = value)) + geom_point(aes(size = `Treated Zips`)) + facet_wrap(~name, scales = "free_y", ncol = 2) + xlim(0, 200) + 
  xlab("Kilometers to Competitive Zip") + ylab("Unadjusted Difference-in-differences") + theme_tufte_revised() + 
  geom_smooth(method = "lm", se = F, quiet = TRUE, formula = "y ~ x", mapping = aes(weight = `Treated Zips`)) + 
  geom_hline(yintercept=0, linetype = "dashed", color = "grey") + theme(text = element_text(size = 16)) + theme(title = element_text(face = "bold")) + 
  ggtitle("Figure 4 - Unadjusted DID Estimates by Distance to Competitive Zip")



suppressWarnings(print(p.spill))


output <- cbind(TEs %>% 
  mutate(`95% LB` = Estimate - `Std..Error` * 1.96, 
         `95% UB` = Estimate + `Std..Error` * 1.96) %>% 
    select(Estimate,`95% LB`, `95% UB`) , 

TEs_Dist %>% 
  mutate(`95% LB` = Estimate - `Std..Error` * 1.96, 
         `95% UB` = Estimate + `Std..Error` * 1.96) %>% 
    select(Estimate,`95% LB`, `95% UB`)) 
rownames(output) <- c("Hours Per Week","Locations","Perminance","Weekly Schedule","Calendar Schedule","Total","Medicaid","Medicare","Commerical","Uninsured")



round(output[c(6:10, 2,3, 1, 4, 5),], digits = 3) %>% 
  kable("html", booktabs = T, col.names = c("DID Estimate", "95% LB", "95% UB", "DID Estimate", "95% LB", "95% UB")) %>%
  kable_styling(latex_options = c("striped")) %>%
  pack_rows(index = c("Patient Panel" = 5, "Extensive Margin" = 2, "Intensive Margin" = 3)) %>% 
  add_header_above(c(" " = 1, "Treatment Effect" = 3, "Treatment Effect * Distance" = 3)) %>% 
  add_footnote(c("Treatment Effect is the ATT estimated in the zip code where the rival opens their new location","Treatment Effect * Distance is the change in the ATT for every 10km an outlying zip code in the incumbent's service area is from the competitive zip "))
```


## Preperiod parallel trends
```{r}

i <- 4
df.temp2 <- df.spill2 %>% filter(Att == 0 | Year < Att) %>% mutate(Treat = ifelse(Att > 0, 1, 0)) %>% 
                   select(Year, Treat, Zip, Total.Hours:None.z)
df.temp2 <- df.temp2[,c(1:3, i)]
names(df.temp2) <- c('Year','Treat','Zip','Outcome')

parallel.trends.set <- data.frame(feols(Outcome ~ Treat * Year, 
                 data = df.temp2)$coeftable)[4,]

for (i in 5:13){
  df.temp2 <- df.spill2 %>% filter(Att == 0 | Year < Att) %>% mutate(Treat = ifelse(Att > 0, 1, 0)) %>% 
                   select(Year, Treat, Zip, Total.Hours:None.z)
df.temp2 <- df.temp2[,c(1:3, i)]
names(df.temp2) <- c('Year','Treat','Zip','Outcome')

parallel.trends.set <- rbind(parallel.trends.set, data.frame(feols(Outcome ~ Treat * Year , 
                 data = df.temp2)$coeftable)[4,])
}
parallel.trends.set
```


## Again, with did2s
```{r}
did2s(
      data = df.spill2 , 
      yname = "Total.Hours", 
      treatment = "Tx",
        first_stage = ~ 0 | Zip + Year + D, 
        second_stage = ~ i(Tx, ref = FALSE) + as.numeric(Dist / 10) + I(Tx *as.numeric(Dist / 10)),
        cluster_var = "Zip",
      verbose = FALSE
    )

spill.es <- event_study(data = df.spill2,# %>% filter(ZipFilter == 2), 
  yname = "Total.Hours", idname = "Zip", tname = "Year", gname = "Att", estimator = "all", xformla = ~1) 



spill.es %>% 
  filter(estimator %notin% c("Borusyak, Jaravel, Spiess (2021)")) %>% 
  filter(abs(term) <= 3) %>% 
  ggplot(aes(x = term, y = estimate, color = estimator)) + geom_point(position = position_dodge(0.9)) + geom_errorbar(aes(ymin=estimate-1.96*std.error, ymax=estimate+1.96*std.error), width=.2, position = position_dodge(0.9))  + 
  #facet_wrap(~V1, scales = "free_y", ncol = 3) + 
  theme_tufte_revised() + geom_vline(xintercept=-0.5, color="red", linetype="dashed", alpha=.5) + 
  geom_hline(yintercept=0, color="black", linetype="dashed", alpha=.5) 

```


## How do close versus far zip codes compare

```{r}

df.temp3 <- df.spill2 %>% 
  left_join(census, by = c("Zip" = "ZipCode", "Year" = "YEAR" )) %>% 
    filter(Year %in% c(2015:2016) & Att > 0) %>% 
  mutate(Pct.Age = Age65andOver / TotalPop * 100, 
         Pct.Pov = IncomeBelowPoverty / PovertyStatusDet * 100, 
         Pct.HL = Hispanic / TotalPop * 100, 
         Pct.Black = Black / TotalPop * 100,
         Pct.White = White / TotalPop * 100,
         Pct.Unemp = Unemployed / Unemp_denom * 100,
         Pct.MCD = Medicaid / MCD.denom * 100, 
         Pct.NoIns = Uninsured / Unins.denom * 100) %>% 
  select(Dist, Pct.Age, Pct.HL, Pct.Black, Pct.White, Pct.Pov, Pct.Unemp, Pct.MCD, Pct.NoIns)

ziptypes <- data.frame(0, 0, 0, 0)
for (k in 2:ncol(df.temp3)){
  df.temp4 <- df.temp3[,c(1, k)]
  names(df.temp4) <- c('Dist','Outcome')
  
  ziptypes <- rbind(ziptypes, summary(lm(data = df.temp4, Outcome ~ as.numeric(Dist / 10) ))$coeff[2,])
}
ziptypes <- ziptypes[-1,]

rownames(ziptypes) <- c("% age over 65+","% Hispanic/Latino","% Black","% White", "% Poverty","% Unemployed","% Medicaid","% Uninsured")

ziptypes %>% 
  mutate(Estimate = X0, 
         `95% LB` = X0 - X0.1 * 1.96, 
         `95% UB` = X0 + X0.1 * 1.96, 
         `p-value` = X0.3) %>% 
  select(Estimate:`p-value`) %>% 
  kable("html", booktabs = T) %>%
  kable_styling(latex_options = c("striped")) %>%
  pack_rows(index = c("Demographics" = 4, "Income" = 2, "Insurance" = 2)) %>% 
  row_spec(c(1, 4), bold = T, hline_after = T) %>% 
  row_spec(c(3, 5:8), italic = T, hline_after = T) %>% 
  add_footnote(c("For every 10 km between the competing zip code and the zip code of interest, the covariate rate will change by the estimated coefficient"))

```






## Balance on Covariates
```{r}



df.qual.exp %>% 
  mutate(Treat = ifelse(Att > 0, 1, 0)) %>% 
  mutate(Groups = ifelse(Treat == 1 & Expandor == 0, "Treated", 
                  ifelse(Treat == 0 & Expandor == 0, "Control", 
                  ifelse(Treat == 0 & Expandor == 1, "Expandor Comp", "Expandor No Comp")))) %>% 
  filter(Year == 2015) %>%  #z & ZipFilter == 2) %>% 
  select(Sites, Zips, #MarketShare, 
         Total, Density, Pct.Rural, Pct.Urban, None:MCD, IMM2yo:DepScrn, Groups, Pct.NHA:Pct.NHW, Pct.LessThan200pctFPL, Pct.Homeless:Pct.Children, `Liabilities (as pct of assets)`, `Gross land, buildings and equipment (LBE)`, `Surplus as a pct of after dep expenses`) %>% #SwitchEMR, InterOrgHITexchange, UDSQualRep.highlowuse, 
  tbl_summary(by = Groups, 
              statistic = all_continuous() ~ "{mean} ({sd})") %>% 
  add_p(test = everything() ~ "t.test") 

```


## Treated vs Rivals
```{r}

# rbind(uds.covariates %>% filter(Year == 2015 & `Grant Number` %in% c(unique(df.z.dist.plot$`Grant Number.x`)) ) %>% mutate(Class = "Incumbent"), 
#       uds.covariates %>% filter(Year == 2015 & `Grant Number` %in% c(unique(df.z.dist.plot$`Grant Number.y`)) ) %>% mutate(Class = "Rival")) %>% 
#   tbl_summary(by = Class) %>% 
#   add_p()
  

```


## Mapping Quality Function
```{r}
p <- seq(0, 1, 0.05)
v <- c(1:10)


for (i in 1:10){
  p <- i / 10
  y <- 1 - (1 - p)^v
  y.prime = -(1 - p)^v*log(1 - p) - y/v
  #plot(v, y, main = paste("p = ", p, sep = "")) ## For regular trade offs
  plot(v, y.prime, main = paste("p = ", p, sep = "")) ## for denominator sign checking
}


## Checking the total differential on quality to see what happens
dd <- merge(merge(seq(0.2, 0.8, 0.05), c(1:5)) %>% rename(p = x, v = y), 
        c(seq(-5, -1, 0.5), seq(1, 5, 0.5)) ) %>% 
  rename(dv = y) %>% 
  mutate(dp = (-(1 - p)^v*log(1 - p) - (1 - (1 - p)^v)/v)*( v*(1 - p)^(v-1) )^-1 * dv) %>% 
    mutate(dq = -(1 - p)^v*log(1 - p) * dv + v*(1 - p)^(v-1) * dp) %>% 
  filter(dv > -abs(v))
  
summary(dd[complete.cases(dd),]$dq)

dd %>% filter(dq == min(dd$dq, na.rm = TRUE))
dd %>% filter(dq == max(dd$dq, na.rm = TRUE))

plot(dd[dd$v == 3,]$dv, dd[dd$v == 3,]$dq)


ggplot(data = dd, aes(x = p, y = dq, color = dv)) + geom_point() + facet_wrap(~v)

summary(df.qual.exp$Qcomp)

```





## Placebo


```{r}

df.placebo <- df.qual.exp %>% 
  #filter(ZipFilter == 2) %>% 
select(Year, ID, Att, Pct.NHA:Pct.Children) 
# %>% 
#   inner_join(df.qual.exp %>% filter(Year == 2016) %>% mutate(ZipFilter = ifelse(`Surplus as a pct of before dep expenses` < 2, 1, 2)) %>% select(ID, ZipFilter), by = c("ID")) %>% 
#   filter(ZipFilter == 2) %>% 
#     select(Year, ID, Att, Pct.NHA:Pct.Children) 



atts.placebo <- rep(0, 7)
for (i in 5:ncol(df.placebo)){
  
  temp <- df.placebo[,c(1:3, i)]
  colnames(temp) <- c("Year","ID","Att","Outcome")
  
  
cs.output.expand <- att_gt( yname = "Outcome",
                      tname = "Year",
                      idname = "ID",
                      gname = "Att",
                      xformla = ~1,
                      data = temp,
                      control_group = "nevertreated",
                      clustervars = "ID",
                      panel = FALSE, 
                      base_period = "universal"
                      )
cs.output.expand.agg.dyn.0 <- aggte(cs.output.expand, type = "simple", na.rm = TRUE)
cs.output.expand.agg.dyn <- aggte(cs.output.expand, type = "dynamic", na.rm = TRUE)

atts.placebo <- rbind(atts.placebo, cbind(colnames(df.placebo[,i]), round(cbind(cs.output.expand.agg.dyn.0$overall.att, 
      cs.output.expand.agg.dyn.0$overall.att - 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn.0$overall.att + 1.96 * cs.output.expand.agg.dyn.0$overall.se, 
      cs.output.expand.agg.dyn$overall.att, 
      cs.output.expand.agg.dyn$overall.att - cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$overall.se, 
      cs.output.expand.agg.dyn$overall.att + cs.output.expand.agg.dyn$crit.val.egt * cs.output.expand.agg.dyn$overall.se), 3)))

}

#if (k == 1){atts.placebo.larger <- atts.placebo[-1,]} else {atts.placebo.smaller <- atts.placebo[-1,]}

#rownames(atts.placebo.larger) <- NULL
#atts.placebo.larger
#atts.placebo.smaller

as.data.frame(atts.placebo[-1,]) %>% 
  rename(Measure = V1, Estimate = V2, `95%CI_LB` = V3, `95%CI_UB` = V4)
```






## multiple hypothesis correction, pre-period parallel trends
```{r}


# rownames(atts) <- rep(NULL, nrow(atts))
# if (k == 1){atts.larger <- atts} else {atts.smaller <- atts}
# 

# p-values rankings, Benjamini-Hochberg procedure
cbind(Sample = c(rep("Panel A: Full Sample", 3), 
                    rep("Panel B: Higher Low-Income Market Share Subgroup", 3), 
                    rep("Panel B: Lower Low-Income Market Share Subgroup", 3), 
                    rep("Panel C: Profitable Subgroup", 3), 
                    rep("Panel C: Unprofitable/Budget Neutral Subgroup", 3)), 
  data.frame(Outcome = atts[c(2:16),c(1)], Estimate = atts[c(2:16),c(2)], CI = paste("(", atts[c(2:16),3], ", ", atts[c(2:16),4], ")", sep = ""), p.value =  c(2*pnorm(-abs(as.numeric(atts[c(2:16),2]) / ((as.numeric(atts[c(2:16),4]) - as.numeric(atts[c(2:16),3])) / (2 * 1.96)))))))      %>% 
     arrange(p.value) %>%  
    mutate(rank = row_number(), 
           rank / 14 * 0.1) %>% 

  kable("html", booktabs = T, col.names = c("Sample","Outcome", "Estimate", "95% CI", "p-value", "Rank", "BH-procedure Threshold")) %>%
  kable_styling(latex_options = c("striped")) %>% 
  row_spec(c(1:6), italic = T, hline_after = T, background = "lightgrey")
  



# parallel trends
if (k == 1){z.larger <- z[-1,]} else {z.smaller <- z[-1,]}

# length(z.larger)
# length(z.smaller)
cbind(atts[c(2:16),1], z[c(2:16),2])
cbind(atts[atts[,1] %in% c('Total revenue (unrestricted & restricted)','Total net assets','Staffing', 'Liabilities'),1], z[atts[,1] %in% c('Total revenue (unrestricted & restricted)','Total net assets','Staffing', 'Liabilities'),2])


```
















## What's happening in the control? Let's think

```{r}

df.space <- df.qual.exp %>% 
  filter(Att > 0) %>% 
  select(`Grant Number`, Year) %>% 
  unique() %>% 
  left_join(uds.sites %>% select(`Grant Number`, Year, Zip), by = c("Grant Number","Year")) %>% 
  left_join(clinics.in.zips, by = c("Zip","Year")) %>% 
  
#  filter(`Grant Number` == "H80CS00881")
  group_by(Zip) %>% 
  filter(max(Clinics) > 1) %>% 
  unique() %>% 
  left_join(uds.sites %>% select(`Grant Number`, Zip, Year), by = c("Zip","Year")) %>% 
  rename(Incumbent = `Grant Number.x`, Competitor = `Grant Number.y`) %>% 
  filter(Incumbent != Competitor) %>% 
  group_by(Zip, Incumbent, Competitor) %>% 
  summarise(YearFirstComp = min(Year))%>% 
  arrange(Incumbent)

#df.space %>%  filter(Incumbent == "H80CS00881")


df.z.2 <- df.space %>% 
  pivot_longer(Incumbent:Competitor) %>% 
  left_join(uds.zip.totals, by = c("value" = "Grant Number")) %>% 
    ungroup() %>% 
  mutate(ID = as.numeric(as.factor(paste(Zip, name, value)))) %>% 
  mutate(year.rel = `Reporting Year` - YearFirstComp, 
         Treat = ifelse(name == "Incumbent", 1, 0), 
         Post = ifelse(year.rel >= 0, 1, 0))

df.z.2$year.rel <- relevel(as.factor(df.z.2$year.rel), ref = "-1")


# Are incumbents and controls really that different?  not really
df.z.2 %>% 
  select(value, name, `Reporting Year`, None:Total) %>% 
  unique() %>% 
  left_join(uds.covariates, by = c("value" = "Grant Number", "Reporting Year" = "Year")) %>% 
  left_join(uds.6b.rates, by = c("value" = "GrantNumber", "Reporting Year" = "Year")) %>% 
  filter(`Reporting Year` == 2015) %>% 
  filter(value != 'H80CS28975') %>% 
  select(name, Total, None:Pct.Children, IMM2yo:DepScrn) %>% 
  mutate(None = None / Total, 
         MCD = MCD / Total, 
         MCR = MCR / Total, 
         COM = COM / Total) %>% 
  tbl_summary(by = name, 
              statistic = all_continuous() ~ "{mean} ({sd})") %>% 
  add_p(test = everything() ~ "t.test")


summary(lm(data = df.z.2, Total ~ Treat*year.rel))



# Competitors in the competative zip

df.space %>% 
  left_join(df.qual.exp %>% select(`Grant Number`, Att), by = c("Incumbent" = "Grant Number")) %>% 
  left_join(uds.zip, by = c("Zip" = "Zip Code","Competitor" = "Grant Number")) %>% 
  filter(`Reporting Year` %in% c(2015:2019)) %>% 
  mutate(year.rel = `Reporting Year` - Att, 
         Tx = ifelse(`Reporting Year` - Att >= 0 , 1, 0)) %>% 
  ggplot(aes(x = year.rel, y = `Total Number of Patients`, group = Tx)) + geom_point() + geom_smooth(method = "lm") #+ ylim(0, 2000)



df.space1 <- df.space %>% 
  left_join(df.qual.exp %>% select(`Grant Number`, ID, Att) %>% unique(), by = c("Incumbent" = "Grant Number")) %>% 
  merge(2015:2019) %>% 
  left_join(uds.zip, by = c("Zip" = "Zip Code","Competitor" = "Grant Number", "y" = "Reporting Year")) %>% 
  #filter(y %in% c(2015:2019)) %>% 
  mutate(year.rel = y- Att, 
         Tx = ifelse(year.rel >= 0 , 1, 0)) %>% 
  mutate(None.z = ifelse(is.na(`None_Uninsured Patients`), 0, `None_Uninsured Patients`),
          MCR.z = ifelse(is.na(`Medicare Patients`), 0, `Medicare Patients`),
          COM.z = ifelse(is.na(`Private Patients`), 0, `Private Patients`),
          MCD.z = ifelse(is.na(`Medicaid_CHIP_Other Public Patients`), 0, `Medicaid_CHIP_Other Public Patients`),
          Total.z = ifelse(is.na(`Total Number of Patients`), 0, `Total Number of Patients`),
         Grant = Competitor) %>% 
  rename(Year = y) %>% 
  select(Grant, Zip, ID, Att, Year, None.z:Total.z) %>% 
  arrange(Grant, Zip, Year) %>% 
  rbind(df.spill %>% 
  filter(Att == 0) %>% 
  rename(Grant = `Grant Number`) %>% 
  select(Grant, Zip, ID, Att, Year, None.z, MCR.z, COM.z, MCD.z, Total.z) %>% 
    inner_join(df.spill2 %>% filter(Dist == 0) %>% select(`Grant Number`) %>% unique(), by = c("Grant" = "Grant Number"))) %>% 
  mutate(Tx = ifelse(Att > 0 & Year >= Att, 1, 0))


feols(data = df.space1, Total.z ~ Tx | Zip + Year, cluster = ~Zip)

cs.output.expand <- att_gt( yname = "Total.z",
                      tname = "Year",
                      idname = "ID",
                      gname = "Att",
                      xformla = ~1,
                      data = df.space1, # %>% filter(Year > 2015),
                      control_group = "nevertreated",
                      clustervars = "ID",
                      panel = TRUE,
                      base_period = "universal"
                      )
aggte(cs.output.expand, type = "dynamic", na.rm = TRUE)
```


## Change in Full Market Benefit - CAreful this is not great
```{r}


df.z.dist.plot %>% 
  left_join(uds.zip %>% select(`Grant Number`, `Reporting Year`, `Zip Code`, `Medicaid_CHIP_Other Public Patients`, `Total Number of Patients`), 
            by = c("Grant Number.y" = "Grant Number", "Zip" = "Zip Code")) %>% 
  left_join(uds.zip %>% select(`Grant Number`, `Reporting Year`, `Zip Code`, `Medicaid_CHIP_Other Public Patients`, `Total Number of Patients`), 
            by = c("Grant Number.x" = "Grant Number", "Zip" = "Zip Code", "Reporting Year")) %>% 
  rename(MCD.Rival = `Medicaid_CHIP_Other Public Patients.y`, 
         Total.Rival = `Total Number of Patients.y`, 
         MCD.Incumbent = `Medicaid_CHIP_Other Public Patients.x`, 
         Total.Incumbent = `Total Number of Patients.x`) %>% 
  left_join(uds.6b.rates %>% 
            mutate(Quality.Incumbent = (IMM2yo + Pap + ChildBMI + AdultBMI + Tobac + CRC + DepScrn) / 7) %>% 
            select(GrantNumber, Year, Quality.Incumbent), by = c("Grant Number.y" = "GrantNumber", "Reporting Year" = "Year")) %>% 
  left_join(uds.6b.rates %>% 
            mutate(Quality.Rival = (IMM2yo + Pap + ChildBMI + AdultBMI + Tobac + CRC + DepScrn) / 7) %>% 
            select(GrantNumber, Year, Quality.Rival), by = c("Grant Number.x" = "GrantNumber", "Reporting Year" = "Year")) %>% 
  mutate(YearDiff = `Reporting Year` - Year, 
         Post = ifelse(YearDiff >= 0, 1, 0)) %>% 
  filter(`Reporting Year` %in% c(2015:2019)) %>% 
  select(Zip, Att.z, `Grant Number.x`, `Grant Number.y`, `Reporting Year`:Post) %>% 
  mutate(Quality.Market = Total.Incumbent / (Total.Incumbent + Total.Rival) * Quality.Incumbent + Total.Rival / (Total.Incumbent + Total.Rival) * Quality.Rival) %>% 
  group_by(Post) %>% 
  summarise(mean(Quality.Market, na.rm = TRUE))


```

